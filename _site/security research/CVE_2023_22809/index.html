<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CVE-2023-22809: Sudoedit Bypass - Analysis - Zeyad Azima</title>
<meta name="description" content="A detailed analysis for CVE-2023-22809. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="CVE-2023-22809: Sudoedit Bypass - Analysis">
<meta property="og:url" content="http://localhost:5000/security%20research/CVE_2023_22809/">


  <meta property="og:description" content="A detailed analysis for CVE-2023-22809. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/cldfolqy51m8g0jp8837satgc.png">





  <meta property="article:published_time" content="2023-01-28T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/security%20research/CVE_2023_22809/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CVE-2023-22809: Sudoedit Bypass - Analysis">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-01-28T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">CVE-2023-22809: Sudoedit Bypass - Analysis
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#testing-lab">Testing Lab</a></li>
  <li><a href="#what-is-sudo-">What is sudo ?</a></li>
  <li><a href="#how-sudo-works-">How sudo Works ?</a></li>
  <li><a href="#the-analysis">The Analysis</a></li>
  <li><a href="#exploitation">Exploitation</a></li>
  <li><a href="#mitigation">Mitigation</a></li>
  <li><a href="#patch-diffing">Patch Diffing</a>
    <ul>
      <li><a href="#editorc">editor.c</a></li>
      <li><a href="#sudoersc">sudoers.c</a></li>
      <li><a href="#visudoc">visudo.c</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><strong>Introduction</strong></h1>

<p>A vulnerability was discovered by <code class="language-plaintext highlighter-rouge">Synacktive</code> in the sudo program and was published on <code class="language-plaintext highlighter-rouge">January 18</code>, <code class="language-plaintext highlighter-rouge">2023</code>, known as <code class="language-plaintext highlighter-rouge">CVE-2023-22809</code>. This vulnerability leads to a security bypass in the <code class="language-plaintext highlighter-rouge">sudoedit</code> feature, allowing unauthorized users to escalate their privileges by editing files. This vulnerability affects versions of sudo from <code class="language-plaintext highlighter-rouge">1.8.0</code> through <code class="language-plaintext highlighter-rouge">1.9.12p1</code>.</p>

<p> </p>

<h1 id="testing-lab"><strong>Testing Lab</strong></h1>

<p>For the testing lab, I will be using my normal <code class="language-plaintext highlighter-rouge">Kali</code> machine with an affected version of <code class="language-plaintext highlighter-rouge">Sudo</code>. The details are as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(kali㉿kali)-[~]
└─$ sudo --version
Sudo version 1.9.10
Sudoers policy plugin version 1.9.10
Sudoers file grammar version 48
Sudoers I/O plugin version 1.9.10
Sudoers audit plugin version 1.9.10
</code></pre></div></div>

<p> </p>

<h1 id="what-is-sudo-"><strong>What is sudo ?</strong></h1>

<p><code class="language-plaintext highlighter-rouge">Sudo</code> is a short for <code class="language-plaintext highlighter-rouge">Superuser do</code>, and it is a program used by Linux that allows a user with the proper permissions to execute commands on the actions or behavior of another user, typically <code class="language-plaintext highlighter-rouge">root</code>. Therefore, it can be used to give users permission to run a specific program or command without giving them high-level permissions, such as <code class="language-plaintext highlighter-rouge">root</code>.</p>

<p> </p>

<h1 id="how-sudo-works-"><strong>How sudo Works ?</strong></h1>

<p>When a user tries to execute the <code class="language-plaintext highlighter-rouge">sudo</code> command, It first checks and verifies the user’s permissions at <code class="language-plaintext highlighter-rouge">/etc/sudoers</code>, which is the configuration file that contains a list of users and their corresponding permissions. This is used to determine which users are authorized to run specific commands as certain users, depending on the configurations. If the user is authorized to run the command using <code class="language-plaintext highlighter-rouge">sudo</code>, they will be asked to enter their password to confirm their identity before the command is executed with elevated privileges. Another way is if the user is listed in the <code class="language-plaintext highlighter-rouge">sudoers</code> file with the <code class="language-plaintext highlighter-rouge">NOPASSWD</code> option. This allows the user to run either one command or all commands as root without confirming a password.</p>

<p> </p>

<h1 id="the-analysis"><strong>The Analysis</strong></h1>

<p>As we explained briefly how <code class="language-plaintext highlighter-rouge">sudo</code> works, let’s take an in-depth look at what happens when it is run. According to <code class="language-plaintext highlighter-rouge">synacktive</code>, the sudoers plugin first calls the <code class="language-plaintext highlighter-rouge">sudoers_policy_main()</code> function, which is responsible for handling the lookup and validation of the policy using the <code class="language-plaintext highlighter-rouge">sudoers_lookup()</code> function. Now, let’s take a look at the <code class="language-plaintext highlighter-rouge">sudoers_policy_main()</code> function.</p>

<p> </p>

<p>Note: <code class="language-plaintext highlighter-rouge">The function is over 500 lines of code, therefore we will give an overview of it.</code></p>

<p> </p>

<p>This function starts by taking the following arguments:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int sudoers_policy_main(int argc, char * const argv[], int pwflag, char *env_add[],
    bool verbose, void *closure)
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">argc</code>: Number of command-line arguments passed to the function.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">argv</code>: Array of command-line arguments passed to the function.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">pwflag</code>: Indicating whether the user’s password has been verified or no or the type of authentication.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">env_add</code>: Array of environment variables to add to the user’s environment when running the command.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">verbose</code>: Indicating whether verbose output should be generated.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">closure</code>: A pointer to any additional data passed to the plugin.</p>

    <p> </p>
  </li>
</ul>

<p>After taking all of these arguments The function first checks the user’s permissions by referring to the sudoers file, which contains a list of users and their respective permissions. If the user does not have permission to run the command, the function exits and sends an error message to the user. On the other hand, if the user is permitted to run the command, the function continues to execute it as the relevant user or group, using the setuid and setgid bit to temporarily acquire the user’s privileges. By reviewing the lines of the function, we can see the following line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>validated = sudoers_lookup(snl, sudo_user.pw, &amp;cmnd_status, pwflag);
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">sudoers_lookup()</code> is where the lookup happens to check the user’s permissions by taking the following arguments:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">snl</code>: Object that holds information about the sudoers file sources.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">sudo_user.pw</code>: User’s password from the struct <code class="language-plaintext highlighter-rouge">sudo_user</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&amp;cmnd_status</code>: Pointer to a variable that can be used to store information about the command or the authorization status.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">pwflag</code>: Indicating whether the user’s password has been verified or no or the type of authentication.</p>

    <p> </p>
  </li>
</ul>

<p>Then, the function will compare the user and the command they want to run with the defined rules in the sudoers file to check if the user is authorized and has the permissions to run the command or not. Inside the <code class="language-plaintext highlighter-rouge">plugins/sudoers/parse.c</code> file, we can see the <code class="language-plaintext highlighter-rouge">sudoers_lookup()</code> function code where all of that happens:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int sudoers_lookup(struct sudo_nss_list *snl, struct passwd *pw, int *cmnd_status,
    int pwflag)
{
    struct defaults_list *defs = NULL;
    struct sudoers_parse_tree *parse_tree = NULL;
    struct cmndspec *cs = NULL;
    struct sudo_nss *nss;
    struct cmnd_info info;
    int validated = FLAG_NO_USER | FLAG_NO_HOST;
    int m, match = UNSPEC;
    time_t now;
    debug_decl(sudoers_lookup, SUDOERS_DEBUG_PARSER);

    /*
     * Special case checking the "validate", "list" and "kill" pseudo-commands.
     */
    if (pwflag)
    debug_return_int(sudoers_lookup_pseudo(snl, pw, validated, pwflag));

    /* Need to be runas user while stat'ing things. */
    if (!set_perms(PERM_RUNAS))
    debug_return_int(validated);

    /* Query each sudoers source and check the user. */
    time(&amp;now);
    TAILQ_FOREACH(nss, snl, entries) {
    if (nss-&gt;query(nss, pw) == -1) {
        /* The query function should have printed an error message. */
        SET(validated, VALIDATE_ERROR);
        break;
    }

    m = sudoers_lookup_check(nss, pw, &amp;validated, &amp;info, &amp;cs, &amp;defs, now);
    if (m != UNSPEC) {
        match = m;
        parse_tree = nss-&gt;parse_tree;
    }

    if (!sudo_nss_can_continue(nss, m))
        break;
    }
    if (match != UNSPEC) {
    if (info.cmnd_path != NULL) {
        /* Update user_cmnd, user_stat, cmnd_status from matching entry. */
        free(user_cmnd);
        user_cmnd = info.cmnd_path;
        if (user_stat != NULL)
        *user_stat = info.cmnd_stat;
        *cmnd_status = info.status;
    }
    if (defs != NULL)
        (void)update_defaults(parse_tree, defs, SETDEF_GENERIC, false);
    if (!apply_cmndspec(cs))
        SET(validated, VALIDATE_ERROR);
    else if (match == ALLOW)
        SET(validated, VALIDATE_SUCCESS);
    else
        SET(validated, VALIDATE_FAILURE);
    }
    if (!restore_perms())
    SET(validated, VALIDATE_ERROR);
    debug_return_int(validated);
}
</code></pre></div></div>

<p> </p>

<p>So, what the function does behind the scenes is it checks for the special case of the <code class="language-plaintext highlighter-rouge">validate</code>, <code class="language-plaintext highlighter-rouge">list</code>, and <code class="language-plaintext highlighter-rouge">kill</code> pseudo-commands. Each one of them has a different usage, as follows:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">validate</code>: It’s used to check if a user has valid permissions to run a command. The function checks the sudoers file and verifies that the user is allowed to run the command.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">list</code>: It’s used to display a list of the privileges that a user has, Then the function use it to check the <code class="language-plaintext highlighter-rouge">sudoers</code> file and lists the commands that the user is allowed to run.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">kill</code>: It’s used to revoke privileges from a user, Then the function use it to check the <code class="language-plaintext highlighter-rouge">sudoers</code> file and revokes the privileges associated with the user.</p>

    <p> </p>
  </li>
</ul>

<p>And this part occurs within the <code class="language-plaintext highlighter-rouge">sudoers_lookup_pseudo()</code> function. At the end, when all checks have been done successfully, the user is cleared to proceed and can complete the command. Now, it is time to discuss <code class="language-plaintext highlighter-rouge">sudoedit</code>, which is a component of sudo and is primarily used for the same functionality as <code class="language-plaintext highlighter-rouge">sudo</code>. However, it is specifically used for securely editing files that require high levels of permissions, primarily those of the <code class="language-plaintext highlighter-rouge">root</code> user.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (ISSET(sudo_mode, MODE_EDIT))
</code></pre></div></div>

<p> </p>

<p>In the code above, which is a part of the <code class="language-plaintext highlighter-rouge">sudoers_policy_main()</code> function, the line checks if the <code class="language-plaintext highlighter-rouge">sudo_mode</code> is equal to <code class="language-plaintext highlighter-rouge">MODE_EDIT</code>. This indicates that the user wants to run an editor. The following line then:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>safe_cmnd = find_editor(NewArgc - 1, NewArgv + 1, &amp;edit_argc, &amp;edit_argv, NULL,
&amp;env_editor, false);
</code></pre></div></div>

<p> </p>

<p>It saves the value of the <code class="language-plaintext highlighter-rouge">find_editor()</code> function in <code class="language-plaintext highlighter-rouge">safe_cmnd</code> to use later. As you can guess from the function name, it searches for an editor (<code class="language-plaintext highlighter-rouge">by default, it's vi</code>). If we go through the following part of the function code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*env_editor = NULL;
    ev[0] = "SUDO_EDITOR";
    ev[1] = "VISUAL";
    ev[2] = "EDITOR";
    for (i = 0; i &lt; nitems(ev); i++) {
    char *editor = getenv(ev[i]);

    if (editor != NULL &amp;&amp; *editor != '\0') {
        *env_editor = editor;
        editor_path = resolve_editor(editor, strlen(editor),
        nfiles, files, argc_out, argv_out, allowlist);
        if (editor_path != NULL)
        break;
        if (errno != ENOENT)
        debug_return_str(NULL);
    }
    }
</code></pre></div></div>

<p> </p>

<p>The above code looks for the editor in the environment variables <code class="language-plaintext highlighter-rouge">SUDO_EDITOR</code>, <code class="language-plaintext highlighter-rouge">VISUAL</code>, and <code class="language-plaintext highlighter-rouge">EDITOR</code>. Then, for each variable found, it will pass it to the <code class="language-plaintext highlighter-rouge">resolve_editor()</code> function, along with the number of files, etc.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (nfiles != 0) {
nargv[nargc++] = "--";
while (nfiles--)
nargv[nargc++] = *files++;
}
</code></pre></div></div>

<p> </p>

<p>Anyway, When the <code class="language-plaintext highlighter-rouge">resolve_editor()</code> function resolves the editor’s path, it accepts extra arguments to be passed and separates them from the files in the original command-line using the <code class="language-plaintext highlighter-rouge">--</code> as a separator. After that, it calls the <code class="language-plaintext highlighter-rouge">sudo_edit()</code> function and each argument is considered a filename due to the <code class="language-plaintext highlighter-rouge">--</code> separator, as you can see in the following code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> /*
     * The user's editor must be separated from the files to be
     * edited by a "--" option.
     */
    for (ap = command_details-&gt;argv; *ap != NULL; ap++) {
    if (files)
        nfiles++;
    else if (strcmp(*ap, "--") == 0)
        files = ap + 1;
    else
        editor_argc++;
</code></pre></div></div>

<p> </p>

<h1 id="exploitation"><strong>Exploitation</strong></h1>

<p>Now, In order to exploit this vulnerability, I have logged in as the user <code class="language-plaintext highlighter-rouge">kali'</code> on the machine. Let’s add the following rule to the <code class="language-plaintext highlighter-rouge">/etc/sudoers</code> file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kali    ALL=(root) NOPASSWD: sudoedit /etc/services
</code></pre></div></div>

<p> </p>

<p>This rule will allow the user <code class="language-plaintext highlighter-rouge">kali</code> to edit the <code class="language-plaintext highlighter-rouge">/etc/services</code> file without being prompted for a password. Moving on to the next step, let’s add the <code class="language-plaintext highlighter-rouge">EDITOR</code> variable to our environment variables and assign it the value <code class="language-plaintext highlighter-rouge">vi -- /etc/shadow</code>:</p>

<p> </p>

<p><img src="/assets/images/b893f81e70bf8aed994df2a32c1973c6" alt="" /></p>

<p> </p>

<ul>
  <li>Add <code class="language-plaintext highlighter-rouge">Editor</code> variable:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export EDITOR="vi -- /etc/shadow"
</code></pre></div></div>

<p>Let’s run <code class="language-plaintext highlighter-rouge">sudo -l</code> and you will be able to see that our rule has been applied.</p>

<p><img src="/assets/images/8256a7e81250d0b4f45427afad142e2a" alt="" /></p>

<p> </p>

<p>By running <code class="language-plaintext highlighter-rouge">sudoedit /etc/services</code> it will execute <code class="language-plaintext highlighter-rouge">vi</code> on <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file also.</p>

<p> </p>

<p><img src="/assets/images/8f2df2705635f67473af0c3b6936bc28" alt="" /></p>

<p> </p>

<ul>
  <li>command-line output:</li>
</ul>

<p><img src="/assets/images/4adba66eee814e3518b153ed193bec0c" alt="" /></p>

<p> </p>

<p>So, As a Re-Cap what happened is:</p>

<p>1- User has permissions to edit <code class="language-plaintext highlighter-rouge">/etc/services</code></p>

<p>2- User defined a crafted editor environment-variable <code class="language-plaintext highlighter-rouge">vi -- /etc/shadow</code></p>

<p>3- When <code class="language-plaintext highlighter-rouge">sudo</code> executed and matched <code class="language-plaintext highlighter-rouge">MODE_EDIT</code> it will lookup for the editor in the 3 known environment-variables <code class="language-plaintext highlighter-rouge">SUDO_EDITOR</code>, <code class="language-plaintext highlighter-rouge">VISUAL</code>, and <code class="language-plaintext highlighter-rouge">EDITOR</code>.</p>

<p>4- As the <code class="language-plaintext highlighter-rouge">resolve_editor()</code> function resolves the editor’s path, It accepts extra arguments to be passed and separates them from the files in the original command-line using the <code class="language-plaintext highlighter-rouge">--</code> as a separator. After that, it calls the <code class="language-plaintext highlighter-rouge">sudo_edit()</code> function and each argument is considered a filename due to the <code class="language-plaintext highlighter-rouge">--</code> separator, Therefore, It will take the extra argument which is <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file to be edited.</p>

<p> </p>

<h1 id="mitigation"><strong>Mitigation</strong></h1>

<p>To prevent this vulnerability, we will add environment variables to the denial list using the <code class="language-plaintext highlighter-rouge">env_delete</code> in <code class="language-plaintext highlighter-rouge">/etc/sudoers</code> as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Defaults!SUDOEDIT       env_delete+="SUDO_EDITOR VISUAL EDITOR"
Cmnd_Alias SUDOEDIT = sudoedit /etc/services
kali    ALL=(root) NOPASSWD: SUDOEDIT
</code></pre></div></div>

<p> </p>

<p>Now, if we run <code class="language-plaintext highlighter-rouge">sudo -l</code> we can see the following and our new rule applied:</p>

<p><img src="/assets/images/ba4714c39988ef5b3be03cd6e499995d" alt="" /></p>

<p> </p>

<ul>
  <li>
    <p>Trying after mitigation:</p>

    <p> </p>

    <p><img src="/assets/images/e3d935573216623cfc68b171d48fab53" alt="" /></p>
  </li>
</ul>

<p> </p>

<p>And, Finally you can also update to the last version of <code class="language-plaintext highlighter-rouge">sudo</code>, Which is patched. Just by running <code class="language-plaintext highlighter-rouge">apt install sudo</code>.</p>

<p> </p>

<ul>
  <li>
    <p>Trying after update:</p>

    <p><img src="/assets/images/c5d006354318ea652e6c46f0933e728d" alt="" /></p>
  </li>
</ul>

<h1 id="patch-diffing"><strong>Patch Diffing</strong></h1>

<p>Now, Coming to the patch part, We can see here the commit made to the code on github https://github.com/sudo-project/sudo/commit/0274a4f3b403162a37a10f199c989f3727ed3ad4. There are 3 files got changed which are <code class="language-plaintext highlighter-rouge">editor.c</code>, <code class="language-plaintext highlighter-rouge">sudoers.c</code> and <code class="language-plaintext highlighter-rouge">visudo.c</code>. Let’s explain the changes in each file:</p>

<p> </p>

<h2 id="editorc"><strong>editor.c</strong></h2>

<h4 id="change-no1"><strong>change no.1</strong></h4>

<ul>
  <li>Before change</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        if (find_path(editor, &amp;editor_path, &amp;user_editor_sb, getenv("PATH"), NULL,
    0, allowlist) != FOUND) {
sudoers_gc_remove(GC_PTR, editor);
free(editor);
errno = ENOENT;
</code></pre></div></div>

<p> </p>

<p>The code is a condation if the <code class="language-plaintext highlighter-rouge">editor</code> not found it will call <code class="language-plaintext highlighter-rouge">sudoers_gc_remove()</code> function and then use the <code class="language-plaintext highlighter-rouge">free()</code> function to free up any memory associated with the <code class="language-plaintext highlighter-rouge">editor</code> variable. Finally, set <code class="language-plaintext highlighter-rouge">errno</code> to <code class="language-plaintext highlighter-rouge">ENOENT.</code></p>

<p> </p>

<ul>
  <li>After change</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (find_path(editor, &amp;editor_path, &amp;user_editor_sb, getenv("PATH"), NULL,
    0, allowlist) != FOUND) {
    goto bad;
    }
</code></pre></div></div>

<p> </p>

<p>You can see in the after change code it makes the code jump to <code class="language-plaintext highlighter-rouge">bad</code> which defined before in the code. As we can see from the commit that it doesn’t want the <code class="language-plaintext highlighter-rouge">errno</code> be equal to<code class="language-plaintext highlighter-rouge">ENOENT</code> which means <code class="language-plaintext highlighter-rouge">No such file or directory</code>.</p>

<p> </p>

<h4 id="change-no2"><strong>Change no.2</strong></h4>

<p>In this change the following code added:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (strcmp(nargv[nargc], "--") == 0) {
        sudo_warnx(U_("ignoring editor: %.*s"), (int)edlen, ed);   
        sudo_warnx("%s", U_("editor arguments may not contain \"--\""));
        errno = EINVAL;
        goto bad;
    }
</code></pre></div></div>

<p>Basically, the code checks for the <code class="language-plaintext highlighter-rouge">--</code> in the editor variables, If it’s exist it will not work (<code class="language-plaintext highlighter-rouge">And we can see it in the mitigation above</code>).</p>

<p> </p>

<h2 id="sudoersc"><strong>sudoers.c</strong></h2>

<h4 id="change"><strong>Change</strong></h4>

<ul>
  <li>Before change</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (errno != ENOENT)
audit_failure(NewArgv, N_("%s: command not found"),
        env_editor ? env_editor : def_editor);
        sudo_warnx(U_("%s: command not found"),
        env_editor ? env_editor : def_editor);
        goto bad;
</code></pre></div></div>

<p> </p>

<p>The statment here checks if the <code class="language-plaintext highlighter-rouge">error</code> is not euqal to <code class="language-plaintext highlighter-rouge">ENOENT</code>. Then it will call the <code class="language-plaintext highlighter-rouge">audit_failure()</code> function and then <code class="language-plaintext highlighter-rouge">sudo_warnx()</code> function to log the error and display a warning message. After that jump to <code class="language-plaintext highlighter-rouge">bad</code> which will handle the error.</p>

<p> </p>

<ul>
  <li>After change</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>switch (errno) {
        case ENOENT:
        audit_failure(NewArgv, N_("%s: command not found"),
            env_editor ? env_editor : def_editor);
        sudo_warnx(U_("%s: command not found"),
            env_editor ? env_editor : def_editor);
        goto bad;
        case EINVAL:
        if (def_env_editor &amp;&amp; env_editor != NULL) {
            /* User tried to do something funny with the editor. */
            log_warningx(SLOG_NO_STDERR|SLOG_AUDIT|SLOG_SEND_MAIL,
            "invalid user-specified editor: %s", env_editor);
            goto bad;
        }
        FALLTHROUGH;
        default:
        goto done;
</code></pre></div></div>

<p> </p>

<p>In this <code class="language-plaintext highlighter-rouge">switch</code> we have 2 cases:</p>

<ul>
  <li>
    <p>First: If <code class="language-plaintext highlighter-rouge">errno</code> is set to <code class="language-plaintext highlighter-rouge">ENOENT</code> it will call the <code class="language-plaintext highlighter-rouge">audit_failure()</code> function and then <code class="language-plaintext highlighter-rouge">sudo_warnx()</code> function to log the error and display a warning message.</p>
  </li>
  <li>
    <p>Second: If <code class="language-plaintext highlighter-rouge">errno</code> is set to <code class="language-plaintext highlighter-rouge">EINVAL</code> and the user has attempted to do something with the editor, Then it will call the <code class="language-plaintext highlighter-rouge">audit_failure()</code> function and then <code class="language-plaintext highlighter-rouge">sudo_warnx()</code> function to log the error and display a warning message.<br />
  Finally, If there is no case of the 2 cases occures it will jump to <code class="language-plaintext highlighter-rouge">done</code>, Which defined before in the code and indicating to success of the process.</p>
  </li>
</ul>

<p> </p>

<h2 id="visudoc"><strong>visudo.c</strong></h2>

<h4 id="change-1"><strong>Change</strong></h4>

<ul>
  <li>Before Change</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (editor_path == NULL) {
    if (def_env_editor &amp;&amp; env_editor != NULL) {
        sudo_fatalx(U_("specified editor (%s) doesn't exist"), env_editor);
</code></pre></div></div>

<ul>
  <li>After change</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (errno == ENOENT) {
        sudo_warnx(U_("specified editor (%s) doesn't exist"),
            env_editor);
        }
        exit(EXIT_FAILURE);
</code></pre></div></div>

<p>Here we can see that the old code replaced with more secure error handling way for <code class="language-plaintext highlighter-rouge">$EDITOR</code> and exit safely.</p>

<p> </p>

<h1 id="conclusion"><strong>Conclusion</strong></h1>

<p>My final words are to do your upgrade better cause as there is a vulnerable version it’s possiable to bypass the rules in the sudoers file. Therefore, keep all of your softwares updated. And also add the above suders rules also to your <code class="language-plaintext highlighter-rouge">/etc/sudoers</code> file as another layer of security. In summary, the root cause is the presence of the <code class="language-plaintext highlighter-rouge">--</code> argument to determine the list of files to edit can be included in environment variables without any validation.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#security-research" class="page__taxonomy-item" rel="tag">Security Research</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-01-28T00:00:00+08:00">January 28, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/defense%20evasion/portspoofexploit/" class="pagination--pager" title="Exploit Writing (N0Pspoof): Portspoof Evasion
">Previous</a>
    
    
      <a href="/certificates/empat/" class="pagination--pager" title="eMAPT &amp; Mobile Apps/Sec Guide
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
