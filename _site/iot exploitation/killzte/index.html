<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Research: Kill the Router with one request - Zeyad Azima</title>
<meta name="description" content="Explaining an unknown vulnerability in ZXHN H168N V3.5 to kill the device with one request. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="Research: Kill the Router with one request">
<meta property="og:url" content="http://localhost:5000/iot%20exploitation/killzte/">


  <meta property="og:description" content="Explaining an unknown vulnerability in ZXHN H168N V3.5 to kill the device with one request. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/clchacuknea7q0jp80bhnbgn2.jpg">





  <meta property="article:published_time" content="2023-01-05T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/iot%20exploitation/killzte/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Research: Kill the Router with one request">
    <meta itemprop="description" content="IntroductionI discoverd a bug while playing around with the ZXHN H168N V3.5 home router device which result in killing the router and make it go down with one request. So, If you want to get the device alive again, You have to restart it or wait for hours. Let’s go and explain it.">
    <meta itemprop="datePublished" content="2023-01-05T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Research: Kill the Router with one request
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#spotting-the-bug">Spotting the Bug</a></li>
  <li><a href="#under-the-hood">Under The Hood</a>
    <ul>
      <li><a href="#lua-bytecode">Lua ByteCode</a></li>
    </ul>
  </li>
  <li><a href="#final-thoughts">Final Thoughts</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction">Introduction</h1>
<p>I discoverd a bug while playing around with the <code class="language-plaintext highlighter-rouge">ZXHN H168N V3.5</code> home router device which result in killing the router and make it go down with one request. So, If you want to get the device alive again, You have to restart it or wait for hours. Let’s go and explain it.</p>

<h1 id="spotting-the-bug">Spotting the Bug</h1>
<p>I was doing the test as a blackbox without looking into hte firmware (<code class="language-plaintext highlighter-rouge">We will look at the firmware later</code>). First go to your device dashboard and login. Then, go to <code class="language-plaintext highlighter-rouge">Local network</code> tab. After that move to <code class="language-plaintext highlighter-rouge">WLAN</code>. Finally for sure don’t forget your <code class="language-plaintext highlighter-rouge">Burp Suite</code> tool, Since we doing the test on the web <code class="language-plaintext highlighter-rouge">Application</code> interface level. So, we be able to intercept the requests and play around with it. As the following step showed in the bellow picture: open any of the <code class="language-plaintext highlighter-rouge">WLAN</code> SSID and click on save.</p>

<p><img src="/assets/images/3c04b6e1b05e9db32a6381a19c06c183.png" alt="3c04b6e1b05e9db32a6381a19c06c183.png" /></p>

<p>But, before this open burp suite to intercept the request.</p>

<p><img src="/assets/images/87f9cb54e6b0328341bc58b83c71083d.png" alt="87f9cb54e6b0328341bc58b83c71083d.png" /></p>

<p>Now, i will send the request to the repeater to explain the vulnerability, by press right click and choose send to repeater :</p>

<p><img src="/assets/images/08795c8226f8c88fbf20ea485f53f82a.png" alt="08795c8226f8c88fbf20ea485f53f82a.png" /></p>

<p>Let’s go to the repeater tab and play with the request, You will see the request then click go:</p>

<p><img src="/assets/images/ae7681e55df866022f9c39684b9f2ba1.png" alt="ae7681e55df866022f9c39684b9f2ba1.png" /></p>

<p>So, Let’s explain what actual happened and what the request doing and what is the response for it. The request is about modifying the <code class="language-plaintext highlighter-rouge">WLAN</code> settings and You can see in the response tab, In the body you can see the <code class="language-plaintext highlighter-rouge">XML</code> response from server and has many objects, as example the <code class="language-plaintext highlighter-rouge">&lt;INSTIDENTITY&gt;</code> you will see that this object has a value “DEV.WIFI.AP1.PSK1”, it looks like a value refering to <code class="language-plaintext highlighter-rouge">WIFI Access point 1</code>, Casue as you saw before we had 2 Access points in the router.</p>

<p>Now, we have <code class="language-plaintext highlighter-rouge">XML</code> response in this web application, We will try <code class="language-plaintext highlighter-rouge">XXE</code> (iNJECTING SOME <code class="language-plaintext highlighter-rouge">xml</code> body to check for it). I even take the response and send it back as a request.</p>

<p>When, I did that it’s actually back to me with more information about the <code class="language-plaintext highlighter-rouge">Parameters</code> and each <code class="language-plaintext highlighter-rouge">value</code> for each <code class="language-plaintext highlighter-rouge">Paramenter</code> as you can see in the below screenshot.</p>

<p><img src="/assets/images/66a084657c8674b24e1eb0aae7e929f6.png" alt="66a084657c8674b24e1eb0aae7e929f6.png" /></p>

<p>I tried other payloads related to <code class="language-plaintext highlighter-rouge">XXE</code> ,. But, non of payloads worked. So, This bug is limited. Now, this bug is authenticated, When we are not authenticated it will not show any information. But, it will parse our request without any problems.</p>

<h1 id="under-the-hood">Under The Hood</h1>
<p>Now, We will take a static look at the backend code to understand more. So, what we need now is the <code class="language-plaintext highlighter-rouge">Firmware</code> for the device and we have many ways to do it:</p>

<ul>
  <li>You can search for the firmware on the official website for the vendor.</li>
  <li>Download it from any other source (<code class="language-plaintext highlighter-rouge">after someone already dump it from the device and published it</code>).</li>
  <li>Dump the firmware through URAT, You could read a detailed blog from <a href="https://www.cyberark.com/resources/threat-research-blog/accessing-and-dumping-firmware-through-uart">Here</a>.</li>
  <li>Finally dumping the firmware using <code class="language-plaintext highlighter-rouge">CH341A</code> Mini programmer USB, You could read a detailed blog from <a href="https://www.blackhillsinfosec.com/dumping-firmware-with-the-ch341a-programmer/">Here</a>.</li>
</ul>

<p>In my case, I found that someone dump it before, Therefor, i download it. Now, Let’s extract the firmware using <code class="language-plaintext highlighter-rouge">Binwalk</code> tool and discover the firmware files. Specially the vulnerable end-point file.</p>

<ul>
  <li>Extracting the firmware: <code class="language-plaintext highlighter-rouge">binwalk -e firmware</code>. The <code class="language-plaintext highlighter-rouge">-e</code> is for extracting.</li>
</ul>

<p><img src="/assets/images/78865c8856f609e7460ac352774c1489.png" alt="78865c8856f609e7460ac352774c1489.png" /></p>

<p>In the above screenshot it’s done successfully and we extracted the firmware as we can see in the following picature, we moved to the firmware extracted directory:</p>

<p><img src="/assets/images/44e9e045b9e92d1bbcc6b567268da615.png" alt="44e9e045b9e92d1bbcc6b567268da615.png" /></p>

<p>Now, if we go to the <code class="language-plaintext highlighter-rouge">/squashfs-root</code> directory, We can see the directory to all the <code class="language-plaintext highlighter-rouge">Linux</code> system directories which the firmware <code class="language-plaintext highlighter-rouge">router system</code> built-on. Under the <code class="language-plaintext highlighter-rouge">/home</code> directory we will find the <code class="language-plaintext highlighter-rouge">/httpd</code> directory which home directory for the <code class="language-plaintext highlighter-rouge">web service</code> user that hosting the web-interface for the router. (<code class="language-plaintext highlighter-rouge">You can see on the following picature</code>)</p>

<p><img src="/assets/images/10ad50bd5bf05eb2a2d9c4d91f5ed74b.png" alt="10ad50bd5bf05eb2a2d9c4d91f5ed74b.png" /></p>

<p>Now, backing to the <code class="language-plaintext highlighter-rouge">URL</code> of the end-point we were testing, <code class="language-plaintext highlighter-rouge">/common_page/Localnet_WlanBasicAd_WLANSSIDConf_EncryOption_lua.lua</code>. It’s clearly the interface written in <code class="language-plaintext highlighter-rouge">Lua</code> programming language. Let’s move on to our vulnerable page under <code class="language-plaintext highlighter-rouge">/common_page</code> directory. If we list the files in the directory and grep the first words from the page name we can see the following:</p>

<p><img src="/assets/images/b30e069bf0cf0840e42006ac034fefc4.png" alt="b30e069bf0cf0840e42006ac034fefc4.png" /></p>

<p>We can see that the page full name is not here (<code class="language-plaintext highlighter-rouge">It may be a one old step realse from the actual one we do have</code>). So, I will pick up the <code class="language-plaintext highlighter-rouge">Localnet_WlanBasicAd_WLANSSIDConf_lua.lua</code> which is the closer one to our page and if we checked the file using <code class="language-plaintext highlighter-rouge">file</code> command, We will be able to see that it’s a <code class="language-plaintext highlighter-rouge">Lua, ByteCode, Version 5.1</code>:</p>

<p><img src="/assets/images/6fe68045bc360a9fff5e84a20955150d.png" alt="6fe68045bc360a9fff5e84a20955150d.png" /></p>

<p>If we tried to read the file using <code class="language-plaintext highlighter-rouge">cat</code> command, the output will be non-understandable representation:</p>

<p><img src="/assets/images/1603808fcdeb7b7147e208b94db94127.png" alt="1603808fcdeb7b7147e208b94db94127.png" /></p>

<h2 id="lua-bytecode">Lua ByteCode</h2>
<p>As we saw before the file is Lua ByteCode. After a couple hours of search, I was able to find this <a href="https://lua-bytecode.github.io/">website</a> to decompile <code class="language-plaintext highlighter-rouge">Lua ByteCode</code>. Therefor, we will be able to analysis and understand what happen in the background.</p>

<p><img src="/assets/images/904103d6576d3b81cbfadbf1613ff69d.png" alt="904103d6576d3b81cbfadbf1613ff69d.png" /></p>

<p>We can see that we have a lot of code here and if we scroll down you gonna see some instructions looks like <code class="language-plaintext highlighter-rouge">Assembly</code>, After searching for the <code class="language-plaintext highlighter-rouge">Lua Bytecode</code>. I found the follwoing <a href="https://the-ravi-programming-language.readthedocs.io/en/latest/lua_bytecode_reference.html#instruction-summary">reference</a> with the instructions and description for each instruction:</p>

<p><img src="/assets/images/507c511477c04c9c90c1d451167b5e4d.png" alt="507c511477c04c9c90c1d451167b5e4d.png" /></p>

<p>So, Now we can start to read and understand. If we take a look at the first few lines it’s giving us information about the language version, etc. But, the starting part where we can see the main function and it’s information:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>************ Main Function
Source: @/home/xialei/Builds/H168NV31_Develop_BaseCSP3005P01/chip_mtk7510/product/H168NV31_BELT/scripts/../basefilesystem/luapages/html//common_page/Localnet_WlanBasicAd_WLANSSIDConf_lua.lua
Parameters: 0
Is vararg: yes
Local variable 'arg': absent
VM registers needed: 36
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Source</code>: The source code file directory (<code class="language-plaintext highlighter-rouge">Which also seems from the firmware team developers under /home</code>).</li>
  <li><code class="language-plaintext highlighter-rouge">Parameters</code>: Number of functions parameters.</li>
  <li><code class="language-plaintext highlighter-rouge">Is Vrarg</code>: Meaning it can accept a variable number of arguments.</li>
  <li><code class="language-plaintext highlighter-rouge">Local variable 'arg': absent</code>:is a special variable in Lua that refers to a list of arguments passed to a function.</li>
  <li><code class="language-plaintext highlighter-rouge">VM registers needed: 36</code>: Requirted VM Registers to execute.]</li>
</ul>

<p>Under the main functions we can find 2 things <code class="language-plaintext highlighter-rouge">Constants</code> which are variables and can not be changed, Also <code class="language-plaintext highlighter-rouge">Locals</code> which are defined local variables.</p>

<ul>
  <li>Constants
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Constants: 61
+0658:Size=7: 72 65 71 75 69 72 65            Const#1   string    "require"
+0665:Size=E: 6C 69 62 2F 63 6F 6D 6D 6F...   Const#2   string    "lib/common_lua"
+0679:Size=0:                                 Const#3   string    ""
+067F:Size=A: 49 46 5F 45 52 52 4F 52 49 44   Const#4   string    "IF_ERRORID"
+068B:Size=8: 00 00 00 00 00 00 00 00         Const#5   float     0.0
+0694:Size=8: 3F F0 00 00 00 00 00 00         Const#6   float     1.0
+06A1:Size=6: 63 67 69 6C 75 61               Const#7   string    "cgilua"
+06AD:Size=B: 72 65 6D 6F 74 65 5F 61 64...   Const#8   string    "remote_addr"
+06BE:Size=B: 73 65 73 73 69 6F 6E 5F 67...   Const#9   string    "session_get"
+06CF:Size=5: 52 69 67 68 74                  Const#10  string    "Right"
+06DA:Size=11: 4F 42 4A 5F 57 4C 41 4E 4...   Const#11  string    "OBJ_WLANCONFIG_ID"
+06F1:Size=1: 33                              Const#12  string    "3"
+06F8:Size=5: 45 53 53 49 44                  Const#13  string    "ESSID"
+0703:Size=A: 42 65 61 63 6F 6E 54 79 70 65   Const#14  string    "BeaconType"
+0713:Size=B: 57 45 50 41 75 74 68 4D 6F...   Const#15  string    "WEPAuthMode"
+0724:Size=B: 57 45 50 4B 65 79 49 6E 64...   Const#16  string    "WEPKeyIndex"
+0735:Size=B: 57 50 41 41 75 74 68 4D 6F...   Const#17  string    "WPAAuthMode"
+0746:Size=E: 57 50 41 45 6E 63 72 79 70...   Const#18  string    "WPAEncryptType"
+075A:Size=B: 31 31 69 41 75 74 68 4D 6F...   Const#19  string    "11iAuthMode"
+076B:Size=E: 31 31 69 45 6E 63 72 79 70...   Const#20  string    "11iEncryptType"
+077F:Size=6: 45 6E 61 62 6C 65               Const#21  string    "Enable"
+078B:Size=D: 57 50 41 47 72 6F 75 70 52...   Const#22  string    "WPAGroupRekey"
+079E:Size=F: 45 53 53 49 44 48 69 64 65...   Const#23  string    "ESSIDHideEnable"
+07B3:Size=12: 56 61 70 49 73 6F 6C 61 7...   Const#24  string    "VapIsolationEnable"
+07CB:Size=8: 50 72 69 6F 72 69 74 79         Const#25  string    "Priority"
+07D9:Size=A: 4D 61 78 55 73 65 72 4E 75 6D   Const#26  string    "MaxUserNum"
+07E9:Size=11: 4F 42 4A 5F 57 4C 41 4E 5...   Const#27  string    "OBJ_WLANWEPKEY_ID"
+0800:Size=6: 57 45 50 4B 65 79               Const#28  string    "WEPKey"
+080C:Size=E: 4F 42 4A 5F 57 4C 41 4E 50...   Const#29  string    "OBJ_WLANPSK_ID"
+0820:Size=D: 4B 65 79 50 61 73 73 70 68...   Const#30  string    "KeyPassphrase"
+0833:Size=19: 51 75 65 72 79 57 43 61 7...   Const#31  string    "QueryWCardAndSSIDIdentity"
+0852:Size=4: 50 4F 53 54                     Const#32  string    "POST"
+085C:Size=9: 49 46 5F 41 43 54 49 4F 4E      Const#33  string    "IF_ACTION"
+086B:Size=9: 5F 57 45 50 43 4F 4E 49 47      Const#34  string    "_WEPCONIG"
+087A:Size=9: 5F 50 53 4B 43 4F 4E 49 47      Const#35  string    "_PSKCONIG"
+0889:Size=7: 5F 49 6E 73 74 49 44            Const#36  string    "_InstID"
+0896:Size=C: 5F 49 6E 73 74 49 44 5F 57...   Const#37  string    "_InstID_WEP0"
+08A8:Size=C: 5F 49 6E 73 74 49 44 5F 57...   Const#38  string    "_InstID_WEP1"
+08BA:Size=C: 5F 49 6E 73 74 49 44 5F 57...   Const#39  string    "_InstID_WEP2"
+08CC:Size=C: 5F 49 6E 73 74 49 44 5F 57...   Const#40  string    "_InstID_WEP3"
+08DE:Size=B: 5F 49 6E 73 74 49 44 5F 50...   Const#41  string    "_InstID_PSK"
+08EF:Size=E: 74 72 61 6E 73 54 6F 50 6F...   Const#42  string    "transToPostTab"
+0903:Size=10: 74 72 61 6E 73 54 6F 46 6...   Const#43  string    "transToFilterTab"
+0919:Size=5: 41 70 70 6C 79                  Const#44  string    "Apply"
+0924:Size=1: 59                              Const#45  string    "Y"
+0927:Size=0:                                 Const#46  nil       nil
+092C:Size=13: 61 70 70 6C 79 4F 72 4E 6...   Const#47  string    "applyOrNewOrDelInst"
+0945:Size=8: 57 45 50 4B 65 79 30 30         Const#48  string    "WEPKey00"
+0953:Size=8: 57 45 50 4B 65 79 30 31         Const#49  string    "WEPKey01"
+0961:Size=8: 57 45 50 4B 65 79 30 32         Const#50  string    "WEPKey02"
+096F:Size=8: 57 45 50 4B 65 79 30 33         Const#51  string    "WEPKey03"
+097D:Size=6: 43 61 6E 63 65 6C               Const#52  string    "Cancel"
+0989:Size=12: 67 65 74 53 70 65 63 69 6...   Const#53  string    "getSpecificInstXML"
+09A1:Size=5: 74 61 62 6C 65                  Const#54  string    "table"
+09AC:Size=6: 69 6E 73 65 72 74               Const#55  string    "insert"
+09B8:Size=F: 53 53 49 44 46 69 6C 74 65...   Const#56  string    "SSIDFilterByNIC"
+09CD:Size=D: 67 65 74 41 6C 6C 49 6E 73...   Const#57  string    "getAllInstXML"
+09E0:Size=3: 49 47 44                        Const#58  string    "IGD"
+09E9:Size=6: 63 6F 6E 63 61 74               Const#59  string    "concat"
+09F5:Size=E: 6F 75 74 70 75 74 45 72 72...   Const#60  string    "outputErrorXML"
+0A09:Size=9: 6F 75 74 70 75 74 58 4D 4C      Const#61  string    "outputXML"
</code></pre></div>    </div>
  </li>
</ul>

<p>As you can see we have 3 fields:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Const#&lt;number&gt;</code>: the Constant variable number.</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;Type&gt;</code>: The variable data type (e.x:<code class="language-plaintext highlighter-rouge">Float,stringm etc</code>).</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;Name&gt;</code>: The variable name.</li>
</ul>

<p>Now, to the <code class="language-plaintext highlighter-rouge">Locals</code> variables:</p>
<ul>
  <li>Locals
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Locals: 29
Local#1   R0   def:&lt;4&gt;    scope:&lt;5..349&gt;      name: InstXML
Local#2   R1   def:&lt;5&gt;    scope:&lt;6..349&gt;      name: ErrorXML
Local#3   R2   def:&lt;6&gt;    scope:&lt;7..349&gt;      name: OutXML
Local#4   R3   def:&lt;7&gt;    scope:&lt;9..349&gt;      name: tError
Local#5   R4   def:&lt;9&gt;    scope:&lt;10..349&gt;     name: need2Get
Local#6   R5   def:&lt;10&gt;   scope:&lt;11..349&gt;     name: xmlStr
Local#7   R6   def:&lt;12&gt;   scope:&lt;13..349&gt;     name: sess_id
Local#8   R7   def:&lt;16&gt;   scope:&lt;17..349&gt;     name: uRight
Local#9   R8   def:&lt;17&gt;   scope:&lt;18..349&gt;     name: PARA
Local#10  R9   def:&lt;18&gt;   scope:&lt;19..349&gt;     name: FP_OBJNAME
Local#11  R10  def:&lt;50&gt;   scope:&lt;51..349&gt;     name: WEP_OBJNAME
Local#12  R11  def:&lt;51&gt;   scope:&lt;54..349&gt;     name: WEP_PARA
Local#13  R12  def:&lt;54&gt;   scope:&lt;55..349&gt;     name: PSK_OBJNAME
Local#14  R13  def:&lt;55&gt;   scope:&lt;58..349&gt;     name: PSK_PARA
Local#15  R14  def:&lt;58&gt;   scope:&lt;59..349&gt;     name: WLANNICNum
Local#16  R15  def:&lt;59&gt;   scope:&lt;60..349&gt;     name: WNICIdentity
Local#17  R16  def:&lt;60&gt;   scope:&lt;61..349&gt;     name: WLANBasicIDTable
Local#18  R17  def:&lt;68&gt;   scope:&lt;69..349&gt;     name: FP_ACTION
Local#19  R18  def:&lt;71&gt;   scope:&lt;72..349&gt;     name: _WEPCONIG
Local#20  R19  def:&lt;74&gt;   scope:&lt;75..349&gt;     name: _PSKCONIG
Local#21  R20  def:&lt;77&gt;   scope:&lt;78..349&gt;     name: FP_IDENTITY
Local#22  R21  def:&lt;80&gt;   scope:&lt;81..349&gt;     name: WEP_IDENTITY0
Local#23  R22  def:&lt;83&gt;   scope:&lt;84..349&gt;     name: WEP_IDENTITY1
Local#24  R23  def:&lt;86&gt;   scope:&lt;87..349&gt;     name: WEP_IDENTITY2
Local#25  R24  def:&lt;89&gt;   scope:&lt;90..349&gt;     name: WEP_IDENTITY3
Local#26  R25  def:&lt;92&gt;   scope:&lt;93..349&gt;     name: PSK_IDENTITY
Local#27  R26  def:&lt;93&gt;   scope:&lt;94..349&gt;     name: xmlTable
Local#28  R27  def:&lt;96&gt;   scope:&lt;97..349&gt;     name: WEP_PARA_POST
Local#29  R28  def:&lt;99&gt;   scope:&lt;100..349&gt;    name: WEP_PARA_FILTER
</code></pre></div>    </div>
  </li>
</ul>

<p>Here we can see that there are 5 fields:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Local#&lt;number&gt;</code>: The Local variable number.</li>
  <li><code class="language-plaintext highlighter-rouge">R&lt;number&gt;</code>: The register that the variable assigned to.</li>
  <li><code class="language-plaintext highlighter-rouge">def:&lt;number&gt;</code>: Line that the variable defined on, In the code.</li>
  <li><code class="language-plaintext highlighter-rouge">scope:&lt;ramge&gt;</code>: indicates that the variable is in scope (can be accessed and modified) from a range of lines in the code.</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;Name&gt;</code>: Finally the variable name.</li>
</ul>

<p>If we take a look at the <code class="language-plaintext highlighter-rouge">Constants</code> &amp; <code class="language-plaintext highlighter-rouge">Local</code> variable names including the same parameters in our request.:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IF_ACTION | Const#33  string    "IF_ACTION"
Enable | Const#21  string    "Enable"
_InstID | Const#36  string    "_InstID"
_PSKCONIG | Local#20  R19  def:&lt;74&gt;   scope:&lt;75..349&gt;     name: _PSKCONIG
BeaconType | Const#14  string    "BeaconType"
WPAAuthMode | Const#17  string    "WPAAuthMode"
11iAuthMode | Const#19  string    "11iAuthMode"
WPAEncryptType | Const#18  string    "WPAEncryptType"
11iEncryptType | Const#20  string    "11iEncryptType"
_InstID_PSK | Const#41  string    "_InstID_PSK"
ESSID | Const#13  string    "ESSID"
ESSIDHideEnable | Const#23  string    "ESSIDHideEnable"
KeyPassphrase | Const#30  string    "KeyPassphrase"

and many more parameters......
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Note</code>: you could find differents in files becuase of the firmware <code class="language-plaintext highlighter-rouge">version &amp; realse</code></li>
</ul>

<p>Also there are some cariables has the <code class="language-plaintext highlighter-rouge">XML</code> name in as the following which explains the <code class="language-plaintext highlighter-rouge">XML</code> format type:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Local#1   R0   def:&lt;4&gt;    scope:&lt;5..349&gt;      name: InstXML
  Local#2   R1   def:&lt;5&gt;    scope:&lt;6..349&gt;      name: ErrorXML
  Local#3   R2   def:&lt;6&gt;    scope:&lt;7..349&gt;      name: OutXML
  Local#6   R5   def:&lt;10&gt;   scope:&lt;11..349&gt;     name: xmlStr
  Local#27  R26  def:&lt;93&gt;   scope:&lt;94..349&gt;     name: xmlTable
</code></pre></div></div>

<p>Now, backing to the request again as the <code class="language-plaintext highlighter-rouge">_InstID</code> is a <code class="language-plaintext highlighter-rouge">Const</code> variable. It has a value in the request as we can see, But when we try to change the value. It’s giving us error:</p>
<ul>
  <li>
    <p>Before changing the value
<img src="/assets/images/c4304cc09afb3069fb431e6daf75fd09.png" alt="c4304cc09afb3069fb431e6daf75fd09.png" /></p>
  </li>
  <li>
    <p>After Changing the value, It’s giving an error.
<img src="/assets/images/fdb8d7b7742fdb501237c80eca7df7a9.png" alt="fdb8d7b7742fdb501237c80eca7df7a9.png" /></p>
  </li>
  <li>
    <p>Here Trying to flow it with huge value to get any crash, andIt didn’t work.
<img src="/assets/images/96aa2d3ac3c904ce11eef47317e294ad.png" alt="96aa2d3ac3c904ce11eef47317e294ad.png" /></p>
  </li>
</ul>

<h1 id="final-thoughts">Final Thoughts</h1>
<p>As we didn’t do any dynamic analysis. Cause it will require us to emulate the firmware and debug it,To make everything clear. But, there are a logical posability that the bug in the following line:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GETTABLE 20 20 -36     &lt;77&gt;   R20@FP_IDENTITY = R20["_InstID"]
</code></pre></div></div>

<p>Let’s explain the line first the  <code class="language-plaintext highlighter-rouge">GETTABLE</code> operation is used to retrieve a value from a table which in this case is the <code class="language-plaintext highlighter-rouge">XMLtable</code> and it will retrive the value stored in the key <code class="language-plaintext highlighter-rouge">_InstID</code> and store it into <code class="language-plaintext highlighter-rouge">FP_IDENTITY</code> that holded at <code class="language-plaintext highlighter-rouge">R20</code>. In this case, As we pass a huge value it will crash the Lua VM which running the app.</p>

<h1 id="conclusion">Conclusion</h1>
<p>We can not fully admit that the <code class="language-plaintext highlighter-rouge">Final Thoughts</code> we discuss is the right or final one as we didn’t dig deep into and perform dynamic analysis. But, we would be analyzing it dynamically to fully verify the <code class="language-plaintext highlighter-rouge">Final Thoughts</code>. Also, it could be the same way but in another place or line of code.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#iot-exploitation" class="page__taxonomy-item" rel="tag">IoT Exploitation</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-01-05T00:00:00+08:00">January 5, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/iot%20exploitation/exploitzte/" class="pagination--pager" title="Exploit Writing (KILLx108): Kill ZTE Router
">Previous</a>
    
    
      <a href="/defense%20evasion/portspoof/" class="pagination--pager" title="Research: Evading Portspoof Solution
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
