<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CVE-2021-42890: Hostime Remote Command Injection - Zeyad Azima</title>
<meta name="description" content="A detailed analysis for CVE-2021-42890 a Remote Command Injection vulnerability affects TOTOLINK EX1200T model. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="CVE-2021-42890: Hostime Remote Command Injection">
<meta property="og:url" content="http://localhost:5000/iot%20exploitation/CVE_2021_42890/">


  <meta property="og:description" content="A detailed analysis for CVE-2021-42890 a Remote Command Injection vulnerability affects TOTOLINK EX1200T model. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/clfm149jg0ijy0jo32lrye520.png">





  <meta property="article:published_time" content="2023-03-27T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/iot%20exploitation/CVE_2021_42890/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CVE-2021-42890: Hostime Remote Command Injection">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-03-27T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">CVE-2021-42890: Hostime Remote Command Injection
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  10 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#obtaining-the-firmware">Obtaining the Firmware</a></li>
  <li><a href="#the-analysis">The Analysis</a></li>
  <li><a href="#final-thoughts">Final Thoughts</a></li>
  <li><a href="#conclusion">Conclusion</a>
    <ul>
      <li><a href="#references">References</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><strong>Introduction</strong></h1>

<p>A vulnerability discovered in TOTOLINK <code class="language-plaintext highlighter-rouge">EX1200T</code> model known as <code class="language-plaintext highlighter-rouge">CVE-2021-42889</code> which is a remote command injection through the <code class="language-plaintext highlighter-rouge">HostTime</code> parameter, As a results a malicious user can control the device and achieve remote command execution RCE. (<code class="language-plaintext highlighter-rouge">Note:Everything you obtain here is for educational purposes, Don't use or abuse any bug against any target without permissions</code>)</p>

<h1 id="obtaining-the-firmware"><strong>Obtaining the Firmware</strong></h1>

<p>Before we start we would need the firmware of the device, The</p>

<p>refore We can take a static look at the code and how it works to understand more. So, what we need is the vulnerable Firmware for the device which is <code class="language-plaintext highlighter-rouge">V4.1.2cu.5215</code> and we have many ways to do it:</p>

<ul>
  <li>
    <p>You can search for the firmware on the official website for the vendor.</p>
  </li>
  <li>
    <p>Download it from any other source (after someone already dump it from the device and published it).</p>
  </li>
  <li>
    <p>Dump the firmware through <code class="language-plaintext highlighter-rouge">UART</code>, You could read a detailed blog from <a href="https://www.cyberark.com/resources/threat-research-blog/accessing-and-dumping-firmware-through-uart">Here</a>.</p>
  </li>
  <li>
    <p>Also, you could contact the support to provide you with the firmware.</p>
  </li>
  <li>
    <p>Finally dumping the firmware using <code class="language-plaintext highlighter-rouge">CH341A</code> Mini programmer USB, You could read a detailed blog from <a href="https://www.blackhillsinfosec.com/dumping-firmware-with-the-ch341a-programmer/">Here</a>.</p>
  </li>
</ul>

<p>In my case, I found the firmware on the vendor website. Now, Let’s extract the firmware using <code class="language-plaintext highlighter-rouge">binwalk</code> tool as the following <code class="language-plaintext highlighter-rouge">binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"</code> and here is the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls
TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web
$ sudo binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"
[sudo] password for azima:

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
76            0x4C            JFFS2 filesystem, little endian
209052        0x3309C         Zlib compressed data, compressed
209388        0x331EC         Zlib compressed data, compressed
210144        0x334E0         Zlib compressed data, compressed
210832        0x33790         JFFS2 filesystem, little endian
231428        0x38804         Zlib compressed data, compressed
231988        0x38A34         Zlib compressed data, compressed
232548        0x38C64         Zlib compressed data, compressed
233116        0x38E9C         Zlib compressed data, compressed
233560        0x39058         JFFS2 filesystem, little endian
254344        0x3E188         Zlib compressed data, compressed
254696        0x3E2E8         JFFS2 filesystem, little endian
255224        0x3E4F8         Zlib compressed data, compressed
256064        0x3E840         JFFS2 filesystem, little endian
321636        0x4E864         LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 6526520 bytes
</code></pre></div></div>

<p>And as i am using <code class="language-plaintext highlighter-rouge">Windows Subsystem Linux (WSL)</code>, Here we can browser our firmware normally:</p>

<p><img src="/assets/images/d98947de812f01c6fb81e0c7141bbf09" alt="" /></p>

<h1 id="the-analysis"><strong>The Analysis</strong></h1>

<p>It’s the time for the analysis. We will need <code class="language-plaintext highlighter-rouge">Burp Suite</code> to see how is the request made that contains <code class="language-plaintext highlighter-rouge">HostTime</code> parameter where the command get injected. In the <code class="language-plaintext highlighter-rouge">Time Setting</code> Under <code class="language-plaintext highlighter-rouge">Management</code> tab, We can notice <code class="language-plaintext highlighter-rouge">Copy PC's Time</code>:</p>

<p><img src="/assets/images/8d322b6f857e7e29e3c6b61861281131" alt="" /></p>

<p>By clicking on it we can see the following request made to <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code>:</p>

<p><img src="/assets/images/8dabf3154366dd86e079609cf9ec35ac" alt="" /></p>

<p>Let’s go with <code class="language-plaintext highlighter-rouge">Ghidra</code> and reverse the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Now, By going to the file and check it with the <code class="language-plaintext highlighter-rouge">file</code> command, We can see it’s an <code class="language-plaintext highlighter-rouge">ELF 32bit MIPS</code> file:</p>

<p><img src="/assets/images/6a2f91a78faa533958de14c5ef16a103" alt="" /></p>

<p>Open it and create a new project i named it <code class="language-plaintext highlighter-rouge">EX1200T</code> for the device name and drop the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file into the project:</p>

<p><img src="/assets/images/034410b072a74688b68626459d1186eb" alt="" /></p>

<p>After that open the file using <code class="language-plaintext highlighter-rouge">Code Browser</code> within <code class="language-plaintext highlighter-rouge">Ghidra</code>:</p>

<p><img src="/assets/images/23e9b30a2455631e89c04bc344455b05" alt="" /></p>

<p>Then, analysis the file:</p>

<p><img src="/assets/images/a282cc9ee31eecee3e27d6531d38dd12" alt="" /></p>

<p>Navigating to <code class="language-plaintext highlighter-rouge">Symbol Tree</code> and let’s check out the functions:</p>

<p><img src="/assets/images/9bf6c0ef89653899c65b884d75be6a3e" alt="" /></p>

<p>After going through the functions clearly inside <code class="language-plaintext highlighter-rouge">FUN_00400dd8</code> function we can see the following lines of codes. But, there is no thing interesting and it’s all about functions calling other functions:</p>

<p><img src="/assets/images/7124299f1fed8a70976cc8dc4c49c400" alt="" /></p>

<p>We just can see that <code class="language-plaintext highlighter-rouge">httpStatus</code>, <code class="language-plaintext highlighter-rouge">redirectURL</code> &amp; <code class="language-plaintext highlighter-rouge">responseParam</code> being passed to some unclear functions. But, You can see under <code class="language-plaintext highlighter-rouge">\squashfs-root\lib\cste_modules</code> folder that there are libraries named as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.so
cloudupdate.so
global.so
lan.so
product.so
system.so
upgrade.so
wireless.so
wps.so
</code></pre></div></div>

<p>After reversing this libraries you will know that it’s clearly used by the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> to perform different operations and changes through the device panel. Let’s identify which one contains the <code class="language-plaintext highlighter-rouge">NTPSyncWithHost</code> by searching through the following <code class="language-plaintext highlighter-rouge">Bash</code> one liner using <code class="language-plaintext highlighter-rouge">strings</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in $(ls -la | awk '{print $9}' | grep ".so"); do echo ""; echo "Lib Name: $i"; strings $i | grep "NTPSyncWithHost"; done
</code></pre></div></div>

<p>The above line will print the library name after this will run the <code class="language-plaintext highlighter-rouge">strings</code> command on the library to get any string has the word <code class="language-plaintext highlighter-rouge">getWiFiApConfig</code> and will print the results under the library name. Therefore, we will be able to know which library copy for us the device time or anything related. Command output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Lib Name: app.so

Lib Name: cloudupdate.so

Lib Name: global.so

Lib Name: lan.so

Lib Name: product.so

Lib Name: system.so
NTPSyncWithHost
NTPSyncWithHost

Lib Name: upgrade.so

Lib Name: wireless.so

Lib Name: wps.so
</code></pre></div></div>

<p>And as we can see it’s with-in the <code class="language-plaintext highlighter-rouge">system.so</code> library, As we did with the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Let’s do the same with the library with <code class="language-plaintext highlighter-rouge">Ghidra</code>. After opening the <code class="language-plaintext highlighter-rouge">Functions</code> tab under <code class="language-plaintext highlighter-rouge">Symbol Tree</code> we can notice the <code class="language-plaintext highlighter-rouge">NTPSyncWithHost</code> function:</p>

<p><img src="/assets/images/995f6a50cbb86e14dfb6d9b58a64aa70" alt="" /></p>

<p>So, We can say the flaw is as the following:</p>

<p><img src="/assets/images/39e0c0651573933a917b5344615111bc" alt="" /></p>

<p>As we can see the function is a small function:</p>

<p><img src="/assets/images/849425590d93714d5e86b24ddbf593b2" alt="" /></p>

<p>Now, Let’s understand what this function do and how it works. First the function start by taking 3 parameters:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void NTPSyncWithHost(undefined4 param_1,undefined4 param_2,undefined4 param_3)
</code></pre></div></div>

<p>Then, We can see Declare variables used within the function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  undefined4 uVar1;
  FILE *__stream;
  int iVar2;
  char acStack_288 [256];
  undefined4 local_188;
  timeval local_184;
  char acStack_17c [100];
  char acStack_118 [256];
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">uVar1</code>: an undefined4 type variable.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">__stream</code>: a pointer to a FILE object.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">iVar2</code>: an integer variable.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">acStack_288</code>: a character array of size 256.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">local_188</code>: an undefined4 type variable.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">local_184</code>: a <code class="language-plaintext highlighter-rouge">timeval</code> struct (used to represent time intervals).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">acStack_17c</code>: a character array of size 100.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">acStack_118</code>: a character array of size 256.</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uVar1 = websGetVar(param_2,0x6110,0x6164);
memset(acStack_17c,0,100);
gettimeofday(&amp;local_184,(__timezone_ptr_t)0x0);
</code></pre></div></div>

<p>After that Call the <code class="language-plaintext highlighter-rouge">websGetVar()</code> function with parameters <code class="language-plaintext highlighter-rouge">param_2</code>, <code class="language-plaintext highlighter-rouge">0x6110</code>, and <code class="language-plaintext highlighter-rouge">0x6164</code>, then store the result in <code class="language-plaintext highlighter-rouge">uVar1</code>. The <code class="language-plaintext highlighter-rouge">websGetVar</code> function is used to get the value of a variable from a web form submitted by a user. The two hexadecimal values <code class="language-plaintext highlighter-rouge">0x6110</code> and <code class="language-plaintext highlighter-rouge">0x6164</code> are string pointers representing variable names, which the function will search for in the submitted form. <code class="language-plaintext highlighter-rouge">memset()</code> function is to fill the <code class="language-plaintext highlighter-rouge">acStack_17c</code> character array with <code class="language-plaintext highlighter-rouge">0's</code>, initializing it with a size of <code class="language-plaintext highlighter-rouge">100</code>. After that <code class="language-plaintext highlighter-rouge">gettimeofday()</code> function with the address of the <code class="language-plaintext highlighter-rouge">local_184</code> timeval struct and a null timezone pointer <code class="language-plaintext highlighter-rouge">((__timezone_ptr_t)0x0)</code> and get the current time and stores it in the timeval struct <code class="language-plaintext highlighter-rouge">local_184</code>. So, we can see that the <code class="language-plaintext highlighter-rouge">uVar1</code> carry the value of <code class="language-plaintext highlighter-rouge">HostTime</code> parameter. Now, Let’s rename it to <code class="language-plaintext highlighter-rouge">HostTime</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  __stream = fopen((char *)0x611c,(char *)0x5db4);
  if (__stream != (FILE *)0x0) {
    fscanf(__stream,(char *)0x5e70,acStack_118);
    iVar2 = atoi(acStack_118);
    fclose(__stream);
    sprintf(acStack_17c,(char *)0x6134,local_184.tv_sec - iVar2);
    system(acStack_17c);
  }
</code></pre></div></div>

<p>In these lines, the <code class="language-plaintext highlighter-rouge">fopen()</code> function is called with two parameters, <code class="language-plaintext highlighter-rouge">(char *)0x611c</code> and <code class="language-plaintext highlighter-rouge">(char *)0x5db4</code> and these two hexadecimal values are string pointers representing the file name and the file opening mode, respectively. The function opens the specified file and returns a <code class="language-plaintext highlighter-rouge">FILE</code> pointer which is stored in the <code class="language-plaintext highlighter-rouge">__stream</code> variable. If the file cannot be opened, <code class="language-plaintext highlighter-rouge">fopen()</code> will return a null pointer, Then it checks if <code class="language-plaintext highlighter-rouge">__stream</code> is not equal to a null pointer <code class="language-plaintext highlighter-rouge">((FILE *)0x0)</code>. If it is not null, that means the file has been successfully opened and the code inside the if statement will be executed which is a call to <code class="language-plaintext highlighter-rouge">fscanf()</code> function to read data from the opened file <code class="language-plaintext highlighter-rouge">__stream</code>, The function reads data according to the format specified by the string pointer <code class="language-plaintext highlighter-rouge">(char *)0x5e70</code> and stores the result in the <code class="language-plaintext highlighter-rouge">acStack_118</code> character array. The format string is a string that specifies how the data should be parsed from the file. Then <code class="language-plaintext highlighter-rouge">atoi()</code> function to convert the string in <code class="language-plaintext highlighter-rouge">acStack_118</code> to an integer and store the result in the <code class="language-plaintext highlighter-rouge">iVar2</code> variable. Finally, Close the opened file by calling the <code class="language-plaintext highlighter-rouge">fclose()</code> function with the <code class="language-plaintext highlighter-rouge">__stream</code> parameter and call the <code class="language-plaintext highlighter-rouge">sprintf()</code> function to format a string and store it in <code class="language-plaintext highlighter-rouge">acStack_17c</code> variable &amp; Call the <code class="language-plaintext highlighter-rouge">system()</code> function to execute the value in <code class="language-plaintext highlighter-rouge">acStack_17c</code> variable. By moving to the following lines:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iVar2 = Validity_check(HostTime);
if (iVar2 == 0) {
    sprintf(acStack_288,(char *)0x6158,HostTime);
    CsteSystem(acStack_288,0);
    apmib_set(0x97,&amp;local_188);
    apmib_update_web(4);
    system((char *)0x6168);
    websSetCfgResponse(param_1,param_3,0x5f40,0x5b88);
    system((char *)0x6180);
}
</code></pre></div></div>

<p>Here we can see Call the <code class="language-plaintext highlighter-rouge">Validity_check()</code> function with <code class="language-plaintext highlighter-rouge">HostTime</code> as a parameter, This function likely checks the validity of the <code class="language-plaintext highlighter-rouge">NTP</code> server address obtained from the web request and store the result in the <code class="language-plaintext highlighter-rouge">iVar2</code> variable. After that the <code class="language-plaintext highlighter-rouge">IF</code> condition checks if <code class="language-plaintext highlighter-rouge">iVar2</code> is equal to <code class="language-plaintext highlighter-rouge">0</code>, If it is, this means the <code class="language-plaintext highlighter-rouge">NTP</code> server address is valid and the code inside the if statement will be executed. By using the <code class="language-plaintext highlighter-rouge">sprintf()</code> function to format a string and store it in the <code class="language-plaintext highlighter-rouge">acStack_288</code> character array. The format string is specified by the string pointer <code class="language-plaintext highlighter-rouge">(char *)0x6158</code> and the <code class="language-plaintext highlighter-rouge">NTP</code> server address <code class="language-plaintext highlighter-rouge">HostTime</code> is used as an argument to fill the placeholders in the format string, Then calling the <code class="language-plaintext highlighter-rouge">CsteSystem()</code> function with the <code class="language-plaintext highlighter-rouge">acStack_288</code> character array and <code class="language-plaintext highlighter-rouge">0</code> as parameters and this function is a custom function made by the developer to run a system command to update the <code class="language-plaintext highlighter-rouge">NTP</code> server configuration with the user-specified server address which include our <code class="language-plaintext highlighter-rouge">HostTime</code> parameter value. After that, call <code class="language-plaintext highlighter-rouge">apmib_set()</code> function with <code class="language-plaintext highlighter-rouge">0x97</code> and the address of <code class="language-plaintext highlighter-rouge">local_188</code> as parameters and sets a value in the Application MIB (<code class="language-plaintext highlighter-rouge">Management Information Base</code>) database. Call the <code class="language-plaintext highlighter-rouge">apmib_update_web()</code> function with 4 as a parameter to update the web-based configuration interface to reflect the changes made to the <code class="language-plaintext highlighter-rouge">NTP</code> server configuration. After all of this we can see that the issue occurs at the following lines:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sprintf(acStack_288,(char *)0x6158,HostTime);
    CsteSystem(acStack_288,0);
</code></pre></div></div>

<p>As there is no filtration to the user input and the parameter value can be manipulated by the user. It’s time to exploit it. I connected the device through <code class="language-plaintext highlighter-rouge">telnet</code> services first:</p>

<p><img src="/assets/images/f0e032d334f0aec1e0351ab52ff71fe5" alt="" /></p>

<p>Now, Let’s go to <code class="language-plaintext highlighter-rouge">Burp Suite</code> and manipulate the request and show a PoC for the vulnerability:</p>

<p><img src="/assets/images/277fad159866460453e4811676e49630" alt="" /></p>

<p>As we can see in the above screenshot we were able to execute the command successfully.</p>

<h1 id="final-thoughts"><strong>Final Thoughts</strong></h1>

<p>The developer shall use an <code class="language-plaintext highlighter-rouge">Asp</code> endpoint to operate the time on the device as a different option instead of executing commands to do it. But, In our case of this code there are many solutions to make sure it will be hard for the user to escape the default command and inject malicious command using <code class="language-plaintext highlighter-rouge">regex</code> to check for a valid date as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void NTPSyncWithHost(undefined4 param_1,undefined4 param_2,undefined4 param_3)

{
  undefined4 HostTime;
  FILE *__stream;
  int iVar1;
  char acStack_288 [256];
  undefined4 local_188;
  timeval local_184;
  char acStack_17c [100];
  char acStack_118 [256];
  regex_t regex;
    int regex_status;
  // Compile the regular expression
    regex_status = regcomp(&amp;regex, "^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}$", REG_EXTENDED);
    if (regex_status) {
        printf("Could not compile regex.\n");
        return 1;
    }
     
  local_188 = 0;
  HostTime = websGetVar(param_2,0x6110,0x6164);
  memset(acStack_17c,0,100);
  gettimeofday(&amp;local_184,(__timezone_ptr_t)0x0);
  __stream = fopen((char *)0x611c,(char *)0x5db4);
  if (__stream != (FILE *)0x0) {
    fscanf(__stream,(char *)0x5e70,acStack_118);
    iVar1 = atoi(acStack_118);
    fclose(__stream);
    sprintf(acStack_17c,(char *)0x6134,local_184.tv_sec - iVar1);
    system(acStack_17c);
  }
  // Check if the HostTime variable matches the regex pattern
  regex_status = regexec(&amp;regex, HostTime, 0, NULL, 0);
    if (!regex_status) {
      iVar1 = Validity_check(HostTime);
      if (iVar1 == 0) {
        sprintf(acStack_288,(char *)0x6158,HostTime);
        CsteSystem(acStack_288,0);
        apmib_set(0x97,&amp;local_188);
        apmib_update_web(4);
        system((char *)0x6168);
        websSetCfgResponse(param_1,param_3,0x5f40,0x5b88);
        system((char *)0x6180);
  	} else {
            return 1;
        }
  }
  return;
}
</code></pre></div></div>

<p>Here we used <code class="language-plaintext highlighter-rouge">regex</code> to check the patterns of the date if it’s valid or no, If it’s not valid it will exit without executing anything. But, If it’s valid then it will execute the code normally.</p>

<h1 id="conclusion"><strong>Conclusion</strong></h1>

<p>In this analysis we had a look on <code class="language-plaintext highlighter-rouge">CVE-2021-42890</code> and highlighted the issue made by the developer &amp; Provided a solution that can help in mitigating the issue. Finally, You could use any other decompiler other than <code class="language-plaintext highlighter-rouge">Ghidra</code> as it’s not making the codes more clear.</p>

<p> </p>

<h2 id="references"><strong>References</strong></h2>

<ul>
  <li>
    <p><a href="https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html">https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html</a></p>
  </li>
  <li>
    <p><a href="https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_hosttime_rce.md">https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_hosttime_rce.md</a></p>
  </li>
  <li>
    <p>https://ghidra-sre.org/</p>
  </li>
  <li>
    <p><a href="https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf">https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf</a></p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#iot-exploitation" class="page__taxonomy-item" rel="tag">IoT Exploitation</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-03-27T00:00:00+08:00">March 27, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/iot%20exploitation/CVE_2021_42889/" class="pagination--pager" title="CVE-2021-42889: Access Points information leak
">Previous</a>
    
    
      <a href="/iot%20exploitation/CVE_2021_42885/" class="pagination--pager" title="CVE-2021-42885: deviceMac Remote Command Injection
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
