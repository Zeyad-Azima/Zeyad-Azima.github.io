<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CVE-2021-42885: deviceMac Remote Command Injection - Zeyad Azima</title>
<meta name="description" content="A detailed analysis for CVE-2021-42885 a deviceMac Remote Command Injection vulnerability in TOTOLINK EX1200T model. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="CVE-2021-42885: deviceMac Remote Command Injection">
<meta property="og:url" content="http://localhost:5000/iot%20exploitation/CVE_2021_42885/">


  <meta property="og:description" content="A detailed analysis for CVE-2021-42885 a deviceMac Remote Command Injection vulnerability in TOTOLINK EX1200T model. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/clfrpfz2c1jva0jmx9zt26n4f.png">





  <meta property="article:published_time" content="2023-04-01T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/iot%20exploitation/CVE_2021_42885/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CVE-2021-42885: deviceMac Remote Command Injection">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-04-01T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">CVE-2021-42885: deviceMac Remote Command Injection
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  13 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#obtaining-the-firmware">Obtaining the Firmware</a></li>
  <li><a href="#the-analysis">The Analysis</a></li>
  <li><a href="#final-thoughts">Final Thoughts</a></li>
  <li><a href="#conclusion">Conclusion</a>
    <ul>
      <li><a href="#references">References</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><strong>Introduction</strong></h1>

<p>A vulnerability discovered in TOTOLINK <code class="language-plaintext highlighter-rouge">EX1200T</code> model known as <code class="language-plaintext highlighter-rouge">CVE-2021-42885</code> which is a remote command injection through the <code class="language-plaintext highlighter-rouge">deviceMac</code> parameter, As a results a malicious user can control the device and achieve remote command execution RCE. (<code class="language-plaintext highlighter-rouge">Note:Everything you obtain here is for educational purposes, Don't use or abuse any bug against any target without permissions</code>)</p>

<h1 id="obtaining-the-firmware"><strong>Obtaining the Firmware</strong></h1>

<p>Before we start we would need the firmware of the device, therefore We can take a static look at the code and how it works to understand more. So, what we need is the vulnerable Firmware for the device which is <code class="language-plaintext highlighter-rouge">V4.1.2cu.5215</code> and we have many ways to do it:</p>

<ul>
  <li>
    <p>You can search for the firmware on the official website for the vendor.</p>
  </li>
  <li>
    <p>Download it from any other source (after someone already dump it from the device and published it).</p>
  </li>
  <li>
    <p>Dump the firmware through <code class="language-plaintext highlighter-rouge">UART</code>, You could read a detailed blog from <a href="https://www.cyberark.com/resources/threat-research-blog/accessing-and-dumping-firmware-through-uart">Here</a>.</p>
  </li>
  <li>
    <p>Also, you could contact the support to provide you with the firmware.</p>
  </li>
  <li>
    <p>Finally dumping the firmware using <code class="language-plaintext highlighter-rouge">CH341A</code> Mini programmer USB, You could read a detailed blog from <a href="https://www.blackhillsinfosec.com/dumping-firmware-with-the-ch341a-programmer/">Here</a>.</p>
  </li>
</ul>

<p>In my case, I found the firmware on the vendor website. Now, Let’s extract the firmware using <code class="language-plaintext highlighter-rouge">binwalk</code> tool as the following <code class="language-plaintext highlighter-rouge">binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"</code> and here is the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls
TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web
$ sudo binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"
[sudo] password for azima:

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
76            0x4C            JFFS2 filesystem, little endian
209052        0x3309C         Zlib compressed data, compressed
209388        0x331EC         Zlib compressed data, compressed
210144        0x334E0         Zlib compressed data, compressed
210832        0x33790         JFFS2 filesystem, little endian
231428        0x38804         Zlib compressed data, compressed
231988        0x38A34         Zlib compressed data, compressed
232548        0x38C64         Zlib compressed data, compressed
233116        0x38E9C         Zlib compressed data, compressed
233560        0x39058         JFFS2 filesystem, little endian
254344        0x3E188         Zlib compressed data, compressed
254696        0x3E2E8         JFFS2 filesystem, little endian
255224        0x3E4F8         Zlib compressed data, compressed
256064        0x3E840         JFFS2 filesystem, little endian
321636        0x4E864         LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 6526520 bytes
</code></pre></div></div>

<p>And as i am using <code class="language-plaintext highlighter-rouge">Windows Subsystem Linux (WSL)</code>, Here we can browser our firmware normally:</p>

<p><img src="/assets/images/5c543d8fa264d02701ae4a44f5eb6720" alt="" /></p>

<h1 id="the-analysis"><strong>The Analysis</strong></h1>

<p>It’s the time for the analysis.the request made that contains <code class="language-plaintext highlighter-rouge">deviceMac</code> parameter where the command get injected is as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /cgi-bin/cstecgi.cgi HTTP/1.1
Host: 192.168.0.1
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,zh-TW;q=0.8
If-Modified-Since: Thu, 01 Jan 1970 00:00:03 GMT
Connection: close
Content-Length: 68

{"topicurl":"setting/setDeviceName",
"deviceMac":"Vulnerable",
"deviceName":"1"}
</code></pre></div></div>

<p>Let’s go with <code class="language-plaintext highlighter-rouge">Ghidra</code> and reverse the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Now, By going to the file and check it with the <code class="language-plaintext highlighter-rouge">file</code> command, We can see it’s an <code class="language-plaintext highlighter-rouge">ELF 32bit MIPS</code> file:</p>

<p><img src="/assets/images/2542c29bcd004ce267f828f89be9010f" alt="" /></p>

<p>Open it and create a new project i named it <code class="language-plaintext highlighter-rouge">EX1200T</code> for the device name and drop the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file into the project:</p>

<p><img src="/assets/images/5662f4608bd3a068ee127a103094d625" alt="" /></p>

<p>After that open the file using <code class="language-plaintext highlighter-rouge">Code Browser</code> within <code class="language-plaintext highlighter-rouge">Ghidra</code>:</p>

<p><img src="/assets/images/73ea583ba2aa3a1235d1365066806104" alt="" /></p>

<p>Then, analysis the file:</p>

<p><img src="/assets/images/ad68c12d850bd55aae344e7224438abd" alt="" /></p>

<p>Navigating to <code class="language-plaintext highlighter-rouge">Symbol Tree</code> and let’s check out the functions:</p>

<p><img src="/assets/images/130d2a5d9acab5412b6e6d51c1378a9c" alt="" /></p>

<p>After going through the functions clearly inside <code class="language-plaintext highlighter-rouge">FUN_00400dd8</code> function we can see the following lines of codes. But, there is no thing interesting and it’s all about functions calling other functions:</p>

<p><img src="/assets/images/0db44be11c8099d07fd2ddeb527620e2" alt="" /></p>

<p>We just can see that <code class="language-plaintext highlighter-rouge">httpStatus</code>, <code class="language-plaintext highlighter-rouge">redirectURL</code> &amp; <code class="language-plaintext highlighter-rouge">responseParam</code> being passed to some unclear functions. But, You can see under <code class="language-plaintext highlighter-rouge">\squashfs-root\lib\cste_modules</code> folder that there are libraries named as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.so
cloudupdate.so
global.so
lan.so
product.so
system.so
upgrade.so
wireless.so
wps.so
</code></pre></div></div>

<p>After reversing this libraries you will know that it’s clearly used by the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> to perform different operations and changes through the device panel. Let’s identify which one contains the <code class="language-plaintext highlighter-rouge">deviceMac</code> by searching through the following <code class="language-plaintext highlighter-rouge">Bash</code> one liner using <code class="language-plaintext highlighter-rouge">strings</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in $(ls -la | awk '{print $9}' | grep ".so"); do echo ""; echo "Lib Name: $i"; strings $i | grep "deviceMac"; done
</code></pre></div></div>

<p>The above line will print the library name after this will run the <code class="language-plaintext highlighter-rouge">strings</code> command on the library to get any string has the word <code class="language-plaintext highlighter-rouge">deviceMac</code> and will print the results under the library name. Therefore, we will be able to know which library could has the vulnerable code or anything related. Command output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Lib Name: app.so

Lib Name: cloudupdate.so

Lib Name: global.so
,{"deviceMac":"%s","deviceName":"%s"}
deviceMac

Lib Name: lan.so

Lib Name: product.so

Lib Name: system.so

Lib Name: upgrade.so

Lib Name: wireless.so

Lib Name: wps.so
</code></pre></div></div>

<p>And as we can see it’s with-in the <code class="language-plaintext highlighter-rouge">global.so</code> library, As we did with the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Let’s do the same with the library with <code class="language-plaintext highlighter-rouge">Ghidra</code>. After opening the <code class="language-plaintext highlighter-rouge">Functions</code> tab under <code class="language-plaintext highlighter-rouge">Symbol Tree</code> we can notice the <code class="language-plaintext highlighter-rouge">setDeviceName</code> function:</p>

<p><img src="/assets/images/49ea426def3e66f891b22a660de1ae32" alt="" /></p>

<p>So, We can say the flaw is as the following:</p>

<p><img src="/assets/images/18499c03e0a15898ec3426aa22d937ed" alt="" /></p>

<p>Now, Let’s understand what this function do and how it works. First the function start by taking 3 parameters:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>undefined4 setDeviceName(undefined4 param_1,undefined4 param_2,undefined4 param_3)
</code></pre></div></div>

<p>After that the following lines declaring variables:</p>

<p><img src="/assets/images/baf28087164b901090c5db57391d8b4c" alt="" /></p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char cVar1</code>: This declares a variable <code class="language-plaintext highlighter-rouge">cVar1</code> of type char.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bool bVar2</code>: This declares a variable <code class="language-plaintext highlighter-rouge">bVar2</code> of type bool.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char *pcVar3</code>: This declares a variable <code class="language-plaintext highlighter-rouge">pcVar3</code> of type <code class="language-plaintext highlighter-rouge">char *</code>, which is a pointer to a character.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char *pcVar4</code>: This declares a variable pcVar4 of type <code class="language-plaintext highlighter-rouge">char *</code>, which is also a pointer to a character.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">int iVar5</code>: This declares a variable <code class="language-plaintext highlighter-rouge">iVar5</code> of type integer.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">FILE *__stream</code>: This declares a variable <code class="language-plaintext highlighter-rouge">__stream</code> of type <code class="language-plaintext highlighter-rouge">FILE *</code>, which is a pointer to a FILE type used for input/output operations.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">size_t sVar6</code>: This declares a variable <code class="language-plaintext highlighter-rouge">sVar6</code> of type size_t, which is an unsigned integer type. It’s commonly used to represent sizes of objects.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char *pcVar7</code>: This declares a variable <code class="language-plaintext highlighter-rouge">pcVar7</code> of type <code class="language-plaintext highlighter-rouge">char *</code>, which is another pointer to a character.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char *__s</code>: This declares a variable <code class="language-plaintext highlighter-rouge">__s</code> of type <code class="language-plaintext highlighter-rouge">char *</code>, which is a pointer to a character.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char acStack_1138 [127]</code>: This declares an array <code class="language-plaintext highlighter-rouge">acStack_1138</code> of 127 characters. This array is allocated on the stack.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char acStack_10b9 [129]</code>: This declares another array <code class="language-plaintext highlighter-rouge">acStack_10b9</code> of 129 characters. This array is also allocated on the stack.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char local_1038 [32]</code>: This declares an array <code class="language-plaintext highlighter-rouge">local_1038</code> of 32 characters. This array is also allocated on the stack.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char local_1018 [4064]</code>: This declares an array <code class="language-plaintext highlighter-rouge">local_1018</code> of 4064 characters. This array is also allocated on the stack.</p>
  </li>
  <li>
    <p>char <code class="language-plaintext highlighter-rouge">*local_38</code>: This declares a variable <code class="language-plaintext highlighter-rouge">local_38</code> of type <code class="language-plaintext highlighter-rouge">char *</code>, which is yet another pointer to a character.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char *local_34</code>: This declares a variable <code class="language-plaintext highlighter-rouge">local_34</code> of type <code class="language-plaintext highlighter-rouge">char *</code>, which is also a pointer to a character.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">char *local_30</code>: This declares a variable <code class="language-plaintext highlighter-rouge">local_30</code> of type <code class="language-plaintext highlighter-rouge">char *</code>, which is also a pointer to a character.</p>
  </li>
</ul>

<p>Then, When it comes to line <code class="language-plaintext highlighter-rouge">22</code> we can see the following calls for functions:</p>

<p><img src="/assets/images/f827d1f18a0fa1b0e940e9da10d517c7" alt="" /></p>

<p>The <code class="language-plaintext highlighter-rouge">memset()</code> function is used to initialize arrays to a specific value for the <code class="language-plaintext highlighter-rouge">acStack_1138</code> array with zeros and has a size of <code class="language-plaintext highlighter-rouge">0x80</code> (<code class="language-plaintext highlighter-rouge">128 bytes</code>) &amp; <code class="language-plaintext highlighter-rouge">acStack_10b9</code> array, starting from the second element <code class="language-plaintext highlighter-rouge">acStack_10b9 + 1</code> with zeros and has a size of <code class="language-plaintext highlighter-rouge">0x80</code> (<code class="language-plaintext highlighter-rouge">128 bytes</code>). Then, initializes the <code class="language-plaintext highlighter-rouge">local_1038</code> array with zeros and has a size of <code class="language-plaintext highlighter-rouge">0x1000</code> (<code class="language-plaintext highlighter-rouge">4096 bytes</code>). Finally, retrieves a value of the parameter <code class="language-plaintext highlighter-rouge">deviceMac</code> from the web request and stores it in <code class="language-plaintext highlighter-rouge">pcVar3</code> and retrieves a value of the parameter <code class="language-plaintext highlighter-rouge">deviceName</code> from the web request and stores it in <code class="language-plaintext highlighter-rouge">pcVar4</code>. So, Let’s rename the <code class="language-plaintext highlighter-rouge">pcVar3</code> to <code class="language-plaintext highlighter-rouge">deviceMac</code> &amp; pcVar4 to <code class="language-plaintext highlighter-rouge">deviceName</code>. At the end executes a shell command using the <code class="language-plaintext highlighter-rouge">system()</code> function and the command being executed is <code class="language-plaintext highlighter-rouge">/bin/jffs2.sh 1 2&gt; /dev/null</code>, Let’s connect to the router and check the file and what is it do. I connected the device through <code class="language-plaintext highlighter-rouge">telnet</code> services:</p>

<p><img src="/assets/images/e98a28584d7d1233a47b1f056bcf3f7a" alt="" /></p>

<p>And as we can see here is the file:</p>

<p><img src="/assets/images/13e07c0674a4a1782e5b33d642a99e36" alt="" /></p>

<p>When we <code class="language-plaintext highlighter-rouge">cat</code> the file we can get it’s content as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/sh
#
# script file to mount userdata.jffs2
#
# Usage: jffs2.sh {mtdname}
#

umount /dev/mtdblock2 2&gt;/dev/null

sleep 1

if [ $1 -eq 1 ]; then
        mount -t jffs2 /dev/mtdblock2 /mnt -o rw 2&gt;/dev/null
else
        mount -t jffs2 /dev/mtdblock2 /mnt -o ro 2&gt;/dev/null
fi

if [ $? -ne 0 ]; then

        if [ $1 -eq 1 ]; then
                mount -t jffs2 /dev/mtdblock2 /mnt -o rw 2&gt;/dev/null
        else
                mount -t jffs2 /dev/mtdblock2 /mnt -o ro 2&gt;/dev/null
        fi

        if [ $? -ne 0 ]; then
                if [ $1 -eq 1 ]; then
                        mount -t jffs2 /dev/mtdblock2 /mnt -o rw 2&gt;/dev/null
                else
                        mount -t jffs2 /dev/mtdblock2 /mnt -o ro 2&gt;/dev/null
                fi

                if [ $? -ne 0 ]; then
                        echo "mount invalid! erase mtd and mount again!"
                        sysconf mtd_erase
                fi
        fi
fi
</code></pre></div></div>

<p>The script attempts to unmount any existing file system on <code class="language-plaintext highlighter-rouge">/dev/mtdblock2</code>. Any error messages produced by the command are discarded and waits for 1 second.After that checks the value of the argument <code class="language-plaintext highlighter-rouge">$1</code>. If it is equal to 1, the file system is mounted as <code class="language-plaintext highlighter-rouge">read-write</code> (<code class="language-plaintext highlighter-rouge">-o rw</code> option). Otherwise, it is mounted as read-only (<code class="language-plaintext highlighter-rouge">-o ro</code> option), Then checks the exit status of the previous command. If it is not equal to <code class="language-plaintext highlighter-rouge">0</code>, the mount operation failed. If the mount operation failed, the script attempts to mount the file system again, up to three times. If the mount operation still fails after three attempts, the script outputs an error message and runs the command <code class="language-plaintext highlighter-rouge">sysconf mtd_erase</code> which erase the memory technology device (<code class="language-plaintext highlighter-rouge">mtd</code>) and mount the file system again. By moving on with the following lines:</p>

<p><img src="/assets/images/d425ba3f3633beaf06d7ae3c41c59ae9" alt="" /></p>

<p>the code checks for the existence of a file <code class="language-plaintext highlighter-rouge">/mnt/customDeviceName</code>, opens it, reads its contents, and performs some operations on the data. if the file <code class="language-plaintext highlighter-rouge">/mnt/customDeviceName</code> exists and is readable. If it does, <code class="language-plaintext highlighter-rouge">access()</code> returns <code class="language-plaintext highlighter-rouge">0</code>, and <code class="language-plaintext highlighter-rouge">iVar5</code> is set to <code class="language-plaintext highlighter-rouge">0</code>. and if we go to the device again we can see that the file contains the data we send in the request:</p>

<p><img src="/assets/images/55791fdcc3e175f18a53456a1b812dbd" alt="" /></p>

<p>After that checks if <code class="language-plaintext highlighter-rouge">access()</code> succeeded in finding the file. If the file exists,It opens the file for reading and if the file was successfully opened, a loop that reads lines from the file using <code class="language-plaintext highlighter-rouge">fgets()</code> and stores it in the buffer <code class="language-plaintext highlighter-rouge">__s</code>, Then performs some operations on the data until there are no more lines to read.After that <code class="language-plaintext highlighter-rouge">strlen(__s)</code> determines the length of the string read by <code class="language-plaintext highlighter-rouge">fgets()</code> and <code class="language-plaintext highlighter-rouge">acStack_10b9[sVar6]</code> sets the null terminator at the end of the string in the <code class="language-plaintext highlighter-rouge">acStack_10b9</code>. Then, checks if the second character in <code class="language-plaintext highlighter-rouge">acStack_10b9</code> is not null and if the string contains a <code class="language-plaintext highlighter-rouge">,</code>. If both conditions are met, the code extracts two strings from the line using <code class="language-plaintext highlighter-rouge">strncpy()</code> and <code class="language-plaintext highlighter-rouge">strstr()</code> &amp; as we can guess it’s the <code class="language-plaintext highlighter-rouge">deviceMac</code>,<code class="language-plaintext highlighter-rouge">deviceName</code> and formats them using <code class="language-plaintext highlighter-rouge">snprintf()</code>. Finally, stores them in the <code class="language-plaintext highlighter-rouge">local_1038</code> array. If no matching string is found, the code formats the two variables <code class="language-plaintext highlighter-rouge">deviceMac</code> and <code class="language-plaintext highlighter-rouge">deviceName</code> using <code class="language-plaintext highlighter-rouge">snprintf()</code> and stores them in <code class="language-plaintext highlighter-rouge">local_1038</code>. Finally, the file is closed using <code class="language-plaintext highlighter-rouge">fclose()</code>.</p>

<p><img src="/assets/images/36ad6cad8708a6b539a578445bdbec9e" alt="" /></p>

<p>If <code class="language-plaintext highlighter-rouge">access()</code> doesn’t succeeded in finding the file creates a string containing a command that writes the values of <code class="language-plaintext highlighter-rouge">deviceMac</code> and <code class="language-plaintext highlighter-rouge">deviceName</code> to the file <code class="language-plaintext highlighter-rouge">/mnt/customDeviceName</code> and then execute the <code class="language-plaintext highlighter-rouge">command system(acStack_1138)</code>. After that checks if the <code class="language-plaintext highlighter-rouge">local_1038</code> array contains any data a loop that writes data to the file <code class="language-plaintext highlighter-rouge">/mnt/customDeviceName</code> using by executing command. The loop continues until the end of the <code class="language-plaintext highlighter-rouge">local_1018</code> array is reached and then If <code class="language-plaintext highlighter-rouge">iVar3</code> is <code class="language-plaintext highlighter-rouge">0</code>, the loop writes the first value of <code class="language-plaintext highlighter-rouge">local_1038</code> to the file using the <code class="language-plaintext highlighter-rouge">&gt;</code> redirection operator. Otherwise, it appends the value to the file using the <code class="language-plaintext highlighter-rouge">&gt;&gt;</code> redirection operator. So, as we can see clearly there is no input validation is done on the <code class="language-plaintext highlighter-rouge">deviceMac</code> &amp; <code class="language-plaintext highlighter-rouge">deviceName</code> which can be manpulated by the user. Now, It’s time for exploiting it. Opening <code class="language-plaintext highlighter-rouge">Burp Suite</code> and take the request to the repeater tab and start to reproduce the bug.</p>

<p><img src="/assets/images/6c13f226bdb1a846f2bb8ac00d016b1f" alt="" /></p>

<p>After we send the request we can see that the <code class="language-plaintext highlighter-rouge">poc</code> file created under <code class="language-plaintext highlighter-rouge">/tmp</code> directory if we open our device through <code class="language-plaintext highlighter-rouge">telnet</code> services again we can find the file:</p>

<p><img src="/assets/images/699bda9e8442c73e91584850d6af38ad" alt="" /></p>

<h1 id="final-thoughts"><strong>Final Thoughts</strong></h1>

<p>The developer shall use an <code class="language-plaintext highlighter-rouge">Asp</code> endpoint to operate the save of the <code class="language-plaintext highlighter-rouge">deviceMac</code> on the device as a different option instead of executing commands to do it. But, In our case of this code there are many solutions to make sure it will be hard for the user to escape the default command and inject malicious command using <code class="language-plaintext highlighter-rouge">regex</code> to check for a valid <code class="language-plaintext highlighter-rouge">MAC</code> address as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>char *regex_pattern = "^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$";

    // Compile the regex pattern
    regex_t regex;
    int reti = regcomp(&amp;regex, regex_pattern, REG_EXTENDED);
    if (reti != 0) {
        fprintf(stderr, "Failed to compile regex\n");
        return 1;
    }

    // Execute the regex match
    reti = regexec(&amp;regex, deviceMac, 0, NULL, 0);
    if (reti == 0) {
          system("/bin/jffs2.sh 1 2&gt; /dev/null");
  iVar3 = access("/mnt/customDeviceName",0);
  if (iVar3 == 0) {
    __stream = fopen("/mnt/customDeviceName","r");
    if (__stream != (FILE *)0x0) {
      local_38 = local_1038;
      bVar2 = false;
      iVar3 = 0;
      __s = acStack_10b9 + 1;
      local_34 = "%s,%s";
      while (pcVar5 = fgets(__s,0x80,__stream), pcVar5 != (char *)0x0) {
        sVar4 = strlen(__s);
        acStack_10b9[sVar4] = '\0';
        if ((acStack_10b9[1] != '\0') &amp;&amp; (pcVar5 = strchr(__s,0x2c), pcVar5 != (char *)0x0)) {
          local_30 = local_38;
          strncpy(local_38,__s,0x20);
          pcVar5 = strstr(local_38,deviceMac);
          if (pcVar5 != (char *)0x0) {
            snprintf(local_30,0x20,local_34,deviceMac,deviceName);
            bVar2 = true;
          }
          iVar3 = iVar3 + 1;
          local_38 = local_38 + 0x20;
        }
      }
      if (!bVar2) {
        snprintf(local_1038 + iVar3 * 0x20,0x20,"%s,%s",deviceMac,deviceName);
      }
      fclose(__stream);
    }
  }
  else {
    sprintf(acStack_1138,"echo \'%s,%s\' &gt; /mnt/customDeviceName",deviceMac,deviceName);
    system(acStack_1138);
  }
  if (local_1038[0] != '\0') {
    iVar3 = 0;
    deviceMac = local_1038;
    deviceName = local_1018;
    do {
      if (iVar3 == 0) {
        sprintf(acStack_1138,"echo \'%s\' &gt; /mnt/customDeviceName",deviceMac);
      }
      else {
        sprintf(acStack_1138,"echo \'%s\' &gt;&gt; /mnt/customDeviceName",deviceMac);
      }
      system(acStack_1138);
      iVar3 = iVar3 + 1;
      cVar1 = *deviceName;
      deviceMac = deviceName;
      deviceName = deviceName + 0x20;
    } while (cVar1 != '\0');
  }
    } else {
        return 1;
    }
</code></pre></div></div>

<p>Here we used <code class="language-plaintext highlighter-rouge">regex</code> to check the patterns of the <code class="language-plaintext highlighter-rouge">deviceMac</code> if it’s valid or no, If it’s not valid it will exit without executing anything. But, If it’s valid then it will execute the code normally.</p>

<h1 id="conclusion"><strong>Conclusion</strong></h1>

<p>In this analysis we had a look on <code class="language-plaintext highlighter-rouge">CVE-2021-42885</code> and highlighted the issue made by the developer &amp; Provided a solution that can help in mitigating the issue. Finally, You could use any other decompilers other than <code class="language-plaintext highlighter-rouge">Ghidra</code> as it’s not making the codes more clear.</p>

<h2 id="references"><strong>References</strong></h2>

<ul>
  <li>
    <p><a href="https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html">https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html</a></p>
  </li>
  <li>
    <p><a href="https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_devicemac_rce.md">https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_devicemac_rce.md</a></p>
  </li>
  <li>
    <p>https://ghidra-sre.org/</p>
  </li>
  <li>
    <p><a href="https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf">https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf</a></p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#iot-exploitation" class="page__taxonomy-item" rel="tag">IoT Exploitation</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-04-01T00:00:00+08:00">April 1, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/iot%20exploitation/CVE_2021_42890/" class="pagination--pager" title="CVE-2021-42890: Hostime Remote Command Injection
">Previous</a>
    
    
      <a href="/security%20research/CVE_2023_24815/" class="pagination--pager" title="CVE-2023-24815: Vert.x-Web Path Traversal Escape
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
