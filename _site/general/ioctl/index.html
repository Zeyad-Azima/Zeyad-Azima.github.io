<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Introduction to IOCTL (Input/Output CONTROL) - Zeyad Azima</title>
<meta name="description" content="An Introduction to Input Output CONTROL (IOCTL) ">


  <meta name="author" content="Zeyad Azima">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Zeyad Azima">
<meta property="og:title" content="Introduction to IOCTL (Input/Output CONTROL)">
<meta property="og:url" content="http://localhost:5000/general/ioctl/">


  <meta property="og:description" content="An Introduction to Input Output CONTROL (IOCTL) ">



  <meta property="og:image" content="http://localhost:5000/assets/images/37c839ce7f03af08132d6fd32f3a67cb.png">





  <meta property="article:published_time" content="2023-02-09T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:5000/general/ioctl/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zeyad Azima",
      "url": "http://localhost:5000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Zeyad Azima Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

<!-- favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/site_data/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/site_data/favicon-16x16.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/site_data/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Zeyad Azima
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#Security-Research">Security Research</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#MacOS">MacOS</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#IoT-Exploitation">IoT Exploitation</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Defense-Evasion">Defense Evasion</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#General">General</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/#Certificates">Certificates</a>
            </li><li class="masthead__menu-item">
              <a href="/categories">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/site_data/avatar.jpg" alt="Zeyad Azima" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Zeyad Azima</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Brain Storming Stuff (Exploit Development, Reverse Engineering &amp; More)</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="mailto:contact@zeyadazima.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/AzimaZeyad" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/zer0verflow/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/Zeyad-Azima" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/zeyadazima" rel="nofollow noopener noreferrer"><i class="fas fa-mug-hot" aria-hidden="true"></i><span class="label">Buy Me a Coffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Introduction to IOCTL (Input/Output CONTROL)">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2023-02-09T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Introduction to IOCTL (Input/Output CONTROL)
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  11 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#the-modes">The Modes</a></li>
  <li><a href="#what-is-user-mode-">What is User Mode ?</a></li>
  <li><a href="#what-is-kernel-mode-">What is Kernel Mode ?</a></li>
  <li><a href="#inputoutput-control-ioctl">Input/Output Control (IOCTL)</a>
    <ul>
      <li><a href="#ioctls">IOCTLs</a></li>
      <li><a href="#how-ioctl-works-">How IOCTL works ?</a></li>
      <li><a href="#sending-ioctl-request">Sending IOCTL Request</a></li>
      <li><a href="#running-the-code">Running The code</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

            </nav>
          </aside>
        
        <h1 id="introduction">Introduction</h1>

<p>In this blog, We will be discussing the Basics of <strong>`IOCTL (Input/Output CONTROL)`</strong>, What is it ?, The modes types, What is it used for ? and I will show an example of sending an <strong>IOCTL</strong> Request. But, before we moving further with all of this we need to understand the <strong>User Mode</strong> and the <strong>Kernel Mode</strong>.</p>

<h1 id="the-modes">The Modes</h1>

<p>Basically, The modes word itself referring to the different states of operation &amp; different levels of privilege that the system or a software could run. In general, each mode different from the other and operate differently with different privileges and access levels &amp; the main 2 modes we have and will talk about is <code class="language-plaintext highlighter-rouge">User Mode</code>&amp;<code class="language-plaintext highlighter-rouge">Kernel Mode</code>.</p>

<h1 id="what-is-user-mode-">What is User Mode ?</h1>

<p>The <code class="language-plaintext highlighter-rouge">User Mode</code> is the mode which the levels of operations &amp; privileges are restricted and limited in access &amp; permissions. So, the software or any program running in the <code class="language-plaintext highlighter-rouge">User Mode</code> or inside it, Won’t be able to perform certain operations that could be malicious or harmful to other softwares and the system. In short, <code class="language-plaintext highlighter-rouge">User Mode</code> is a non-privileged mode where it can’t access the hardware resources or any low level operations directly. For example, A malware running in the <code class="language-plaintext highlighter-rouge">User Mode</code> can’t access or modify the <code class="language-plaintext highlighter-rouge">CPU</code> instructions cause if this happened the malware easly will have an elevated privileges and as it’s on the hardware. Therefore, It’s the highest privileges you can get and u won’t have any restriction.</p>

<h1 id="what-is-kernel-mode-">What is Kernel Mode ?</h1>

<p>The <code class="language-plaintext highlighter-rouge">Kernel Mode</code> is a non-restricted mode where you can access the hardware resources directly where you will be able to manage any related resources such as <code class="language-plaintext highlighter-rouge">CPU</code> &amp; <code class="language-plaintext highlighter-rouge">Memory</code> and perform any low level operations easily. For example, any one get access to the <code class="language-plaintext highlighter-rouge">Kernel Mode</code> will be able to manipulate the resources easily and can also escalate privileges which could happen through a vulnerability or any misconfigurations. In short, The <code class="language-plaintext highlighter-rouge">Kernel Mode</code> opposite to the <code class="language-plaintext highlighter-rouge">User Mode</code> and each of one has different levels of operations &amp; levels of privileges.</p>

<h1 id="inputoutput-control-ioctl">Input/Output Control (IOCTL)</h1>

<p><code class="language-plaintext highlighter-rouge">IOCTL</code> is short for “Input/Output Control” which is a system call used for input/output operations and communications from the <code class="language-plaintext highlighter-rouge">User Mode</code> to the <code class="language-plaintext highlighter-rouge">Kernel Mode</code> drivers. Basically, It allows the components in the <code class="language-plaintext highlighter-rouge">User Mode</code> for example a software to communicate and control the behaviour of a device driver in <code class="language-plaintext highlighter-rouge">Kernel Mode</code>.</p>

<h2 id="ioctls">IOCTLs</h2>

<p>The <code class="language-plaintext highlighter-rouge">IOCTLs</code> are a set of codes and each one of these codes has a specific job to be used in and perform. For example:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_DISK_GET_LENGTH_INFO</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to retrieve the length of a disk partition.</li>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_VIDEO_QUERY_SUPPORTED_BRIGHTNESS</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to query the supported brightness levels of a display.</li>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_SERIAL_SET_BAUD_RATE</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to set the baud rate of a serial port.</li>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_CDROM_GET_LAST_SESSION</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to retrieve information about the last session on a CD-ROM.</li>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_STORAGE_QUERY_PROPERTY</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to retrieve information about a storage device.</li>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_MOUSE_GET_ATTRIBUTES</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to retrieve the attributes of a mouse device.</li>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_KEYBOARD_SET_TYPEMATIC</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to set the typematic rate of a keyboard.</li>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_SMARTCARD_TRANSMIT</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to send a command to a smart card reader.</li>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_USB_GET_DESCRIPTOR_FROM_NODE_CONNECTION</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to retrieve a USB descriptor from a USB device.</li>
  <li><code class="language-plaintext highlighter-rouge">IOCTL_NDIS_QUERY_GLOBAL_STATS</code>: This <code class="language-plaintext highlighter-rouge">IOCTL</code> code is used to query global statistics for a network adapter.</li>
</ul>

<p>Those where example for the <strong><code class="language-plaintext highlighter-rouge">IOCTLs</code></strong> you can find all the <strong><code class="language-plaintext highlighter-rouge">IOCTL</code></strong> codes you need from <a href="https://web.archive.org/web/20230723124350/http://www.ioctls.net/">Here</a>.</p>

<h2 id="how-ioctl-works-">How IOCTL works ?</h2>

<p>When the apps or the components in the <code class="language-plaintext highlighter-rouge">User Mode</code> wants to query information of a device driver in the <code class="language-plaintext highlighter-rouge">Kernel Mode</code>. It sends a request known as <code class="language-plaintext highlighter-rouge">IOCTL</code> request, The <strong><code class="language-plaintext highlighter-rouge">IOCTL</code></strong> requests are made &amp; sent using the <code class="language-plaintext highlighter-rouge">DeviceIoControl()</code> which is a windows API function.</p>

<p><img src="/assets/images/60bb5e544fe70cfb763805864706f0ae.png" alt="60bb5e544fe70cfb763805864706f0ae.png" /></p>

<p>When the the <code class="language-plaintext highlighter-rouge">DeviceIoControl()</code> function gets called it is actually implemented by calling another function which is <code class="language-plaintext highlighter-rouge">NtDeviceIoControlFile()</code> resides in the <strong>ntdll.dll</strong>, Then the <code class="language-plaintext highlighter-rouge">IOCTL</code> request sent to the device driver. There are 4 buffering methods that can be used with the <strong><code class="language-plaintext highlighter-rouge">IOCTL</code></strong> request which are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">METHOD_BUFFERED</code>: Copies the input and output buffers to and from the driver through an intermediate system buffer.</li>
  <li><code class="language-plaintext highlighter-rouge">METHOD_IN_DIRECT</code>: Its used when the input buffer is large and will not fit in the intermediate system buffer. In this case, the input buffer is mapped directly into the driver’s address space.</li>
  <li><code class="language-plaintext highlighter-rouge">METHOD_OUT_DIRECT</code>: In case the output buffer is large and will not fit in the intermediate system buffer. In this case, the output buffer is mapped directly into the driver’s address space.</li>
  <li><code class="language-plaintext highlighter-rouge">METHOD_NEITHER</code>: When the input and output buffers are not contiguous and cannot be mapped into a single buffer. The driver and application exchange pointers to the separate input and output buffers.</li>
</ul>

<p>Note: If you wondering at which part the user get’s a <code class="language-plaintext highlighter-rouge">Kernel Mode</code> access. Basically, there are 2 functions/syscalls used which are <strong><code class="language-plaintext highlighter-rouge">kifastsystemcall</code></strong> and <strong><code class="language-plaintext highlighter-rouge">kifastsystemcallret</code></strong> and both are kernel functions that provide a mechanism for making syscalls from user mode to kernel mode. The <strong><code class="language-plaintext highlighter-rouge">kifastsystemcall</code></strong> function takes the parameters for a syscall and makes the transition from user mode to kernel mode using a secret number called <code class="language-plaintext highlighter-rouge">syscall gate</code> (which grants the <code class="language-plaintext highlighter-rouge">Kernel Mode</code> access) and the parameters onto the stack. Then it makes a syscall instruction to trigger the kernel to execute the syscall. And the <strong><code class="language-plaintext highlighter-rouge">kifastsystemcallret</code></strong> function is used to return from the syscall back to the <code class="language-plaintext highlighter-rouge">User Mode</code> by passing the return address of the <code class="language-plaintext highlighter-rouge">User Mode</code> code which is stored on the stack during the syscall.</p>

<h2 id="sending-ioctl-request">Sending IOCTL Request</h2>

<p>To understand the <code class="language-plaintext highlighter-rouge">IOCTL</code> request we will do in a clearly way, The <code class="language-plaintext highlighter-rouge">DeviceIoControl()</code> function structure is as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BOOL DeviceIoControl(
  HANDLE       hDevice,
  DWORD        dwIoControlCode,
  LPVOID       lpInBuffer,
  DWORD        nInBufferSize,
  LPVOID       lpOutBuffer,
  DWORD        nOutBufferSize,
  LPDWORD      lpBytesReturned,
  LPOVERLAPPED lpOverlapped
);
</code></pre></div></div>

<p>each parameter in the function represents as the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">hDevice</code>: It’s a handle to the device thatwill be used to perform the operation.</li>
  <li><code class="language-plaintext highlighter-rouge">dwIoControlCode</code>: The <code class="language-plaintext highlighter-rouge">IOCTL</code> code that identifies the operation to be performed.</li>
  <li><code class="language-plaintext highlighter-rouge">lpInBuffer</code>: A pointer to the input buffer that contains the data required to perform the operation.</li>
  <li><code class="language-plaintext highlighter-rouge">nInBufferSize</code>: The size of the input buffer.</li>
  <li><code class="language-plaintext highlighter-rouge">lpOutBuffer</code>: A pointer to the output buffer that receives the data returned by the operation.</li>
  <li><code class="language-plaintext highlighter-rouge">nOutBufferSize</code>: The size of the output buffer.</li>
  <li><code class="language-plaintext highlighter-rouge">lpBytesReturned</code>: A pointer to the number of bytes returned by the operation.</li>
  <li><code class="language-plaintext highlighter-rouge">lpOverlapped</code>: A pointer to an <code class="language-plaintext highlighter-rouge">OVERLAPPED</code> structure that is used for asynchronous operations.</li>
</ul>

<p>Note: the data size is in bytes &amp; the <code class="language-plaintext highlighter-rouge">Asynchronous operations</code> is an operation that allows the software to continue executing while waiting for a potentially long-running operation to be completed and the <strong><code class="language-plaintext highlighter-rouge">OVERLAPPED</code></strong> structure is used to manage these operations.</p>

<p>Now, It’s the time to send our <code class="language-plaintext highlighter-rouge">IOCTL</code> request and i will be using the <code class="language-plaintext highlighter-rouge">IOCTL_DISK_GET_DRIVE_GEOMETRY_EX</code> code which retrieves extended information about the physical disk’s geometry like the type, number of cylinders, etc.</p>

<p><strong><code class="language-plaintext highlighter-rouge">IOCTL</code> request Code:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
#include &lt;winioctl.h&gt;

int main() {
  HANDLE hDevice;
  DWORD dwIoControlCode;
  BOOL bResults;
  DWORD dwBytesReturned;
  DISK_GEOMETRY_EX diskGeometry;

  hDevice = CreateFileW(L "\\\\.\\PhysicalDrive0", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
  dwIoControlCode = 0x000700A0;
  bResults = DeviceIoControl(hDevice, dwIoControlCode, NULL, 0, &amp; diskGeometry, sizeof(diskGeometry), &amp; dwBytesReturned, NULL);

  if (hDevice == INVALID_HANDLE_VALUE) {
    printf("Handling the device drive faild");
    exit(0);
  } else if (bResults == FALSE) {
    printf("IOCTL request faild");
    CloseHandle(hDevice);
    exit(0);
  } else {

    printf("Disk size: %llu bytes\n", diskGeometry.DiskSize.QuadPart);
    CloseHandle(hDevice);

  }

  return 0;
}
</code></pre></div></div>

<p>Now, The above code is the one we will use to send the <code class="language-plaintext highlighter-rouge">IOCTL</code> Request, Let’s explain it. First, We included the needed header files that contains the needed functions &amp; methods we will use which are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">stdio.h</code>: Which is used for the standard input/output and contains functions such as <code class="language-plaintext highlighter-rouge">printf()</code></li>
  <li><code class="language-plaintext highlighter-rouge">windows.h</code>: Which provides us with the <code class="language-plaintext highlighter-rouge">Windows APIs</code> as the <code class="language-plaintext highlighter-rouge">CreateFileW()</code> we used in the code.</li>
  <li><code class="language-plaintext highlighter-rouge">winioctl.h</code>: Which contains the <code class="language-plaintext highlighter-rouge">IOCTL</code> codes and let us perform the <code class="language-plaintext highlighter-rouge">IOCTL</code> Request.</li>
</ul>

<p>After that we defined some variables in the <code class="language-plaintext highlighter-rouge">main()</code> function and each one of them has a role as the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">HANDLE hDevice</code>: We declared <strong><code class="language-plaintext highlighter-rouge">hDevice</code></strong> as a <strong><code class="language-plaintext highlighter-rouge">HANDLE</code></strong> object which used to access and manipulate system resources in our case it’s the device drive.</li>
  <li><code class="language-plaintext highlighter-rouge">DWORD dwIoControlCode</code>: Here we declared <strong><code class="language-plaintext highlighter-rouge">dwIoControlCode</code></strong> as a <strong><code class="language-plaintext highlighter-rouge">DWORD</code></strong> data type where we gonna store the <code class="language-plaintext highlighter-rouge">IOCTL</code> code.</li>
  <li><code class="language-plaintext highlighter-rouge">BOOL bResults</code>: Declared the <strong><code class="language-plaintext highlighter-rouge">bResults</code></strong> variable as a <code class="language-plaintext highlighter-rouge">Boolean</code> data type to store the result of <code class="language-plaintext highlighter-rouge">DeviceIoControl()</code> function call.</li>
  <li><code class="language-plaintext highlighter-rouge">DWORD dwBytesReturned</code>: Here we declared <strong><code class="language-plaintext highlighter-rouge">dwBytesReturned</code></strong> as a <strong><code class="language-plaintext highlighter-rouge">DWORD</code></strong> data type which we wll use to store the bytes returned by <code class="language-plaintext highlighter-rouge">DeviceIoControl()</code> function.</li>
  <li><code class="language-plaintext highlighter-rouge">DISK_GEOMETRY_EX diskGeometry</code>: declaring <strong><code class="language-plaintext highlighter-rouge">diskGeometry</code></strong> variable as a <code class="language-plaintext highlighter-rouge">DISK_GEOMETRY_EX</code> data type variable that will store the disk geometry information retrieved by the <code class="language-plaintext highlighter-rouge">DeviceIoControl()</code>.</li>
</ul>

<p>It’s the time now to assign and use these variables and initial our <strong><code class="language-plaintext highlighter-rouge">IOCTL</code></strong> request in the following lines of code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hDevice = CreateFileW(L"\\\\.\\PhysicalDrive0", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
</code></pre></div></div>

<p>Here we used the <code class="language-plaintext highlighter-rouge">CreatFileW()</code> Windows API which generally it’s used to create and open files on disk. But, it’s also can be used to open the device drive. The function takes some values as parameters:</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">L"\\\\.\\PhysicalDrive0"</code>:</strong> Here is device drive and <strong><code class="language-plaintext highlighter-rouge">PhysicalDrive0</code></strong> indicates to the first hard disk drive &amp; the <strong><code class="language-plaintext highlighter-rouge">\\\\.\\</code></strong> is used to communicating with localhost.</li>
  <li><code class="language-plaintext highlighter-rouge">GENERIC_READ | GENERIC_WRITE</code>: Specifies the access mode for the handle.</li>
  <li><code class="language-plaintext highlighter-rouge">FILE_SHARE_READ | FILE_SHARE_WRITE</code>: Specifies how the handle can be shared with other processes.</li>
  <li><code class="language-plaintext highlighter-rouge">NULL</code>: This is the security attributes. We set it to <strong>NULL</strong> for default security.</li>
  <li><code class="language-plaintext highlighter-rouge">OPEN_EXISTING</code>: Specifies that the function should open an existing file</li>
  <li><code class="language-plaintext highlighter-rouge">FILE_ATTRIBUTE_NORMAL</code>: Specifies that the file should have no other attributes set.</li>
  <li><code class="language-plaintext highlighter-rouge">NULL</code>: A template file that we don’t need.</li>
</ul>

<p>Next we assign the <code class="language-plaintext highlighter-rouge">IOCTL</code> code which is <strong><code class="language-plaintext highlighter-rouge">0x000700A0</code></strong> to the <strong><code class="language-plaintext highlighter-rouge">dwIoControlCode</code></strong> variable. The <strong><code class="language-plaintext highlighter-rouge">0x000700A0</code></strong> hex code refers to <strong><code class="language-plaintext highlighter-rouge">IOCTL_DISK_GET_DRIVE_GEOMETRY_EX</code>.</strong> After that we called the <code class="language-plaintext highlighter-rouge">DeviceIoControl()</code> and assign it to <strong><code class="language-plaintext highlighter-rouge">bResults</code></strong> variable.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bResults = DeviceIoControl(hDevice, dwIoControlCode, NULL, 0, &amp;diskGeometry, sizeof(diskGeometry), &amp;dwBytesReturned, NULL);
</code></pre></div></div>

<p>And as we can see the <code class="language-plaintext highlighter-rouge">DeviceIoControl()</code> takes some parameters and we have explained the structure of it above.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (hDevice == INVALID_HANDLE_VALUE) {
    printf("Handling the device drive faild");
    exit(0);
  } else if (bResults == FALSE) {
    printf("IOCTL request faild");
    CloseHandle(hDevice);
    exit(0);
  } else {

    printf("Disk size: %llu bytes\n", diskGeometry.DiskSize.QuadPart);
    CloseHandle(hDevice);
  }
</code></pre></div></div>

<p>Finally, Here we check for errors to handle such as <code class="language-plaintext highlighter-rouge">INVALID_HANDLE_VALUE</code> which indicates that the handling value is invalid and in the second conditionit checks if the returned boolean of <code class="language-plaintext highlighter-rouge">DeviceIoControl()</code> that stored in <strong><code class="language-plaintext highlighter-rouge">bResults</code></strong> False or no, If False that means the operation didn’t done successfully. If the both of the 2 condations aren’t true that means everything goes well and will get us the disk size using <code class="language-plaintext highlighter-rouge">diskGeometry.DiskSize.QuadPart</code> and print it. At the end will close the <code class="language-plaintext highlighter-rouge">Handle</code> we created. Now, I am using <strong><code class="language-plaintext highlighter-rouge">CodeBlocks</code></strong> to write and execute the code.</p>

<h2 id="running-the-code">Running The code</h2>

<p>First, I will put a random name to handle. Therefore, it will result in an error:</p>

<p><img src="/assets/images/285a0e0021dcfab64ff05518707ccadb.png" alt="285a0e0021dcfab64ff05518707ccadb.png" /></p>

<p>You can see that the error has been handled. This time i will run the code normally with no problems:</p>

<p><img src="/assets/images/86e7c1f0c3d477c52e600b5485098b32.png" alt="86e7c1f0c3d477c52e600b5485098b32.png" /></p>

<p>And here is the disk size with no issues. If we opened <strong><code class="language-plaintext highlighter-rouge">Procmon</code></strong> or <code class="language-plaintext highlighter-rouge">Process Monitor</code> and run our code after compiling it, We will be able to see the process very clearly.</p>

<p><img src="/assets/images/8589866d93354c65c3552496564b2955.png" alt="8589866d93354c65c3552496564b2955.png" /></p>

<p>As we can see in the screen shot clearly we can see all the operations done by the compiled code process from the start going through the calls and so on, Until the process exit.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Now, we know what is <strong>IOCTL (Input/Output CONTROL)</strong> and how it works &amp; This was just a basic introduction to the <strong>**IOCTL (Input/Output CONTROL)</strong>** and in the coming parts we will be diving deep by showing more examples &amp; <strong>Reverse Engineer</strong> a driver and Identifying the IOCTL and extracting IOCTL codes and many more.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#general" class="page__taxonomy-item" rel="tag">General</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-02-09T00:00:00+08:00">February 9, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/certificates/empat/" class="pagination--pager" title="eMAPT &amp; Mobile Apps/Sec Guide
">Previous</a>
    
    
      <a href="/certificates/ecppt/" class="pagination--pager" title="eCPPT: The Honest Review
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Zeyad Azima. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
